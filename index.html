<!DOCTYPE html>
<html lang="uk">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Конструктор вибірок | Diamond Edition</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        :root {
            /* Diamond Edition Palette */
            --primary: #4361ee;
            --primary-soft: #eef2ff;
            --secondary: #3f37c9;
            --accent: #4cc9f0;
            --surface: #ffffff;
            --bg-app: #f8f9fa;
            --text-main: #1b263b;
            --text-muted: #6c757d;
            --border: #e9ecef;

            /* Effects */
            --shadow-float: 0 10px 30px rgba(67, 97, 238, 0.15);
            --shadow-card: 0 4px 12px rgba(0, 0, 0, 0.05);
            --radius-btn: 12px;
            --radius-card: 20px;
        }

        [data-theme="dark"] {
            --primary: #5c7cfa;
            --primary-soft: #182030;
            --secondary: #748ffc;
            --surface: #1a1d2d;
            --bg-app: #0f111a;
            --text-main: #edf2f7;
            --text-muted: #a0aec0;
            --border: #2d3748;
            --shadow-float: 0 10px 30px rgba(0, 0, 0, 0.5);
            --shadow-card: 0 4px 20px rgba(0, 0, 0, 0.4);
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-app);
            color: var(--text-main);
            overflow-x: hidden;
        }

        /* Sticky Glass Header */
        .app-header {
            position: sticky;
            top: 0;
            z-index: 1000;
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid var(--border);
            padding: 0.5rem 0;
        }

        /* Navigation Tabs */
        .nav-pills .nav-link {
            color: var(--text-muted);
            border-radius: var(--radius-btn);
            padding: 0.6rem 1.2rem;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .nav-pills .nav-link.active {
            background-color: var(--primary);
            color: white;
            box-shadow: 0 4px 15px rgba(67, 97, 238, 0.4);
        }

        /* Cards & Surfaces */
        .card-diamond {
            background: var(--surface);
            border: none;
            border-radius: var(--radius-card);
            box-shadow: var(--shadow-card);
            transition: transform 0.2s;
            margin-bottom: 1.5rem;
        }

        /* Accordion Customization */
        .accordion-item {
            border: 1px solid var(--border);
            border-radius: 16px !important;
            margin-bottom: 12px;
            overflow: hidden;
            background: var(--surface);
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.02);
        }

        .accordion-button {
            background-color: var(--surface);
            color: var(--text-main);
            font-weight: 600;
            border-radius: 16px !important;
            padding: 0.75rem 1rem;
        }

        .accordion-button:not(.collapsed) {
            background-color: var(--primary-soft);
            color: var(--primary);
            box-shadow: none;
        }

        .accordion-button:focus {
            box-shadow: none;
            border-color: var(--primary-soft);
        }

        .accordion-button::after {
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16' fill='%234361ee'%3e%3cpath fill-rule='evenodd' d='M1.646 4.646a.5.5 0 0 1 .708 0L8 10.293l5.646-5.647a.5.5 0 0 1 .708.708l-6 6a.5.5 0 0 1-.708 0l-6-6a.5.5 0 0 1 0-.708z'/%3e%3c/svg%3e");
        }

        /* Sidebar */
        .sidebar-sticky {
            position: sticky;
            top: 100px;
        }

        .counter-box {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            color: white;
            padding: 2rem;
            border-radius: var(--radius-card);
            text-align: center;
            box-shadow: var(--shadow-float);
            margin-bottom: 1.5rem;
        }

        .counter-number {
            font-size: 3rem;
            font-weight: 700;
            line-height: 1;
        }

        /* Inputs & Form Elements */
        .form-control,
        .form-select {
            border-radius: var(--radius-btn);
            border: 1px solid var(--border);
            padding: 0.4rem 0.8rem;
            font-size: 0.95rem;
        }

        .form-control:focus,
        .form-select:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 4px var(--primary-soft);
        }

        label.form-label {
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--text-muted);
            margin-bottom: 0.4rem;
        }

        /* Tag Pills */
        .tags-container {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            min-height: 0;
            transition: all 0.3s;
        }

        .tag-pill {
            display: inline-flex;
            align-items: center;
            background-color: var(--primary-soft);
            color: var(--primary);
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
            animation: fadeIn 0.3s ease;
        }

        .tag-pill i {
            margin-left: 8px;
            cursor: pointer;
            opacity: 0.7;
            transition: opacity 0.2s;
        }

        .tag-pill i:hover {
            opacity: 1;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(5px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Buttons */
        .btn-primary {
            background-color: var(--primary);
            border: none;
            border-radius: var(--radius-btn);
            padding: 0.8rem 1.5rem;
            box-shadow: 0 4px 15px rgba(67, 97, 238, 0.3);
            font-weight: 600;
            transition: all 0.2s;
        }

        .btn-primary:hover {
            background-color: var(--secondary);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(67, 97, 238, 0.4);
        }

        /* Drag & Drop Zone */
        .drop-zone {
            border: 2px dashed var(--border);
            border-radius: var(--radius-card);
            padding: 2rem;
            text-align: center;
            background-color: #fafafa;
            transition: all 0.3s;
            cursor: pointer;
        }

        .drop-zone:hover {
            border-color: var(--primary);
            background-color: var(--primary-soft);
        }

        /* AI Code Block */
        .sql-preview {
            background-color: #1e1e2e;
            color: #a5b0c5;
            padding: 1.5rem;
            border-radius: 12px;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            margin-top: 1rem;
            border-left: 4px solid var(--accent);
            line-height: 1.5;
        }

        .sql-keyword {
            color: #ff79c6;
        }

        .sql-field {
            color: #8be9fd;
        }

        .sql-table {
            color: #f1fa8c;
        }

        .sql-string {
            color: #f2c67d;
        }

        /* Animation for Counter */
        .counter-animate {
            animation: pulse 0.5s ease;
        }

        @keyframes pulse {
            0% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.05);
            }

            100% {
                transform: scale(1);
            }
        }

        /* Formula View Styles */
        .formula-card {
            background: #fff;
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.03);
            position: relative;
        }

        /* Espo-style Condition Blocks (Compact) */
        .condition-block {
            background: #fff;
            border: 1px solid var(--border);
            border-radius: 8px;
            margin-bottom: 0;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.03);
            position: relative;
            transition: all 0.2s;
            cursor: grab;
            display: inline-flex;
            flex-direction: column;
            min-width: 151px;
            max-width: 300px;
        }

        .condition-block:active {
            cursor: grabbing;
        }

        .condition-block.dragging {
            opacity: 0.4;
            border: 2px dashed var(--primary);
        }

        /* Nested Blocks Styling */
        .sub-conditions-container {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            align-items: center;
            margin-left: 0.5rem;
            padding-left: 0.5rem;
            border-left: 2px solid #eee;
            margin-top: 0.2rem;
            position: relative;
        }

        .condition-header {
            padding: 4px 10px;
            background: #fcfcfc;
            border-bottom: 1px solid var(--border);
            border-radius: 8px 8px 0 0;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.8rem;
        }

        .condition-body {
            padding: 4px 10px;
            display: flex;
            flex-direction: column;
            min-height: 20px;
        }

        .condition-content-row {
            display: flex;
            align-items: center;
            gap: 10px;
            min-height: 24px;
        }

        .condition-item {
            padding-left: 10px;
            border-left: 2px solid var(--primary-soft);
            position: relative;
            flex-grow: 1;
            line-height: 1.2;
        }

        .op-tag {
            font-weight: 700;
            font-size: 0.65rem;
            padding: 1px 4px;
            border-radius: 4px;
            text-transform: uppercase;
        }

        .op-ta {
            background: #e7f1ff;
            color: #0d6efd;
        }

        .op-abo {
            background: #fff3cd;
            color: #856404;
        }

        .op-okrim {
            background: #f8d7da;
            color: #721c24;
        }

        .inter-block-op {
            display: inline-flex;
            justify-content: center;
            align-items: center;
            margin: 0;
            position: relative;
            z-index: 5;
        }

        .inter-op-select {
            background: white;
            border: 1px solid var(--border);
            border-radius: 4px;
            padding: 1px 5px;
            font-weight: 700;
            font-size: 0.65rem;
            cursor: pointer;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.06);
        }

        .section-title-espo {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            font-weight: 700;
            font-size: 0.85rem;
            margin: 1.5rem 0 1rem 0;
            cursor: pointer;
            padding: 10px 20px;
            border-radius: 10px;
            transition: all 0.2s;
            border: 1px solid var(--border);
            background: #fff;
            width: 100%;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.02);
        }

        .section-title-espo.text-primary {
            border-color: #0d6efd22;
            background: #0d6efd08;
            color: #0d6efd !important;
        }

        .section-title-espo.text-danger {
            border-color: #dc354522;
            background: #dc354508;
            color: #dc3545 !important;
        }

        .section-title-espo:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.05);
        }

        .section-title-espo.text-primary:hover {
            border-color: #0d6efd;
            background: #0d6efd;
            color: white !important;
        }

        .section-title-espo.text-danger:hover {
            border-color: #dc3545;
            background: #dc3545;
            color: white !important;
        }

        .add-sub-btn {
            cursor: pointer;
            width: 22px;
            height: 22px;
            border-radius: 4px;
            background: var(--primary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.1rem;
            color: white;
            transition: all 0.2s;
            border: none;
            box-shadow: 0 2px 5px rgba(13, 110, 253, 0.3);
        }

        .add-sub-btn:hover {
            background: #0056b3;
            transform: scale(1.15);
            box-shadow: 0 4px 10px rgba(13, 110, 253, 0.5);
        }

        #espo-include-list,
        #espo-exclude-list {
            min-height: 40px;
            border-radius: 8px;
            transition: all 0.2s;
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            align-items: center;
            padding: 8px;
        }

        #espo-include-list:empty,
        #espo-exclude-list:empty {
            border: 2px dashed #eee;
            background: #fafafa;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 1rem;
        }

        #espo-include-list:empty::after {
            content: 'Оберіть фільтри для включення';
            color: #bbb;
            font-size: 0.75rem;
            font-weight: 600;
        }

        #espo-exclude-list:empty::after {
            content: 'Оберіть фільтри для виключення';
            color: #bbb;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .sub-conditions-container:empty {
            min-height: 10px;
        }

        .sub-conditions-container.drag-over {
            background: rgba(13, 110, 253, 0.05);
            border: 1px dashed var(--primary);
            min-height: 40px;
        }

        .formula-box {
            background: #f8f9fa;
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1rem 1.25rem;
            font-size: 1.05rem;
            font-weight: 500;
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            align-items: center;
            min-height: 50px;
            margin-bottom: 0.5rem;
            line-height: 1.6;
        }

        .formula-item {
            background: white;
            border: 1px solid #dee2e6;
            padding: 2px 8px;
            border-radius: 6px;
            font-size: 0.9rem;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
            display: inline-flex;
            align-items: center;
            gap: 4px;
            transition: all 0.2s;
        }

        .formula-item.is-conflict {
            background: #fff5f5;
            border-color: #feb2b2;
            color: #c53030;
            box-shadow: 0 0 10px rgba(245, 101, 101, 0.3);
            animation: pulse-danger 2s infinite;
        }

        @keyframes pulse-danger {
            0% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.02);
            }

            100% {
                transform: scale(1);
            }
        }

        .formula-bracket {
            color: #4361ee;
            /* Changed to primary blue or another distinct color */
            font-weight: 800;
            font-size: 1.2rem;
            opacity: 0.8;
        }

        /* Sticky Formula Card & Controls Container */
        #active-filters-summary {
            position: sticky;
            top: 70px;
            z-index: 900;
            background: var(--bg-app);
            padding-top: 10px;
            margin-top: -10px;
        }

        .sticky-controls-wrapper {
            position: sticky;
            top: 132px;
            /* Adjusted to sit below the formula card */
            z-index: 890;
            background: var(--bg-app);
            padding-bottom: 15px;
            margin-bottom: 10px;
        }

        .formula-card {
            background: #fff;
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 1rem 1.25rem;
            margin-bottom: 1.5rem;
            box-shadow: var(--shadow-card);
            position: relative;
            transition: all 0.3s ease;
        }

        .formula-card.is-collapsed {
            padding-bottom: 0.5rem;
        }

        .formula-card.is-collapsed .formula-content-wrapper {
            display: none;
        }

        .formula-card .toggle-icon {
            transition: transform 0.3s ease;
            cursor: pointer;
            padding: 5px;
            border-radius: 50%;
        }

        .formula-card .toggle-icon:hover {
            background: var(--primary-soft);
        }

        .formula-card.is-collapsed .toggle-icon {
            transform: rotate(180deg);
        }

        /* Formula Truncation */
        .formula-box {
            background: #f8f9fa;
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1rem 1.25rem;
            font-size: 1.05rem;
            font-weight: 500;
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            align-items: center;
            min-height: 50px;
            margin-bottom: 0.5rem;
            line-height: 1.6;
            max-height: 62px;
            /* Approx 1 line + padding */
            overflow: hidden;
            position: relative;
            transition: max-height 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            padding-right: 50px;
            /* Space for the dots */
        }

        .formula-box.is-expanded {
            max-height: 1000px;
            padding-right: 1.25rem;
        }

        .formula-expand-btn {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            background: white;
            border: 1px solid var(--border);
            border-radius: 8px;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: var(--primary);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            transition: all 0.2s;
            z-index: 10;
        }

        .formula-box.is-expanded .formula-expand-btn {
            top: 10px;
            transform: none;
            background: var(--primary-soft);
        }

        .formula-expand-btn:hover {
            background: var(--primary);
            color: white;
        }

        .formula-operator {
            color: var(--primary);
            font-weight: 800;
            font-size: 0.85rem;
            text-transform: uppercase;
        }

        .formula-group {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 2px 6px;
            background: rgba(13, 110, 253, 0.03);
            border: 1px dashed rgba(13, 110, 253, 0.2);
            border-radius: 8px;
            margin: 0 2px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.8rem;
            margin-bottom: 2px;
        }

        .legend-badge {
            width: 20px;
            height: 20px;
            background: white;
            border: 1px solid var(--border);
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 800;
            font-size: 0.7rem;
            color: var(--primary);
        }

        /* Custom Filter Tabs */
        .custom-filter-tabs {
            background: #fff;
            padding: 8px 12px;
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            justify-content: flex-start;
            border: 1px solid var(--border) !important;
            border-radius: 18px;
            box-shadow: var(--shadow-sm);
        }

        .custom-filter-tabs .nav-item {
            flex: 0 1 auto;
        }

        .custom-filter-tabs .nav-link {
            white-space: nowrap;
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 8px 16px;
            border-radius: 12px;
            color: var(--text-muted);
            font-weight: 600;
            border: 1px solid transparent;
            transition: all 0.2s ease;
            background: transparent;
            font-size: 0.85rem;
        }

        .compact-control-card {
            background: #fff;
            border: 1px solid var(--border);
            border-radius: 18px;
            padding: 12px;
            box-shadow: var(--shadow-sm);
        }

        .custom-filter-tabs::-webkit-scrollbar {
            height: 4px;
        }

        .custom-filter-tabs::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 10px;
        }

        .custom-filter-tabs .nav-link.active {
            background: var(--primary-soft) !important;
            color: var(--primary) !important;
            border-color: var(--primary-soft) !important;
            box-shadow: 0 4px 12px rgba(67, 97, 238, 0.1) !important;
            transform: translateY(-2px);
        }

        .custom-filter-tabs .nav-link:hover:not(.active) {
            background: var(--bg-app);
            color: var(--text-main);
            border-color: var(--border);
        }

        .tab-pane-card {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: var(--radius-card);
            padding: 1.5rem;
            animation: slideUpFade 0.4s ease-out;
            box-shadow: var(--shadow-card);
        }

        @keyframes slideUpFade {
            from {
                opacity: 0;
                transform: translateY(15px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }



        #filter-picker {
            position: absolute;
            z-index: 9999;
            background: white;
            border: 1px solid var(--border);
            border-radius: 14px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
            width: 320px;
            display: none;
            overflow: hidden;
            animation: slideIn 0.2s ease-out;
        }

        .picker-header {
            padding: 12px 15px;
            border-bottom: 1px solid var(--border);
            background: var(--bg-app);
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 700;
            font-size: 0.85rem;
        }

        .picker-step {
            padding: 0;
            max-height: 350px;
            overflow-y: auto;
        }

        .picker-item {
            padding: 10px 15px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 12px;
            transition: background 0.2s;
            border-bottom: 1px solid var(--bg-app);
            font-size: 0.85rem;
            color: var(--text-main);
        }

        .picker-item:hover {
            background: var(--primary-soft);
        }

        .picker-input-step {
            padding: 15px;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>
</head>

<body>

    <header class="app-header">
        <div class="container-fluid px-4">
            <div class="d-flex justify-content-between align-items-center">
                <div class="d-flex align-items-center gap-3">
                    <div class="bg-primary text-white rounded-circle d-flex align-items-center justify-content-center"
                        style="width:40px; height:40px; box-shadow: 0 5px 15px rgba(67,97,238,0.3);">
                        <i class="bi bi-layers-fill"></i>
                    </div>
                    <h4 class="mb-0 fw-bold" style="color: var(--text-main);">Конструктор вибірок</h4>
                </div>

                <div class="header-main-row flex-grow-1">
                </div>



                <div class="d-flex align-items-center gap-3">
                    <!-- Theme Toggle -->
                    <button class="btn btn-outline-secondary border-0 p-2" onclick="toggleTheme()"
                        title="Перемикач теми">
                        <i class="bi bi-moon-stars-fill" id="theme-icon"></i>
                    </button>

                    <!-- My Segments (New Location) -->
                    <div class="dropdown">
                        <button class="btn btn-outline-primary border-0 p-2 position-relative" type="button"
                            data-bs-toggle="dropdown" data-bs-auto-close="outside" title="Мої сегменти">
                            <i class="bi bi-bookmark-star-fill fs-4"></i>
                            <span
                                class="position-absolute top-0 start-100 translate-middle p-1 bg-danger border border-light rounded-circle"
                                id="segments-badge" style="display:none">
                                <span class="visually-hidden">New alerts</span>
                            </span>
                        </button>
                        <ul class="dropdown-menu dropdown-menu-end shadow border-0 p-3"
                            style="width: 320px; max-height: 400px; overflow-y: auto;">
                            <li>
                                <h6 class="dropdown-header text-uppercase text-muted fw-bold small mb-2">Мої збережені
                                    сегменти</h6>
                            </li>
                            <div id="header-saved-segments-list" class="vstack gap-2">
                                <!-- Dynamic List -->
                                <div class="text-center text-muted small py-3">Немає збережених сегментів</div>
                            </div>
                            <li>
                                <hr class="dropdown-divider mt-3">
                            </li>
                            <li><button class="btn btn-sm btn-primary w-100 rounded-pill"
                                    onclick="saveCurrentSegment()"><i class="bi bi-plus-lg me-1"></i>Зберегти
                                    поточний</button></li>
                        </ul>
                    </div>

                    <!-- Profile -->
                    <div class="dropdown">
                        <button class="btn btn-outline-secondary border-0 p-2" type="button" data-bs-toggle="dropdown">
                            <i class="bi bi-person-circle fs-3 text-secondary"></i>
                        </button>
                        <ul class="dropdown-menu dropdown-menu-end shadow border-0">
                            <li><a class="dropdown-item" href="#">Профіль</a></li>
                            <li><a class="dropdown-item" href="#">Налаштування</a></li>
                            <li>
                                <hr class="dropdown-divider">
                            </li>
                            <li><a class="dropdown-item text-danger" href="#">Вихід</a></li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <div class="container-fluid px-4 py-4">
        <div class="row g-4">

            <!-- Main Content Area -->
            <div class="col-lg-9">

                <!-- VIEW 1: CONSTRUCTOR -->
                <div id="view-constructor" class="view-section">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h5 class="fw-bold mb-0">Фільтри сегментації</h5>
                        <button class="btn btn-sm btn-outline-danger btn-light border-0 text-danger"
                            onclick="clearFilters()">
                            <i class="bi bi-trash3 me-1"></i>Скинути все
                        </button>
                    </div>

                    <!-- Improved Active Filters Area (Legacy + Formula Support) -->
                    <div id="active-filters-summary" class="mb-4">
                        <div class="formula-card" id="main-formula-card">
                            <div class="d-flex align-items-center justify-content-between mb-2" style="cursor: pointer;"
                                onclick="toggleFormulaCard()">
                                <div class="d-flex align-items-center gap-2">
                                    <i class="bi bi-funnel text-primary fs-5"></i>
                                    <h6 class="fw-bold mb-0">ПОТОЧНА ФОРМУЛА:</h6>
                                </div>
                                <i class="bi bi-chevron-up toggle-icon" id="formula-toggle-icon"></i>
                            </div>

                            <div class="formula-content-wrapper">
                                <div class="mb-3">
                                    <div id="formula-filters-view">
                                        <div class="formula-box" id="formula-display">
                                            <span class="text-muted small">Немає фільтрів</span>
                                        </div>
                                    </div>
                                </div>

                                <!-- Espo-style Hierarchical View -->
                                <div id="standard-filters-view" class="standard-view px-2">
                                    <div id="filters-blocks-container">
                                        <div class="section-title-espo text-primary"
                                            onclick="openFilterPicker('Include', event)">
                                            <i class="bi bi-plus-circle-fill"></i> Включити
                                        </div>
                                        <div id="espo-include-list"></div>

                                        <div class="section-title-espo text-danger mt-4"
                                            onclick="openFilterPicker('Exclude', event)">
                                            <i class="bi bi-dash-circle-fill"></i> Виключити
                                        </div>
                                        <div id="espo-exclude-list"></div>

                                        <div class="text-center w-100 py-3 text-muted small" id="no-filters-msg">
                                            Натисніть <span class="text-primary fw-bold px-1">Включити</span> або <span
                                                class="text-danger fw-bold px-1">Виключити</span> щоб додати фільтр
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="sticky-controls-wrapper">
                        <div class="compact-control-card">
                            <div class="row g-2 align-items-center">
                                <!-- Left: Tabs -->
                                <div class="col-lg-8">
                                    <ul class="nav nav-pills custom-filter-tabs border-0 shadow-none p-0"
                                        id="filterTabs" role="tablist">
                                        <li class="nav-item">
                                            <button class="nav-link active" id="tab-c1" data-bs-toggle="pill"
                                                data-bs-target="#pane-c1" type="button" role="tab"><i
                                                    class="bi bi-box-seam"></i> ЕН</button>
                                        </li>
                                        <li class="nav-item">
                                            <button class="nav-link" id="tab-c2" data-bs-toggle="pill"
                                                data-bs-target="#pane-c2" type="button" role="tab"><i
                                                    class="bi bi-person-badge"></i> Клієнт</button>
                                        </li>
                                        <li class="nav-item">
                                            <button class="nav-link" id="tab-c3" data-bs-toggle="pill"
                                                data-bs-target="#pane-c3" type="button" role="tab"><i
                                                    class="bi bi-cash-coin"></i> Фінанси</button>
                                        </li>
                                        <li class="nav-item">
                                            <button class="nav-link" id="tab-c4" data-bs-toggle="pill"
                                                data-bs-target="#pane-c4" type="button" role="tab"><i
                                                    class="bi bi-person-vcard"></i> Профіль</button>
                                        </li>
                                        <li class="nav-item">
                                            <button class="nav-link" id="tab-c5" data-bs-toggle="pill"
                                                data-bs-target="#pane-c5" type="button" role="tab"><i
                                                    class="bi bi-geo-alt"></i> Локації</button>
                                        </li>
                                        <li class="nav-item">
                                            <button class="nav-link" id="tab-c6" data-bs-toggle="pill"
                                                data-bs-target="#pane-c6" type="button" role="tab"><i
                                                    class="bi bi-phone"></i> Пристрої</button>
                                        </li>
                                        <li class="nav-item">
                                            <button class="nav-link" id="tab-c7" data-bs-toggle="pill"
                                                data-bs-target="#pane-c7" type="button" role="tab"><i
                                                    class="bi bi-check-circle"></i> Згоди</button>
                                        </li>
                                    </ul>
                                </div>

                                <!-- Right: Mode Toggle -->
                                <div class="col-lg-4 ps-3 border-start">
                                    <div class="d-flex align-items-center justify-content-between">
                                        <div class="d-flex align-items-center gap-2">
                                            <div class="bg-primary-soft p-1 rounded-circle">
                                                <i class="bi bi-gear-wide-connected text-primary"
                                                    style="font-size: 0.8rem;"></i>
                                            </div>
                                            <span class="small fw-bold text-nowrap">Режим:</span>
                                        </div>
                                        <div class="btn-group btn-group-sm" role="group">
                                            <input type="radio" class="btn-check" name="global-filter-mode"
                                                id="mode-include" value="Include" checked
                                                onchange="window.currentFilterMode='Include'">
                                            <label class="btn btn-outline-primary px-3"
                                                for="mode-include">Включити</label>

                                            <input type="radio" class="btn-check" name="global-filter-mode"
                                                id="mode-exclude" value="Exclude"
                                                onchange="window.currentFilterMode='Exclude'">
                                            <label class="btn btn-outline-success px-3"
                                                for="mode-exclude">Виключити</label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="tab-content mt-3" id="filterTabsContent">
                        <!-- 1. Параметри ЕН -->
                        <div class="tab-pane fade show active" id="pane-c1" role="tabpanel">
                            <div class="tab-pane-card">
                                <div class="row g-3">
                                    <div class="col-md-3">
                                        <label class="form-label">Роль</label>
                                        <select class="form-select" onchange="addTag(this, 'Role')">
                                            <option value="">Всі</option>
                                            <option value="Sender">Sender (Відправник)</option>
                                            <option value="Recipient">Recipient (Отримувач)</option>
                                        </select>
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label">Сервіс</label>
                                        <select class="form-select" onchange="addTag(this, 'Service')">
                                            <option value="">Всі</option>
                                            <option value="WarehouseWarehouse">Warehouse-Warehouse</option>
                                            <option value="DoorsDoors">Doors-Doors</option>
                                            <option value="WarehouseDoors">Warehouse-Doors</option>
                                            <option value="DoorsWarehouse">Doors-Warehouse</option>
                                        </select>
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label">Платник</label>
                                        <select class="form-select" onchange="addTag(this, 'Payer')">
                                            <option value="">Всі</option>
                                            <option value="Sender">Sender</option>
                                            <option value="Recipient">Recipient</option>
                                            <option value="ThirdPerson">ThirdPerson</option>
                                        </select>
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label">Місце створення</label>
                                        <select class="form-select" onchange="addTag(this, 'Created')">
                                            <option value="">Всі</option>
                                            <option value="App">Додаток</option>
                                            <option value="API">Клієнтське API</option>
                                            <option value="Branch">Відділення</option>
                                        </select>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label">Дата створення</label>
                                        <div class="input-group">
                                            <input type="date" class="form-control" onchange="updateState()">
                                            <span class="input-group-text bg-light text-muted">до</span>
                                            <input type="date" class="form-control" onchange="updateState()">
                                        </div>
                                    </div>
                                </div>
                                <div class="tags-container mt-3" id="tags-c1"></div>
                            </div>
                        </div>

                        <!-- 2. Відправник та Отримувач -->
                        <div class="tab-pane fade" id="pane-c2" role="tabpanel">
                            <div class="tab-pane-card">
                                <div class="row g-3">
                                    <div class="col-md-4">
                                        <label class="form-label">Тип контрагента</label>
                                        <select class="form-select" onchange="addTag(this, 'Type')">
                                            <option value="">Всі</option>
                                            <option value="Private">Приватна особа</option>
                                            <option value="Business">Компанія (Profile B)</option>
                                        </select>
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label">ЄДРПОУ</label>
                                        <input type="text" class="form-control" placeholder="Code..."
                                            onchange="addTextTag(this, 'EDRPOU')">
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label">Тип відділення</label>
                                        <select class="form-select" onchange="addTag(this, 'WhType')">
                                            <option value="">Всі</option>
                                            <option value="Cargo">Вантажне</option>
                                            <option value="Post">Поштове</option>
                                        </select>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label">Місто</label>
                                        <select class="form-select" onchange="addTag(this, 'City')">
                                            <option value="">Оберіть місто...</option>
                                            <option value="Kyiv">Київ</option>
                                            <option value="Kharkiv">Харків</option>
                                            <option value="Lviv">Львів</option>
                                            <option value="Odesa">Одеса</option>
                                            <option value="Dnipro">Дніпро</option>
                                            <option value="Zaporizhzhia">Запоріжжя</option>
                                            <option value="Vinnytsia">Вінниця</option>
                                        </select>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label">Область</label>
                                        <select class="form-select" onchange="addTag(this, 'Area')">
                                            <option value="">Всі області</option>
                                            <option value="Kyiv">Київська</option>
                                            <option value="Lviv">Львівська</option>
                                            <option value="Odesa">Одеська</option>
                                            <option value="Dnipro">Дніпропетровська</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="tags-container mt-3" id="tags-c2"></div>
                            </div>
                        </div>

                        <!-- 3. Вантаж та Фінанси -->
                        <div class="tab-pane fade" id="pane-c3" role="tabpanel">
                            <div class="tab-pane-card">
                                <div class="row g-3">
                                    <div class="col-md-3">
                                        <label class="form-label">Тип вантажу</label>
                                        <select class="form-select" onchange="addTag(this, 'Cargo')">
                                            <option value="">Всі</option>
                                            <option value="Parcel">Parcel</option>
                                            <option value="Documents">Documents</option>
                                            <option value="Pallet">Pallet</option>
                                            <option value="Cargo">Cargo</option>
                                        </select>
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label">Оплата</label>
                                        <select class="form-select" onchange="addTag(this, 'PayMethod')">
                                            <option value="">Всі</option>
                                            <option value="Cash">Готівка</option>
                                            <option value="Terminal">Термінал</option>
                                            <option value="App">Додаток</option>
                                        </select>
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label">Маркетплейс</label>
                                        <select class="form-select" onchange="addTag(this, 'Market')">
                                            <option value="">Не обрано</option>
                                            <option value="OLX">OLX</option>
                                            <option value="Prom">Prom</option>
                                            <option value="Rozetka">Rozetka</option>
                                        </select>
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label">Претензії</label>
                                        <select class="form-select" onchange="addTag(this, 'Pretense')">
                                            <option value="">Всі</option>
                                            <option value="Yes">Так</option>
                                            <option value="No">Ні</option>
                                        </select>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label">Оголошена вартість (грн)</label>
                                        <div class="input-group">
                                            <span class="input-group-text">Від</span>
                                            <input type="number" class="form-control" onchange="updateState()">
                                            <span class="input-group-text">До</span>
                                            <input type="number" class="form-control" onchange="updateState()">
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label">Вага (кг)</label>
                                        <input type="number" class="form-control" placeholder="Наприклад: 30"
                                            onchange="updateState()">
                                    </div>
                                </div>
                                <div class="tags-container mt-3" id="tags-c3"></div>
                            </div>
                        </div>

                        <!-- 4. Профіль Клієнта (Profile C) -->
                        <div class="tab-pane fade" id="pane-c4" role="tabpanel">
                            <div class="tab-pane-card">
                                <div class="row g-3">
                                    <div class="col-md-3">
                                        <label class="form-label">Країна</label>
                                        <select class="form-select" onchange="addTag(this, 'Country')">
                                            <option value="">Всі</option>
                                            <option value="UA">UA</option>
                                            <option value="PL">PL</option>
                                            <option value="MD">MD</option>
                                        </select>
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label">Стать</label>
                                        <select class="form-select" onchange="addTag(this, 'Gender')">
                                            <option value="">Всі</option>
                                            <option value="M">Чоловіча</option>
                                            <option value="F">Жіноча</option>
                                        </select>
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label">Верифікація</label>
                                        <select class="form-select" onchange="addTag(this, 'Verified')">
                                            <option value="">Всі</option>
                                            <option value="1">Так (1)</option>
                                            <option value="0">Ні (0)</option>
                                        </select>
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label">Наявність Email</label>
                                        <select class="form-select" onchange="addTag(this, 'HasEmail')">
                                            <option value="">Не важливо</option>
                                            <option value="1">Є Email</option>
                                        </select>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label">День народження</label>
                                        <input type="date" class="form-control" onchange="updateState()">
                                    </div>
                                </div>
                                <div class="tags-container mt-3" id="tags-c4"></div>
                            </div>
                        </div>

                        <!-- 5. Активність та Локації -->
                        <div class="tab-pane fade" id="pane-c5" role="tabpanel">
                            <div class="tab-pane-card">
                                <div class="row g-3">
                                    <div class="col-md-6">
                                        <label class="form-label">Улюблена точка</label>
                                        <input type="text" class="form-control" placeholder="Назва або ID відділення..."
                                            onchange="addTextTag(this, 'FavPoint')">
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label">Місто ост. точки</label>
                                        <input type="text" class="form-control" placeholder="Львів..."
                                            onchange="addTextTag(this, 'LastCity')">
                                    </div>
                                    <div class="col-md-12">
                                        <label class="form-label">Дати активності</label>
                                        <div class="input-group">
                                            <span class="input-group-text bg-light">Перша</span>
                                            <input type="date" class="form-control" onchange="updateState()">
                                            <span class="input-group-text bg-light">Остання</span>
                                            <input type="date" class="form-control" onchange="updateState()">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 6. Додаток та Пристрої -->
                        <div class="tab-pane fade" id="pane-c6" role="tabpanel">
                            <div class="tab-pane-card">
                                <div class="row g-3">
                                    <div class="col-md-3">
                                        <label class="form-label">Користувач App</label>
                                        <select class="form-select" onchange="addTag(this, 'AppUser')">
                                            <option value="">Всі</option>
                                            <option value="1">1 (Так)</option>
                                            <option value="0">0 (Ні)</option>
                                        </select>
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label">ОС</label>
                                        <select class="form-select" onchange="addTag(this, 'OS')">
                                            <option value="">Всі</option>
                                            <option value="iOS">iOS</option>
                                            <option value="Android">Android</option>
                                        </select>
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label">Девайс</label>
                                        <input type="text" class="form-control" placeholder="iPhone 14..."
                                            onchange="addTextTag(this, 'Device')">
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label">Дата входу</label>
                                        <input type="date" class="form-control" onchange="updateState()">
                                    </div>
                                </div>
                                <div class="tags-container mt-3" id="tags-c6"></div>
                            </div>
                        </div>

                        <!-- 7. Згоди -->
                        <div class="tab-pane fade" id="pane-c7" role="tabpanel">
                            <div class="tab-pane-card">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="form-check form-switch mb-3">
                                            <input class="form-check-input" type="checkbox" id="param_61"
                                                onchange="updateState()">
                                            <label class="form-check-label" for="param_61">Згода:
                                                Промокоди</label>
                                        </div>
                                        <div class="form-check form-switch mb-3">
                                            <input class="form-check-input" type="checkbox" id="param_60"
                                                onchange="updateState()">
                                            <label class="form-check-label" for="param_60">Згода:
                                                Пропозиції</label>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-check form-switch mb-3">
                                            <input class="form-check-input" type="checkbox" id="param_59"
                                                onchange="updateState()">
                                            <label class="form-check-label" for="param_59">Згода:
                                                Опитування</label>
                                        </div>
                                        <div class="form-check form-switch mb-3">
                                            <input class="form-check-input" type="checkbox" id="param_58"
                                                onchange="updateState()">
                                            <label class="form-check-label" for="param_58">Згода: Робота
                                                відділень</label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                    </div>

                    <!-- Constructor Results (Moved to Bottom) -->
                    <div id="constructor-results" class="d-none animate-fade-in mt-4">
                        <div class="card-diamond p-3">
                            <h6 class="fw-bold mb-3 small text-uppercase">Попередній перегляд (Топ 5)</h6>
                            <div class="table-responsive rounded-3 border">
                                <table class="table table-hover table-bordered small bg-white mb-0">
                                    <thead class="table-light">
                                        <tr>
                                            <th>#</th>
                                            <th>Результат</th>
                                        </tr>
                                    </thead>
                                    <tbody id="constructor-table-body"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>



                </div>

                <!-- VIEW 2: LOOK-A-LIKE -->
                <div id="view-lookalike" class="view-section d-none">
                    <div class="card-diamond p-3">
                        <div class="row g-3 align-items-end mb-3">
                            <div class="col-md-6">
                                <label class="form-label fw-bold text-danger">Формат вибірки
                                    (Обов'язково)*</label>
                                <select id="lookalike-format" class="form-select">
                                    <option value="" selected disabled>Оберіть формат...</option>
                                    <option value="phone">Телефон</option>
                                    <option value="cid">CID</option>
                                    <option value="email">E-mail</option>
                                    <option value="audience_id">ID Аудиторії</option>
                                </select>
                            </div>
                            <div class="col-md-6 text-end">
                                <button class="btn btn-primary w-100 shadow-sm" onclick="handleGeneration('lookalike')">
                                    <i class="bi bi-play-circle me-2"></i>Сформувати запит
                                </button>
                            </div>
                        </div>



                        <h5 class="fw-bold mb-3">Пошук схожих аудиторій</h5>

                        <div class="row g-4">
                            <!-- Drag & Drop -->
                            <div class="col-md-6">
                                <label class="form-label fw-bold">Джерело даних</label>
                                <div class="drop-zone py-4 px-3" id="dropZone"
                                    style="border: 2px dashed var(--border); border-radius: var(--radius-card); background-color: #fafafa; text-align: center; cursor: pointer;">
                                    <i class="bi bi-cloud-upload fs-1 text-primary mb-2"></i>
                                    <p class="mb-1 text-dark fw-bold">Перетягніть файл сюди</p>
                                    <p class="text-muted small mb-2">.CSV або .XLSX (до 50MB)</p>
                                    <button class="btn btn-sm btn-outline-primary px-3 rounded-pill">Обрати
                                        файл</button>
                                </div>
                            </div>

                            <!-- Inputs -->
                            <div class="col-md-6">
                                <div class="mb-4">
                                    <label class="form-label fw-bold">Website</label>
                                    <div class="input-group mb-2">
                                        <input type="text" class="form-control" id="lal-website"
                                            placeholder="shop.com.ua"
                                            onkeydown="handleLookalikeInput(event, 'website')">
                                        <button class="btn btn-outline-primary"
                                            onclick="addLalTag('website')">Add</button>
                                    </div>
                                    <div id="tags-lal-website" class="tags-container"></div>
                                </div>
                                <div>
                                    <label class="form-label fw-bold">ЄДРПОУ</label>
                                    <div class="input-group mb-2">
                                        <input type="text" class="form-control" id="lal-edrpou" placeholder="Code..."
                                            onkeydown="handleLookalikeInput(event, 'edrpou')">
                                        <button class="btn btn-outline-primary"
                                            onclick="addLalTag('edrpou')">Add</button>
                                    </div>
                                    <div id="tags-lal-edrpou" class="tags-container"></div>
                                </div>
                            </div>
                        </div>

                        <hr class="my-5 opacity-10">

                        <div class="row align-items-end g-3">
                            <div class="col-md-4">
                                <label class="form-label text-muted small d-block">Глибина аналізу</label>
                                <div class="input-group">
                                    <input type="number" class="form-control" id="lal-days" value="30" min="1" max="365"
                                        placeholder="30" onchange="updateState()">
                                    <span class="input-group-text">днів</span>
                                </div>
                                <div class="form-text small text-muted" style="font-size: 0.75rem;">Вкажіть
                                    період до
                                    365 днів</div>
                            </div>
                            <div class="col-md-4">
                                <div class="d-flex flex-column">
                                    <label class="form-label text-muted small">Мін. кількість посилок</label>
                                    <div class="input-group" style="max-width: 150px;">
                                        <button class="btn btn-outline-secondary" type="button"
                                            onclick="this.nextElementSibling.stepDown(); updateState()">-</button>
                                        <input type="number" class="form-control text-center" value="5" min="1"
                                            readonly>
                                        <button class="btn btn-outline-secondary" type="button"
                                            onclick="this.previousElementSibling.stepUp(); updateState()">+</button>
                                    </div>
                                    <div class="form-text small text-muted opacity-0" style="font-size: 0.75rem;">Spacer
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-check form-switch mb-4 d-flex align-items-center">
                                    <input class="form-check-input ms-0 me-3" type="checkbox" id="excludeClients"
                                        style="transform: scale(1.4);" checked onchange="updateState()">
                                    <label class="form-check-label text-secondary" for="excludeClients"
                                        style="font-size: 1.1rem;">Виключити клієнтів
                                        замовника</label>
                                </div>
                            </div>
                        </div>

                    </div>

                    <!-- Look-alike Results (Moved to Bottom) -->
                    <div id="lookalike-results" class="d-none animate-fade-in mt-3">
                        <div class="card-diamond p-3">
                            <h6 class="fw-bold mb-2 small">Попередній перегляд (Топ 5)</h6>
                            <div class="table-responsive rounded-3 border">
                                <table class="table table-hover table-bordered small bg-white mb-0">
                                    <thead class="table-light">
                                        <tr>
                                            <th>#</th>
                                            <th>Результат</th>
                                        </tr>
                                    </thead>
                                    <tbody id="lookalike-table-body"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                </div>

                <!-- VIEW 3: AI ASSISTANT -->
                <div id="view-ai" class="view-section d-none">
                    <div class="card-diamond p-3">
                        <div class="d-flex align-items-center mb-4">
                            <div class="bg-primary text-white rounded-circle d-flex align-items-center justify-content-center me-3"
                                style="width:56px; height:56px; box-shadow: 0 5px 15px rgba(67,97,238,0.3);">
                                <i class="bi bi-magic fs-4"></i>
                            </div>
                            <div>
                                <h4 class="fw-bold mb-1">AI Помічник (Text-to-SQL)</h4>
                                <span class="text-muted">Опишіть аудиторію природною мовою, і AI згенерує
                                    SQL-запит
                                    до
                                    бази даних.</span>
                            </div>
                        </div>

                        <div class="row g-3 align-items-end mb-4">
                            <div class="col-md-6">
                                <label class="form-label fw-bold text-danger">Формат вибірки
                                    (Обов'язково)*</label>
                                <select id="ai-format" class="form-select">
                                    <option value="" selected disabled>Оберіть формат...</option>
                                    <option value="phone">Телефон</option>
                                    <option value="cid">CID</option>
                                    <option value="email">E-mail</option>
                                    <option value="audience_id">ID Аудиторії</option>
                                </select>
                            </div>
                            <div class="col-md-6 text-end">
                                <button class="btn btn-primary w-100 shadow-sm" onclick="handleAiRequest()">
                                    <i class="bi bi-stars me-2"></i>Сформувати запит
                                </button>
                            </div>
                        </div>

                        <div class="mb-4">
                            <div class="d-flex gap-2 mb-3 overflow-auto pb-2">
                                <button class="btn btn-sm btn-light border rounded-pill px-3"
                                    onclick="fillAiPrompt('Телефони отримувачів з Києва з чеком > 2000')">💰
                                    Високий
                                    чек
                                    Київ</button>
                                <button class="btn btn-sm btn-light border rounded-pill px-3"
                                    onclick="fillAiPrompt('Жінки 25-35 років, iPhone, є email')">📱 iPhone
                                    Користувачі</button>
                                <button class="btn btn-sm btn-light border rounded-pill px-3"
                                    onclick="fillAiPrompt('Відправники з Одеси, вантаж > 30кг')">🚛 Вантажні
                                    Одеса</button>
                            </div>
                            <textarea id="ai-prompt" class="form-control form-control-lg" rows="4"
                                placeholder="Наприклад: Знайди всіх клієнтів, які отримали посилку у відділенні 'Cargo' за останній місяць..."></textarea>
                        </div>



                        <div id="ai-results" class="d-none animate-fade-in">
                            <h6 class="fw-bold mt-5 mb-3"><i class="bi bi-code-square me-2 text-primary"></i>SQL
                                Preview
                            </h6>
                            <div class="sql-preview position-relative" id="sql-code">
                                <!-- Generated SQL goes here -->
                            </div>

                            <!-- Result: Table -->
                            <div id="ai-table-container" class="mt-5">
                                <h6 class="fw-bold mb-3">Попередній перегляд (Топ 5)</h6>
                                <div class="table-responsive rounded-3 border">
                                    <table class="table table-hover table-bordered small bg-white mb-0">
                                        <thead class="table-light">
                                            <tr>
                                                <th>#</th>
                                                <th>Результат</th>
                                            </tr>
                                        </thead>
                                        <tbody id="ai-table-body">
                                            <!-- Dynamic Rows -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Sidebar -->
            <div class="col-lg-3">
                <div class="sidebar-sticky" style="top: 90px;">
                    <!-- 1. Counter (Always Top) -->
                    <div class="counter-box mx-0">
                        <small class="text-white-50 text-uppercase letter-spacing-1">Знайдено записів</small>
                        <div class="counter-number my-2" id="counter-display">24.5M</div>
                        <div class="progress mb-2" style="height: 4px; background: rgba(255,255,255,0.3);">
                            <div class="progress-bar bg-white" style="width: 75%"></div>
                        </div>

                        <!-- Analytics Trigger Button (Integrated) -->
                        <button class="btn btn-sm btn-white-soft w-100 rounded-pill mt-2 text-white border-white-50"
                            style="background: rgba(255,255,255,0.1); backdrop-filter: blur(5px);"
                            data-bs-toggle="modal" data-bs-target="#analyticsModal"
                            onclick="setTimeout(updateAnalytics, 200)">
                            <i class="bi bi-graph-up me-2"></i>Відкрити аналітику
                        </button>
                    </div>

                    <!-- 2. Actions (Moved Up) -->
                    <div class="card-diamond p-3 mb-3">
                        <label class="form-label text-muted small fw-bold text-uppercase">Дія з вибіркою</label>
                        <select class="form-select mb-2">
                            <option value="cdp">Зберегти в CDP</option>
                            <option value="csv">Завантажити .CSV</option>
                            <option value="api">Відправити по API</option>
                        </select>
                        <div class="input-group mb-3">
                            <span class="input-group-text bg-white text-muted small">К-сть</span>
                            <input type="number" class="form-control" value="1000" min="1" placeholder="Всі">
                        </div>
                        <button class="btn btn-primary w-100 py-2 fw-semibold" onclick="handleExportAction()">
                            <i class="bi bi-cloud-download me-2"></i>Сформувати
                        </button>
                    </div>

                    <!-- 3. Shortcuts / Presets (Moved Up) -->
                    <div class="card-diamond p-3">
                        <h6 class="fw-bold mb-3 small text-uppercase text-muted">Швидкі шаблони</h6>
                        <div class="d-grid gap-2">
                            <button
                                class="btn btn-light text-start d-flex align-items-center p-2 border-0 shadow-sm rounded-3"
                                onclick="applyPersona('vip')">
                                <span class="badge bg-warning text-dark me-2 rounded-circle p-2"><i
                                        class="bi bi-star-fill"></i></span>
                                <div style="line-height:1.1">
                                    <span class="d-block fw-bold small">Клієнти VIP</span>
                                    <span class="text-muted" style="font-size: 0.7rem;">Чек > 5000,
                                        iPhone</span>
                                </div>
                            </button>
                            <button
                                class="btn btn-light text-start d-flex align-items-center p-2 border-0 shadow-sm rounded-3"
                                onclick="applyPersona('churn')">
                                <span class="badge bg-danger me-2 rounded-circle p-2"><i
                                        class="bi bi-exclamation-triangle-fill"></i></span>
                                <div style="line-height:1.1">
                                    <span class="d-block fw-bold small">Ризик відтоку</span>
                                    <span class="text-muted" style="font-size: 0.7rem;">60 днів без
                                        активності</span>
                                </div>
                            </button>
                        </div>
                    </div>

                    <!-- 4. Format Selection (Moved from Main) -->
                    <div class="card-diamond p-3 border shadow-sm">
                        <div class="d-flex align-items-center gap-2 mb-3">
                            <div class="bg-primary-soft p-2 rounded-circle">
                                <i class="bi bi-file-earmark-text text-primary"></i>
                            </div>
                            <h6 class="fw-bold mb-0 small text-uppercase">Формат звіту</h6>
                        </div>
                        <div class="mb-3">
                            <label class="form-label small text-muted mb-1">Оберіть формат вибірки:</label>
                            <select id="constructor-format-side" class="form-select form-select-sm"
                                onchange="document.getElementById('constructor-format').value = this.value">
                                <option value="" selected disabled>Оберіть формат...</option>
                                <option value="phone">Телефон</option>
                                <option value="cid">CID</option>
                                <option value="email">E-mail</option>
                                <option value="audience_id">ID Аудиторії</option>
                            </select>
                        </div>
                        <button class="btn btn-primary w-100 shadow-sm py-2" onclick="syncAndGenerate()">
                            <i class="bi bi-play-circle me-2"></i>Сформувати запит
                        </button>
                        <!-- Hidden legacy input to keep JS working -->
                        <select id="constructor-format" class="d-none">
                            <option value="phone">phone</option>
                            <option value="cid">cid</option>
                            <option value="email">email</option>
                            <option value="audience_id">audience_id</option>
                        </select>

                        <script>
                            function syncAndGenerate() {
                                const sideVal = document.getElementById('constructor-format-side').value;
                                if (!sideVal) { alert('Будь ласка, оберіть формат'); return; }
                                document.getElementById('constructor-format').value = sideVal;
                                handleGeneration('constructor');
                            }
                        </script>
                    </div>

                </div>
            </div>

        </div>
    </div>

    <!-- Analytics Modal -->
    <div class="modal fade" id="analyticsModal" tabindex="-1">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content card-diamond border-0">
                <div class="modal-header border-0">
                    <h5 class="modal-title fw-bold"><i class="bi bi-graph-up text-primary me-2"></i>Інсайт
                        Аудиторії
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-4">
                    <div class="row g-4">
                        <div class="col-md-4">
                            <div class="p-3 border rounded bg-light h-100 text-center">
                                <h6 class="text-muted small text-uppercase mb-3">Стать</h6>
                                <div style="height: 200px; position: relative;">
                                    <canvas id="chart-gender"></canvas>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="p-3 border rounded bg-light h-100 text-center">
                                <h6 class="text-muted small text-uppercase mb-3">Пристрої</h6>
                                <div style="height: 200px; position: relative;">
                                    <canvas id="chart-device"></canvas>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="p-3 border rounded bg-light h-100 text-center">
                                <h6 class="text-muted small text-uppercase mb-3">Географія (Топ 5)</h6>
                                <div style="height: 200px; position: relative;">
                                    <canvas id="chart-cities"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div
                        class="alert alert-info d-flex align-items-center mt-4 mb-0 border-0 bg-primary-soft text-primary">
                        <i class="bi bi-info-circle-fill fs-4 me-3"></i>
                        <div>
                            <strong>AI Прогноз:</strong> Ця аудиторія має високу спорідненість (High Affinity)
                            до
                            категорії "Електроніка". Рекомендований час комунікації: 18:00 - 20:00.
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Save Segment Modal -->
    <div class="modal fade" id="saveSegmentModal" tabindex="-1" aria-labelledby="saveSegmentModalLabel"
        aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="saveSegmentModalLabel">Зберегти сегмент</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="segmentNameInput" class="form-label">Назва сегмента</label>
                        <input type="text" class="form-control" id="segmentNameInput"
                            placeholder="Наприклад: Мої VIP клієнти">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Скасувати</button>
                    <button type="button" class="btn btn-primary" onclick="confirmSaveSegment()">Зберегти</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>


        // --- DATA & STATE ---
        let currentCount = 24500000;
        let pickerState = {
            step: 0,
            field: null,
            linkOp: 'ТА',
            fieldOp: null,
            zone: 'Include'
        };

        const filterRegistry = [
            { id: 'Status', label: 'Статус', type: 'select', options: { 'Active': 'Активний', 'Draft': 'Чернетка', 'Closed': 'Закритий' }, category: 'Основне', icon: 'bi-info-circle' },
            { id: 'Created', label: 'Дата створення', type: 'date', category: 'Часові рамки', icon: 'bi-calendar-plus' },
            { id: 'Modified', label: 'Дата зміни', type: 'date', category: 'Часові рамки', icon: 'bi-calendar-event' },
            { id: 'SubscriptionDate', label: 'Дата підписки', type: 'date', category: 'Часові рамки', icon: 'bi-calendar-check' },
            { id: 'Role', label: 'Роль', type: 'select', options: { 'Sender': 'Відправник', 'Recipient': 'Отримувач' }, category: 'Параметри ЕН', icon: 'bi-person' },
            { id: 'Service', label: 'Сервіс', type: 'select', options: { 'WarehouseWarehouse': 'W-W', 'DoorsDoors': 'D-D', 'WarehouseDoors': 'W-D', 'DoorsWarehouse': 'D-W' }, category: 'Параметри ЕН', icon: 'bi-truck' },
            { id: 'Payer', label: 'Платник', type: 'select', options: { 'Sender': 'Відправник', 'Recipient': 'Отримувач', 'ThirdPerson': 'Третя особа' }, category: 'Параметри ЕН', icon: 'bi-cash' },
            { id: 'City', label: 'Місто', type: 'select', options: { 'Kyiv': 'Київ', 'Kharkiv': 'Харків', 'Lviv': 'Львів', 'Odesa': 'Одеса', 'Dnipro': 'Дніпро' }, category: 'Географія', icon: 'bi-geo-alt' },
            { id: 'EDRPOU', label: 'ЄДРПОУ', type: 'text', category: 'Контрагент', icon: 'bi-building' },
            { id: 'Cargo', label: 'Вантаж', type: 'select', options: { 'Parcel': 'Посилка', 'Documents': 'Документи', 'Pallet': 'Палета' }, category: 'Вантаж', icon: 'bi-box' },
            { id: 'PayMethod', label: 'Метод оплати', type: 'select', options: { 'Cash': 'Готівка', 'Terminal': 'Термінал', 'App': 'Додаток' }, category: 'Фінанси', icon: 'bi-credit-card' },
            { id: 'OS', label: 'ОС', type: 'select', options: { 'iOS': 'iOS', 'Android': 'Android' }, category: 'Пристрої', icon: 'bi-phone-flip' },
            { id: 'Country', label: 'Країна', type: 'select', options: { 'UA': 'Україна', 'PL': 'Польща', 'MD': 'Молдова' }, category: 'Профіль', icon: 'bi-flag' },
            { id: 'Gender', label: 'Стать', type: 'select', options: { 'M': 'Чоловіча', 'F': 'Жіноча' }, category: 'Профіль', icon: 'bi-gender-ambiguous' }
        ];

        function openFilterPicker(zone, event, parentId = null) {
            // Normalize parentId to null if undefined
            parentId = parentId === undefined ? null : parentId;

            pickerState = {
                step: 0,
                field: null,
                linkOp: (zone === 'Exclude' ? 'ОКРІМ' : 'ТА'),
                fieldOp: null,
                zone: zone,
                parentId: parentId
            };
            renderPicker();

            const picker = document.getElementById('filter-picker');
            if (!picker) return;

            // Use event.currentTarget if available (inline onclick), or event.target as fallback
            let target = (event && event.currentTarget) ? event.currentTarget : (event ? event.target : null);
            if (!target || (target.tagName === 'I' && target.parentElement.onclick)) {
                // If clicked on icon inside a button with onclick
                target = target.parentElement;
            }
            if (!target) return;

            const rect = target.getBoundingClientRect();
            picker.style.top = (rect.bottom + window.scrollY + 5) + 'px';
            picker.style.left = Math.min(rect.left, window.innerWidth - 340) + 'px';
            picker.style.display = 'block';

            const closer = (e) => {
                if (!picker.contains(e.target) && !target.contains(e.target)) {
                    picker.style.display = 'none';
                    document.removeEventListener('click', closer);
                }
            };
            setTimeout(() => document.addEventListener('click', closer), 10);
        }

        function renderPicker() {
            const picker = document.getElementById('filter-picker');
            picker.innerHTML = '';

            if (pickerState.step === 0) {
                // Step 0: Fields
                picker.innerHTML = '<div class="picker-header">Виберіть параметр:</div>';
                const step = document.createElement('div');
                step.className = 'picker-step';

                // Grouping by category
                const categories = [...new Set(filterRegistry.map(f => f.category))];
                categories.forEach(cat => {
                    const groupTitle = document.createElement('div');
                    groupTitle.className = 'px-3 py-2 bg-light small fw-bold text-muted text-uppercase';
                    groupTitle.innerText = cat;
                    step.appendChild(groupTitle);

                    filterRegistry.filter(f => f.category === cat).forEach(f => {
                        const item = document.createElement('div');
                        item.className = 'picker-item';
                        item.innerHTML = `<i class="bi ${f.icon} text-primary"></i><span>${f.label}</span>`;
                        item.onclick = (e) => {
                            e.stopPropagation();
                            pickerState.field = f;
                            const siblingCount = espoConditionRegistry.filter(i => i.zone === pickerState.zone && i.parentId === pickerState.parentId).length;

                            pickerState.fieldOp = null;

                            pickerState.fieldOp = null;

                            // Important fix: 
                            // 1. If it's the VERY FIRST top-level filter -> skip link selection
                            // 2. For ALL other cases (including nested and 2nd+ top-level) -> show link selection
                            const isFirstTopLevel = (siblingCount === 0 && !pickerState.parentId);

                            if (isFirstTopLevel) {
                                pickerState.linkOp = (pickerState.zone === 'Exclude' ? 'ОКРІМ' : 'ТА');
                                pickerState.step = (f.type === 'date') ? 4 : 2;
                            } else {
                                // This will now correctly trigger for 'Дата створення' if it's not the first one
                                pickerState.step = 1;
                            }
                            renderPicker();
                        };
                        step.appendChild(item);
                    });
                });
                picker.appendChild(step);
            } else if (pickerState.step === 1) {
                // Step 1: Link Operator (TA/ABO)
                picker.innerHTML = `<div class="picker-header"><i class="bi bi-chevron-left me-2" style="cursor:pointer" onclick="pickerState.step=0; renderPicker()"></i> Зв'язок:</div>`;
                const step = document.createElement('div');
                step.className = 'picker-step';

                ['ТА', 'АБО'].forEach(op => {
                    const item = document.createElement('div');
                    item.className = 'picker-item';
                    item.innerHTML = `<span class="fw-bold">${op}</span>`;
                    item.onclick = (e) => {
                        e.stopPropagation();
                        pickerState.linkOp = op;
                        pickerState.step = (pickerState.field.type === 'date') ? 4 : 2;
                        renderPicker();
                    };
                    step.appendChild(item);
                });
                picker.appendChild(step);
            } else if (pickerState.step === 4) {
                // Step 4: Field Operator (Date conditions)
                picker.innerHTML = `<div class="picker-header"><i class="bi bi-chevron-left me-2" style="cursor:pointer" onclick="pickerState.step=1; renderPicker()"></i> Умова дати:</div>`;
                const step = document.createElement('div');
                step.className = 'picker-step';

                const ops = ['сьогодні', 'вчора', 'цього тижня', 'цього місяця', 'після', 'до', 'в діапазоні'];
                ops.forEach(op => {
                    const item = document.createElement('div');
                    item.className = 'picker-item';
                    item.innerHTML = `<span class="fw-bold">${op}</span>`;
                    item.onclick = (e) => {
                        e.stopPropagation();
                        pickerState.fieldOp = op;
                        pickerState.step = 2;
                        renderPicker();
                    };
                    step.appendChild(item);
                });
                picker.appendChild(step);
            } else if (pickerState.step === 2) {
                // Step 2: Value
                const prevStep = (pickerState.field.type === 'date') ? 4 : ((['ТА', 'АБО'].includes(pickerState.linkOp) && espoConditionRegistry.some(i => i.zone === pickerState.zone && i.parentId === pickerState.parentId)) ? 1 : 0);

                picker.innerHTML = `<div class="picker-header"><i class="bi bi-chevron-left me-2" style="cursor:pointer" onclick="pickerState.step=${prevStep}; renderPicker()"></i> Значення:</div>`;
                const step = document.createElement('div');
                step.className = 'picker-input-step';

                if (pickerState.field.type === 'select') {
                    let optionsHtml = '';
                    Object.entries(pickerState.field.options).forEach(([val, label]) => {
                        optionsHtml += `<option value="${val}">${label}</option>`;
                    });
                    step.innerHTML = `
                        <select class="form-select mb-3" id="picker-val-select">${optionsHtml}</select>
                        <button class="btn btn-primary w-100" onclick="completePickerSelection()">Додати</button>
                    `;
                } else if (pickerState.field.type === 'date') {
                    if (['сьогодні', 'вчора', 'цього тижня', 'цього місяця'].includes(pickerState.fieldOp)) {
                        step.innerHTML = `
                            <div class="small mb-3 text-muted text-center">Умова: ${pickerState.field.label} ${pickerState.fieldOp}</div>
                            <button class="btn btn-primary w-100" onclick="completePickerSelection()">Додати умову</button>
                        `;
                    } else if (pickerState.fieldOp === 'в діапазоні') {
                        step.innerHTML = `
                            <input type="date" class="form-control mb-2" id="picker-val-date1">
                            <input type="date" class="form-control mb-3" id="picker-val-date2">
                            <button class="btn btn-primary w-100" onclick="completePickerSelection()">Додати</button>
                        `;
                    } else {
                        step.innerHTML = `
                            <input type="date" class="form-control mb-3" id="picker-val-date">
                            <button class="btn btn-primary w-100" onclick="completePickerSelection()">Додати</button>
                        `;
                    }
                } else {
                    step.innerHTML = `
                        <input type="text" class="form-control mb-3" id="picker-val-input" placeholder="Введіть значення...">
                        <button class="btn btn-primary w-100" onclick="completePickerSelection()">Додати</button>
                    `;
                }
                picker.appendChild(step);
            }
        }

        function completePickerSelection() {
            const field = pickerState.field;
            if (!field) return;

            let valLabel = "";
            if (field.type === 'select') {
                const el = document.getElementById('picker-val-select');
                valLabel = el ? el.options[el.selectedIndex].text : "...";
            } else if (field.type === 'date') {
                if (pickerState.fieldOp === 'в діапазоні') {
                    const d1 = document.getElementById('picker-val-date1')?.value;
                    const d2 = document.getElementById('picker-val-date2')?.value;
                    valLabel = (d1 && d2) ? `${d1} - ${d2}` : "...";
                } else if (!['сьогодні', 'вчора', 'цього тижня', 'цього місяця'].includes(pickerState.fieldOp)) {
                    valLabel = document.getElementById('picker-val-date')?.value || "...";
                } else {
                    valLabel = ""; // Operator name is enough
                }
            } else {
                const el = document.getElementById('picker-val-input');
                valLabel = el ? el.value.trim() : "...";
            }

            addEspoBlock(field.id, field.label, valLabel, pickerState.zone, pickerState.linkOp, pickerState.parentId, pickerState.fieldOp);

            const picker = document.getElementById('filter-picker');
            if (picker) picker.style.display = 'none';
        }

        // --- CONFLICT DETECTION LOGIC ---
        function getBranchSignature(itemId) {
            const item = espoConditionRegistry.find(i => i.id === itemId);
            if (!item) return "";
            let sig = `${item.label}:${item.value}`;
            const children = espoConditionRegistry.filter(c => c.parentId === itemId);
            if (children.length > 0) {
                const childSigs = children.map(c => getBranchSignature(c.id)).sort();
                sig += `[${childSigs.join('|')}]`;
            }
            return sig;
        }

        let espoConditionRegistry = [];

        function addEspoBlock(id, label, value, zone, op, parentId = null, fieldOp = null) {
            // Normalize parentId
            parentId = parentId === undefined ? null : parentId;

            // Advanced conflict check: compare branch signatures
            // We temporarily add the item to generate its signature
            const tempId = Date.now();
            const tempItem = { label, value, zone, parentId: parentId, id: tempId };
            espoConditionRegistry.push(tempItem);
            const newSig = getBranchSignature(tempId);
            espoConditionRegistry.pop(); // Remove it back

            const oppositeZone = zone === 'Include' ? 'Exclude' : 'Include';
            const contradiction = espoConditionRegistry.find(i =>
                i.zone === oppositeZone && getBranchSignature(i.id) === newSig
            );

            if (contradiction) {
                alert(`⚠️ Увага! Це умова суперечить вже існуючій в секції ${oppositeZone === 'Include' ? '"Включити"' : '"Виключити"'}.\nВи намагаєтесь одночасно і включити, і виключити один і той самий параметр.`);
            }

            const noMsg = document.getElementById('no-filters-msg');
            if (noMsg) noMsg.style.display = 'none';

            const item = {
                id: Date.now() + Math.floor(Math.random() * 1000),
                label: label,
                value: value,
                zone: zone,
                op: op || (zone === 'Exclude' ? 'ОКРІМ' : 'ТА'),
                fieldOp: fieldOp,
                interOp: 'ТА',
                bracketOpen: false,
                bracketClose: false,
                parentId: parentId
            };
            espoConditionRegistry.push(item);

            // SYNC: Update previous sibling's interOp to match this new item's op
            const siblings = espoConditionRegistry.filter(s => s.parentId === parentId && s.zone === zone);

            if (siblings.length > 1) {
                const prevSibling = siblings[siblings.length - 2];
                prevSibling.interOp = item.op;
            } else if (siblings.length === 1 && parentId !== null) {
                // If it's the first child, update the parent's connection op
                const parent = espoConditionRegistry.find(p => p.id === parentId);
                if (parent) parent.interOp = item.op;
            }

            renderEspoUI();
            updateState();
        }

        function removeEspoBlock(id) {
            const toRemove = [id];
            const collectChildren = (pid) => {
                espoConditionRegistry.forEach(item => {
                    if (item.parentId === pid) {
                        toRemove.push(item.id);
                        collectChildren(item.id);
                    }
                });
            };
            collectChildren(id);

            espoConditionRegistry = espoConditionRegistry.filter(i => !toRemove.includes(i.id));
            renderEspoUI();
            updateState();
        }

        function updateInterOp(id, newOp) {
            const item = espoConditionRegistry.find(i => i.id === id);
            if (item) {
                item.interOp = newOp;
                // Sync next sibling op
                const siblings = espoConditionRegistry.filter(s => s.parentId === item.parentId && s.zone === item.zone);
                const idx = siblings.findIndex(s => s.id === id);
                if (idx !== -1 && idx < siblings.length - 1) {
                    siblings[idx + 1].op = newOp;
                }
                renderEspoUI();
                updateState();
            }
        }

        function renderEspoUI() {
            ['Include', 'Exclude'].forEach(zone => {
                const containerId = zone === 'Include' ? 'espo-include-list' : 'espo-exclude-list';
                const container = document.getElementById(containerId);
                if (container) {
                    container.innerHTML = '';
                    setupEspoDropZone(container, zone);
                    renderConditionLevel(null, zone, container);
                }
            });

            const msg = document.getElementById('no-filters-msg');
            if (espoConditionRegistry.length > 0) msg.style.display = 'none';
            else msg.style.display = 'block';

            updateFormulaView();
        }

        function renderConditionLevel(parentId, zone, container) {
            const levelItems = espoConditionRegistry.filter(i => i.parentId === parentId && i.zone === zone);

            levelItems.forEach((item, index) => {
                const isEx = item.zone === 'Exclude';
                const opClass = isEx ? 'op-okrim' : (item.op === 'ТА' ? 'op-ta' : 'op-abo');

                // Show operator if it's not the first item, OR if it's a nested filter
                const displayOp = (index === 0 && !item.parentId) ? '' : item.op;
                const block = document.createElement('div');
                block.className = 'condition-block animate-fade-in';
                block.dataset.id = item.id;
                block.draggable = true;

                block.innerHTML = `
                    <div class="condition-header">
                        ${displayOp ? `<span class="op-tag ${opClass}">${isEx ? 'ОКРІМ' : displayOp}</span>` : ''}
                        <span class="fw-bold ms-1 text-truncate" style="color: #444; font-size: 0.75rem; max-width: 120px;" title="${item.label}">${item.label}</span>
                        <div class="add-sub-btn ms-1" style="width:18px; height:18px;" title="Додати вкладену умову" onclick="openFilterPicker('${zone}', event, ${item.id})">
                            <i class="bi bi-plus"></i>
                        </div>
                        <div class="ms-auto">
                            <i class="bi bi-trash3 text-muted" style="cursor:pointer; font-size: 0.75rem;" onclick="removeEspoBlock(${item.id})"></i>
                        </div>
                    </div>
                    <div class="condition-body">
                        <div class="condition-content-row">
                            <div class="condition-item" style="border-left-color: ${isEx ? '#dc3545' : 'var(--primary-soft)'}">
                                <div class="fs-6" style="font-size: 0.8rem !important;">
                                    ${item.fieldOp ? `<span class="text-muted fw-normal me-1">${item.fieldOp}:</span>` : ''}
                                    <b>${item.value || ''}</b>
                                </div>
                            </div>
                        </div>
                        <div class="sub-conditions-container" id="sub-container-${item.id}" style="display: none;"></div>
                    </div>
                `;

                block.addEventListener('dragstart', (e) => {
                    e.dataTransfer.setData('text/plain', item.id);
                    block.classList.add('dragging');
                    e.stopPropagation();
                });
                block.addEventListener('dragend', () => {
                    block.classList.remove('dragging');
                    syncRegistryFromDOM();
                });

                container.appendChild(block);

                // Render children
                const childContainer = block.querySelector(`#sub-container-${item.id}`);
                setupEspoDropZone(childContainer, zone); // Setup as drop target

                const children = espoConditionRegistry.filter(i => i.parentId === item.id);
                if (children.length > 0) {
                    childContainer.style.display = 'block';
                    renderConditionLevel(item.id, zone, childContainer);
                }

                // Add inter-op if not last in level
                if (index < levelItems.length - 1) {
                    const midOp = document.createElement('div');
                    midOp.className = 'inter-block-op';
                    midOp.innerHTML = `
                        <select class="inter-op-select shadow-sm" onchange="updateInterOp(${item.id}, this.value)">
                            <option value="ТА" ${item.interOp === 'ТА' ? 'selected' : ''}>ТА</option>
                            <option value="АБО" ${item.interOp === 'АБО' ? 'selected' : ''}>АБО</option>
                        </select>
                    `;
                    container.appendChild(midOp);
                }
            });
        }

        function syncRegistryFromDOM() {
            const newRegistry = [];
            const scan = (container, zone, parentId) => {
                const blocks = container.querySelectorAll(':scope > .condition-block');
                blocks.forEach(block => {
                    const id = parseInt(block.dataset.id);
                    const originalItem = espoConditionRegistry.find(i => i.id === id);
                    if (originalItem) {
                        originalItem.zone = zone;
                        originalItem.parentId = parentId;
                        newRegistry.push(originalItem);
                        const subContainer = block.querySelector('.sub-conditions-container');
                        if (subContainer) scan(subContainer, zone, id);
                    }
                });
            };
            scan(document.getElementById('espo-include-list'), 'Include', null);
            scan(document.getElementById('espo-exclude-list'), 'Exclude', null);
            espoConditionRegistry = newRegistry;
            renderEspoUI();
            updateState();
        }

        function setupEspoDropZone(container, zone) {
            container.addEventListener('dragover', (e) => {
                e.preventDefault();
                e.stopPropagation();
                container.classList.add('drag-over');
                const dragging = document.querySelector('.dragging');
                if (!dragging) return;

                // Prevent dropping a parent into its own child
                if (dragging.contains(container)) return;

                const afterElement = getDragAfterElement(container, e.clientY);
                if (afterElement == null) container.appendChild(dragging);
                else container.insertBefore(dragging, afterElement);
            });

            container.addEventListener('dragleave', () => {
                container.classList.remove('drag-over');
            });

            container.addEventListener('drop', (e) => {
                e.preventDefault();
                e.stopPropagation();
                container.classList.remove('drag-over');
                syncRegistryFromDOM();
            });
        }

        function getDragAfterElement(container, y) {
            const draggables = [...container.querySelectorAll('.condition-block:not(.dragging)')];
            return draggables.reduce((closest, child) => {
                const box = child.getBoundingClientRect();
                const offset = y - box.top - box.height / 2;
                if (offset < 0 && offset > closest.offset) return { offset: offset, element: child };
                else return closest;
            }, { offset: Number.NEGATIVE_INFINITY }).element;
        }

        function toggleEspoBracket(id, type) {
            const item = espoConditionRegistry.find(i => i.id === id);
            if (item) {
                if (type === 'open') item.bracketOpen = !item.bracketOpen;
                else item.bracketClose = !item.bracketClose;
                renderEspoUI();
            }
        }

        function updateFormulaView() {
            const formulaDisplay = document.getElementById('formula-display');
            if (!formulaDisplay) return;

            if (espoConditionRegistry.length === 0) {
                formulaDisplay.innerHTML = '<span class="text-muted small">Немає фільтрів</span>';
                return;
            }

            const formatOp = (op) => {
                const lower = op.toLowerCase();
                let cls = 'text-primary';
                if (lower === 'або') cls = 'text-warning';
                if (lower === 'окрім') cls = 'text-danger';
                return `<span class="formula-operator mx-2 fw-bold ${cls}">${lower}</span>`;
            };

            const wrap = (html) => `<span class="formula-bracket">(</span> ${html} <span class="formula-bracket">)</span>`;

            let includeFormula = buildRecursiveFormula(null, 'Include');
            let excludeFormula = buildRecursiveFormula(null, 'Exclude');

            const includeCount = espoConditionRegistry.filter(i => i.parentId === null && i.zone === 'Include').length;
            const excludeCount = espoConditionRegistry.filter(i => i.parentId === null && i.zone === 'Exclude').length;

            // If there is an exclusion, we wrap inclusion in brackets for clarity
            if (excludeCount > 0 && includeFormula) {
                // Only wrap if it's not already starting/ending with brackets from buildRecursiveFormula
                const trimmed = includeFormula.trim();
                const startsWithBracket = trimmed.startsWith('<span class="formula-bracket">(</span>');
                const endsWithBracket = trimmed.endsWith('<span class="formula-bracket">)</span>');

                // If it has multiple top-level items OR doesn't have outer brackets, wrap it.
                if (includeCount > 1 || !startsWithBracket || !endsWithBracket) {
                    includeFormula = wrap(includeFormula);
                }
            }

            let finalHtml = includeFormula;
            if (includeFormula && excludeFormula) {
                finalHtml += ` ${formatOp('окрім')} ${excludeFormula}`;
            } else if (excludeFormula) {
                finalHtml = `${formatOp('окрім')} ${excludeFormula}`;
            }

            formulaDisplay.innerHTML = finalHtml || '<span class="text-muted small">Немає фільтрів</span>';

            // Handle truncation button
            let expandBtn = formulaDisplay.querySelector('.formula-expand-btn');
            if (finalHtml) {
                if (!expandBtn) {
                    expandBtn = document.createElement('div');
                    expandBtn.className = 'formula-expand-btn';
                    expandBtn.innerHTML = '<i class="bi bi-three-dots"></i>';
                    expandBtn.onclick = (e) => {
                        e.stopPropagation();
                        const isExpanded = formulaDisplay.classList.toggle('is-expanded');
                        expandBtn.innerHTML = isExpanded ? '<i class="bi bi-chevron-up"></i>' : '<i class="bi bi-three-dots"></i>';
                    };
                    formulaDisplay.appendChild(expandBtn);
                }

                // Show/hide button based on actual overflow
                // We reset expansion to check original height
                const originalExpansion = formulaDisplay.classList.contains('is-expanded');
                formulaDisplay.classList.remove('is-expanded');
                if (formulaDisplay.scrollHeight > formulaDisplay.clientHeight + 5) {
                    expandBtn.style.display = 'flex';
                } else {
                    expandBtn.style.display = 'none';
                    formulaDisplay.classList.remove('is-expanded');
                }
                if (originalExpansion) {
                    formulaDisplay.classList.add('is-expanded');
                    expandBtn.innerHTML = '<i class="bi bi-chevron-up"></i>';
                }
            } else {
                if (expandBtn) expandBtn.remove();
                formulaDisplay.classList.remove('is-expanded');
            }
        }

        function buildRecursiveFormula(parentId, zone) {
            const items = espoConditionRegistry.filter(i => i.parentId === parentId && i.zone === zone);
            if (items.length === 0) return "";

            const formatOp = (op) => {
                const lower = op.toLowerCase();
                let cls = 'text-primary';
                if (lower === 'або') cls = 'text-warning';
                if (lower === 'окрім') cls = 'text-danger';
                return `<span class="formula-operator mx-1 fw-bold ${cls}">${lower}</span>`;
            };

            const wrapGroup = (html) => `<span class="formula-group"><span class="formula-bracket">(</span> ${html} <span class="formula-bracket">)</span></span>`;

            // Group items by operator precedence: AND (TA) binds tighter than OR (ABO)
            // We split items into groups separated by 'ABO'
            const groups = [];
            let currentGroup = [];

            items.forEach((item, index) => {
                const oppositeZone = zone === 'Include' ? 'Exclude' : 'Include';
                const mySig = getBranchSignature(item.id);
                const hasConflict = espoConditionRegistry.some(i => i.zone === oppositeZone && getBranchSignature(i.id) === mySig);

                const displayValue = item.fieldOp ? `${item.fieldOp} ${item.value || ''}` : (item.value || item.op);
                let bit = `<span class="formula-item ${hasConflict ? 'is-conflict' : ''}" ${hasConflict ? 'title="Конфлікт: це значення присутнє в обох зонах"' : ''}><b>${item.label}:</b> ${displayValue}</span>`;
                const childrenFormula = buildRecursiveFormula(item.id, zone);
                if (childrenFormula) {
                    // Manual nesting always gets brackets
                    // Show the logic used for the first level of nesting
                    const nestOp = item.interOp || 'ТА';
                    bit = `<span class="formula-bracket">(</span> ${bit} ${formatOp(nestOp)} ${childrenFormula} <span class="formula-bracket">)</span>`;
                }

                currentGroup.push(bit);

                // If this is not the last item, check the operator to the next item
                if (index < items.length - 1) {
                    if (item.interOp === 'АБО') {
                        groups.push({ html: currentGroup.join(` ${formatOp('ТА')} `), isAndGroup: currentGroup.length > 1 });
                        currentGroup = [];
                    }
                } else {
                    groups.push({ html: currentGroup.join(` ${formatOp('ТА')} `), isAndGroup: currentGroup.length > 1 });
                }
            });

            // If we have mixed operators (multiple groups or an and-group in a single list), 
            // wrap the AND-chains in brackets for clarity
            const formattedGroups = groups.map(g => (g.isAndGroup && groups.length > 1) ? wrapGroup(g.html) : g.html);

            return formattedGroups.join(` ${formatOp('АБО')} `);
        }

        function updateFiltersCount() {
            updateFormulaView();
        }


        // --- 1. TABS SYSTEM ---


        // --- 1. TABS SYSTEM ---
        function switchTab(tabId) {
            // Hide all sections
            document.querySelectorAll('.view-section').forEach(el => el.classList.add('d-none'));
            // Show target
            document.getElementById(`view-${tabId}`).classList.remove('d-none');

            // Update Nav
            document.querySelectorAll('.nav-link').forEach(el => el.classList.remove('active'));
            document.getElementById(`tab-${tabId}`).classList.add('active');

            updateState();
        }

        // Helper to create tag
        window.currentFilterMode = 'Include';
        function createTag(type, value, operator) {
            const categoryMap = {
                'Role': 'Роль', 'Service': 'Сервіс', 'Payer': 'Платник', 'Created': 'Місце створ.',
                'Type': 'Тип', 'EDRPOU': 'ЄДРПОУ', 'WhType': 'Тип відділення', 'City': 'Місто',
                'Area': 'Область', 'Cargo': 'Вантаж', 'PayMethod': 'Оплата', 'Market': 'Маркет',
                'Pretense': 'Претензії', 'Country': 'Країна', 'Gender': 'Стать', 'Verified': 'Верифікація',
                'HasEmail': 'Email', 'AppUser': 'App', 'OS': 'ОС', 'Device': 'Девайс',
                'FavPoint': 'Улюб. точка', 'LastCity': 'Ост. місто'
            };

            // Priority: Local override (Include/Exclude/NOT) > Global Toggle
            let zone = window.currentFilterMode || 'Include';
            if (operator === 'NOT' || operator === 'Exclude') zone = 'Exclude';
            else if (operator === 'Include') zone = 'Include';

            addEspoBlock(type, categoryMap[type] || type, value, zone, 'ТА');
        }

        function addTextTag(inputElement, type) {
            const value = inputElement.value.trim();
            if (!value) return;

            let operator = "LIKE";
            if (inputElement.previousElementSibling && inputElement.previousElementSibling.tagName === 'SELECT') {
                operator = inputElement.previousElementSibling.value;
            }
            createTag(type, value, operator);
            inputElement.value = '';
            updateState();
        }

        function addTag(selectElement, type) {
            if (!selectElement.value) return;

            const value = selectElement.options[selectElement.selectedIndex].text;
            let operator = null; // Let global toggle decide if no local select
            if (selectElement.previousElementSibling && selectElement.previousElementSibling.tagName === 'SELECT') {
                operator = selectElement.previousElementSibling.value;
            }
            createTag(type, value, operator);
            setTimeout(() => selectElement.value = "", 100);
        }

        function removeTag(iconEl) {
            const pill = iconEl.parentElement;
            pill.remove();

            // Check if empty to hide container (for legacy tags)
            const container = document.getElementById('global-tags-container');
            if (container && container.children.length === 0) {
                const summary = document.getElementById('active-filters-summary');
                if (summary) summary.classList.add('d-none');
            }
            updateState();
            updateFiltersCount();
        }


        function clearFilters() {
            espoConditionRegistry = [];
            renderEspoUI();

            document.querySelectorAll('input').forEach(el => {
                if (el.type !== 'radio' && el.type !== 'checkbox' && el.id !== 'ai-format') el.value = '';
                if (el.type === 'checkbox' && !el.id.includes('toggle')) el.checked = false;
            });
            document.querySelectorAll('select').forEach(el => {
                if (el.id !== 'ai-format' && el.id !== 'constructor-format') el.value = "";
            });
            updateState();
            updateFiltersCount();
        }

        // --- 3. COUNTER ANIMATION ---
        function updateState() {
            const display = document.getElementById('counter-display');
            display.style.opacity = '0.5';
            display.classList.remove('counter-animate');

            setTimeout(() => {
                // Random count between 10k and 24M for simulation
                const randomCount = Math.floor(Math.random() * (24000000 - 10000) + 10000);
                display.innerText = new Intl.NumberFormat('en-US', { notation: "compact", compactDisplay: "short" }).format(randomCount);
                display.style.opacity = '1';
                display.classList.add('counter-animate');

                // Trigger Analytics Update
                updateAnalytics();
            }, 300);
        }

        // --- 4. LOOK-A-LIKE LOGIC ---
        function handleLookalikeInput(event, type) {
            if (event.key === 'Enter') {
                event.preventDefault();
                addLalTag(type);
            }
        }

        function addLalTag(type) {
            const input = document.getElementById(`lal-${type}`);
            const val = input.value.trim();
            if (!val) return;

            const container = document.getElementById(`tags-lal-${type}`);
            const pill = document.createElement('div');
            pill.className = 'tag-pill';
            pill.innerHTML = `${val} <i class="bi bi-x" onclick="this.parentElement.remove(); updateState()"></i>`;
            container.appendChild(pill);

            input.value = '';
            updateState();
        }

        // --- 5. AI ASSISTANT LOGIC ---
        // --- 5. GENERATION Logic (Unified) ---
        function fillAiPrompt(text) {
            document.getElementById('ai-prompt').value = text;
        }

        // Wrapper for AI specific (backward compatibility or specific logic)
        function handleAiRequest() {
            handleGeneration('ai');
        }

        function handleGeneration(source) {
            // source: 'constructor', 'lookalike', 'ai'

            let formatId = source + '-format';
            let resultsId = source + '-results';
            let tableBodyId = source + '-table-body';

            // Only AI has SQL preview, others just table

            const formatEl = document.getElementById(formatId);
            if (!formatEl) return; // Error

            const format = formatEl.value;

            // Prompt check specific to AI
            if (source === 'ai') {
                const prompt = document.getElementById('ai-prompt').value;
                if (!prompt) {
                    alert('Будь ласка, введіть запит!');
                    return;
                }
            }

            if (!format) {
                alert('Будь ласка, оберіть формат вибірки!');
                formatEl.focus();
                return;
            }

            // Button Loading State
            // Find the button inside the active view or close to the select
            const btn = formatEl.closest('.row').querySelector('button');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Обробка...';
            btn.disabled = true;

            setTimeout(() => {
                // If AI, show SQL
                if (source === 'ai') {
                    // Build SQL Mock
                    let sql = "";
                    let tableMapping = "Clients"; // Generic
                    if (format === "phone") tableMapping = "Clients JOIN Parcels ON Clients.id = Parcels.sender_id";

                    sql = `<span class="sql-keyword">SELECT DISTINCT</span> <span class="sql-field">${format === 'audience_id' ? 'COUNT(*)' : getSqlField(format)}</span> <br>`;
                    sql += `<span class="sql-keyword">FROM</span> <span class="sql-table">${tableMapping}</span> <br>`;
                    sql += `<span class="sql-keyword">WHERE</span> <span class="sql-field">Country</span> = <span class="sql-string">'UA'</span> <br>`;
                    sql += `<span class="sql-keyword">AND</span> <span class="sql-field">Date</span> > <span class="sql-keyword">DATE_SUB</span>(NOW(), <span class="sql-keyword">INTERVAL</span> 30 <span class="sql-keyword">DAY</span>);`;

                    document.getElementById('sql-code').innerHTML = sql;
                }

                // Show Results Container
                document.getElementById(resultsId).classList.remove('d-none');

                // Render Table
                renderResultTable(format, tableBodyId);

                // For Audience ID, we might show Alert instead of table (optional, keeping table for consistency unless requested otherwise)
                // The user asked for "Preview" on all tabs.
                // In previous AI logic, audience_id showed an alert. Let's keep table for simplicity or handle special case.

                // Reset Button
                btn.innerHTML = originalText;
                btn.disabled = false;

                // Scroll to results
                document.getElementById(resultsId).scrollIntoView({ behavior: 'smooth', block: 'nearest' });

            }, 1000);
        }

        function getSqlField(format) {
            switch (format) {
                case 'phone': return 'Phone';
                case 'email': return 'Email';
                case 'cid': return 'CID';
                default: return '*';
            }
        }

        function renderResultTable(format, tbodyId) {
            const tbody = document.getElementById(tbodyId);
            if (!tbody) return;

            tbody.innerHTML = '';

            // Generate clean mock data based on format
            let mockData = [];

            if (format === 'phone') {
                mockData = ['380950001122', '380670003344', '380630005566', '380500007788', '380930009900'];
            } else if (format === 'email') {
                mockData = ['user1@gmail.com', 'alex@ukr.net', 'maria@work.ua', 'info@shop.com', 'client@bk.com'];
            } else if (format === 'cid') {
                mockData = ['10029394', '29384858', '33029485', '49583020', '50693021'];
            } else {
                mockData = ['AUD-2023-A', 'AUD-2023-B', 'AUD-2023-C', 'AUD-2023-D', 'AUD-2023-E']; // Audience IDs
            }

            mockData.forEach((val, i) => {
                const tr = `<tr>
                    <td style="width: 50px;">${i + 1}</td>
                    <td class="font-monospace text-primary fw-bold">${val}</td>
                </tr>`;
                tbody.innerHTML += tr;
            });

            // Find the table header to update column name
            // tbody -> table -> thead -> tr -> th:nth-child(2)
            const table = tbody.closest('table');
            const th = table.querySelector('thead tr th:nth-child(2)');
            if (th) {
                switch (format) {
                    case 'phone': th.innerText = 'Телефон (MP)'; break;
                    case 'email': th.innerText = 'E-mail'; break;
                    case 'cid': th.innerText = 'CID'; break;
                    default: th.innerText = 'ID Аудиторії'; break;
                }
            }
        }

        // --- 6. PRESETS LOGIC ---
        function applyPersona(type) {
            // Need to switch to Constructor tab if not active
            switchTab('constructor');

            // Clear first
            clearFilters();

            // Wait for visual reset then apply
            setTimeout(() => {
                if (type === 'vip') {
                    // High check, iPhone
                    addMockTag('c3', 'Оголошена вартість', '> 5000');
                    addMockTag('c6', 'Девайс', 'iPhone');
                    addMockTag('c2', 'Місто', 'Kyiv');
                } else if (type === 'churn') {
                    // Inactive
                    addMockTag('c5', 'Остання активність', '> 60 днів');
                }
                updateState();
            }, 200);
        }

        function addMockTag(fakeContainerId, type, value) {
            // Updated to use global container (ignoring fakeContainerId arg)
            const container = document.getElementById('global-tags-container');
            const summaryBlock = document.getElementById('active-filters-summary');

            if (summaryBlock.classList.contains('d-none')) {
                summaryBlock.classList.remove('d-none');
            }

            const pill = document.createElement('div');
            pill.className = 'tag-pill';
            pill.innerHTML = `<span class="fw-light text-secondary me-1">${type}:</span> ${value} <i class="bi bi-x" onclick="removeTag(this)"></i>`;
            container.appendChild(pill);
        }

        // --- 7. NEW FEATURES (PREMIUM) ---

        // 7.1 DARK MODE
        function toggleTheme() {
            const body = document.body;
            const icon = document.getElementById('theme-icon');

            if (body.hasAttribute('data-theme')) {
                body.removeAttribute('data-theme');
                icon.className = 'bi bi-moon-stars-fill';
                localStorage.setItem('theme', 'light');
            } else {
                body.setAttribute('data-theme', 'dark');
                icon.className = 'bi bi-sun-fill';
                localStorage.setItem('theme', 'dark');
            }
            updateChartColors();
        }

        // Init Theme
        if (localStorage.getItem('theme') === 'dark') {
            document.body.setAttribute('data-theme', 'dark');
            const icon = document.getElementById('theme-icon');
            if (icon) icon.className = 'bi bi-sun-fill';
        }

        // 7.2 INSTANT ANALYTICS
        let chartInstances = {};

        function initCharts() {
            // Only init if panel is visible or allows to be loaded
            // We'll create them once
            const ctxGender = document.getElementById('chart-gender').getContext('2d');
            const ctxDevice = document.getElementById('chart-device').getContext('2d');
            const ctxCities = document.getElementById('chart-cities').getContext('2d');

            const commonOptions = {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { position: 'right', labels: { boxWidth: 10, font: { size: 10 } } } }
            };

            chartInstances.gender = new Chart(ctxGender, {
                type: 'doughnut',
                data: { labels: ['Ч', 'Ж'], datasets: [{ data: [45, 55], backgroundColor: ['#4361ee', '#f72585'] }] },
                options: commonOptions
            });

            chartInstances.device = new Chart(ctxDevice, {
                type: 'doughnut',
                data: { labels: ['iOS', 'Android', 'Other'], datasets: [{ data: [60, 35, 5], backgroundColor: ['#000000', '#3ddc84', '#6c757d'] }] },
                options: commonOptions
            });

            chartInstances.cities = new Chart(ctxCities, {
                type: 'bar',
                data: { labels: ['Kyiv', 'Lviv', 'Odessa', 'Dnipro', 'Kharkiv'], datasets: [{ label: 'Users', data: [50, 20, 15, 10, 5], backgroundColor: '#4cc9f0' }] },
                options: { ...commonOptions, plugins: { legend: { display: false } }, indexAxis: 'y' }
            });

            updateChartColors();
        }

        function updateAnalytics() {
            // Check if modal is actually trying to be shown or just background update
            // With Modal logic, we only render if charts exist (which means modal was opened at least once or we force it)
            // But Chart.js needs a visible canvas usually. 
            // We'll rely on the user clicking the button to "view" analytics, or auto-update if chart instances exist.

            if (!chartInstances.gender) {
                // Charts not initialized yet.
                // If Modal is open, init. If not, wait.
                const modal = document.getElementById('analyticsModal');
                if (modal.classList.contains('show')) {
                    setTimeout(initCharts, 200);
                }
                return;
            }

            // Normal update logic
            const r = () => Math.floor(Math.random() * 100);

            // Gender
            chartInstances.gender.data.datasets[0].data = [r(), r()];
            chartInstances.gender.update();

            // Device
            chartInstances.device.data.datasets[0].data = [r(), r(), 10];
            chartInstances.device.update();

            // Cities
            chartInstances.cities.data.datasets[0].data = [r(), r(), r(), r(), r()].sort((a, b) => b - a);
            chartInstances.cities.update();
        }

        // Listener for modal open to init charts for first time
        document.addEventListener('DOMContentLoaded', () => {
            const modal = document.getElementById('analyticsModal');
            modal.addEventListener('shown.bs.modal', function () {
                if (!chartInstances.gender) {
                    initCharts();
                } else {
                    updateAnalytics();
                }
            });
        });

        function updateChartColors() {
            if (!chartInstances.gender) return;

            const isDark = document.body.hasAttribute('data-theme');
            const textColor = isDark ? '#a0aec0' : '#6c757d';
            const gridColor = isDark ? '#2d3748' : '#e9ecef';

            [chartInstances.gender, chartInstances.device, chartInstances.cities].forEach(chart => {
                // Update Legend
                if (chart.options.plugins && chart.options.plugins.legend) {
                    chart.options.plugins.legend.labels.color = textColor;
                }
                // Update Scales (for Bar chart)
                if (chart.options.scales) {
                    Object.values(chart.options.scales).forEach(scale => {
                        if (scale.ticks) scale.ticks.color = textColor;
                        if (scale.grid) scale.grid.color = gridColor;
                    });
                }
                chart.update();
            });
        }


        // 7.3 SAVED SEGMENTS (LocalStorage)
        function saveCurrentSegment() {
            // Open Modal
            const modalEl = document.getElementById('saveSegmentModal');
            const modal = new bootstrap.Modal(modalEl);
            // Default name
            document.getElementById('segmentNameInput').value = "Мій сегмент " + new Date().toLocaleDateString();
            modal.show();
        }

        function confirmSaveSegment() {
            const nameInput = document.getElementById('segmentNameInput');
            const name = nameInput.value.trim() || 'Без назви';

            // Collect active tags
            const tags = [];
            document.querySelectorAll('.tag-pill').forEach(pill => {
                tags.push(pill.innerText.replace('x', '').trim());
            });

            const segment = {
                id: Date.now(),
                name: name,
                tags: tags,
                count: document.getElementById('counter-display').innerText
            };

            const saved = JSON.parse(localStorage.getItem('mySegments') || '[]');
            saved.push(segment);
            localStorage.setItem('mySegments', JSON.stringify(saved));

            // Close modal
            const modalEl = document.getElementById('saveSegmentModal');
            const modal = bootstrap.Modal.getInstance(modalEl);
            modal.hide();

            renderSavedSegments();
        }

        function renderSavedSegments() {
            const list = document.getElementById('header-saved-segments-list');
            const saved = JSON.parse(localStorage.getItem('mySegments') || '[]');
            const badge = document.getElementById('segments-badge');

            if (saved.length > 0) {
                if (badge) badge.style.display = 'block';
            } else {
                if (badge) badge.style.display = 'none';
            }

            if (saved.length === 0) {
                list.innerHTML = '<div class="text-center text-muted small py-3">Немає збережених сегментів</div>';
                return;
            }

            list.innerHTML = saved.map(s => `
                <div class="d-flex justify-content-between align-items-center bg-light p-2 rounded border dropdown-item-text">
                    <div style="cursor:pointer" onclick="restoreSegment(${s.id})" class="text-truncate" style="max-width: 200px;">
                        <div class="fw-bold small text-primary">${s.name}</div>
                        <div class="text-muted" style="font-size:0.7rem">${s.count} users</div>
                    </div>
                    <i class="bi bi-trash text-danger ms-2" style="cursor:pointer" onclick="deleteSegment(${s.id})"></i>
                </div>
            `).join('');
        }

        function deleteSegment(id) {
            let saved = JSON.parse(localStorage.getItem('mySegments') || '[]');
            saved = saved.filter(s => s.id !== id);
            localStorage.setItem('mySegments', JSON.stringify(saved));
            renderSavedSegments();
        }

        function restoreSegment(id) {
            const saved = JSON.parse(localStorage.getItem('mySegments') || '[]');
            const segment = saved.find(s => s.id === id);
            if (!segment) return;

            // Restore visual state
            clearFilters();
            switchTab('constructor'); // Ensure we are on constructor

            setTimeout(() => {
                // Check tags text and restore (mocking)
                segment.tags.forEach(tagText => {
                    // Parse type and value from "Type: Value" string
                    const parts = tagText.split(':');
                    if (parts.length > 1) {
                        const type = parts[0].trim();
                        const val = parts[1].trim();
                        addMockTag('c4', type, val);
                    }
                });
                updateState();
            }, 100);
        }

        // Init Saved List
        renderSavedSegments();

        // 7.4 EXPORT MOCK CSV
        function handleExportAction() {
            const select = document.querySelector('.sidebar-sticky select');
            const action = select ? select.value : 'csv';

            if (action === 'csv') {
                generateAndDownloadCSV();
            } else {
                alert('Ця функція (' + action + ') доступна в Enterprise версії.');
            }
        }

        function generateAndDownloadCSV() {
            // Marshaling some fake data
            const headers = ["Phone", "Email", "Name", "City", "LastActive", "SegmentScore"];
            let rows = [];

            for (let i = 0; i < 50; i++) {
                rows.push([
                    `380${Math.floor(Math.random() * 900000000 + 100000000)}`, // Phone
                    `user${i}@mail.com`, // Email
                    `Client ${i}`,       // Name
                    ['Kyiv', 'Lviv', 'Odessa', 'Dnipro'][Math.floor(Math.random() * 4)], // City
                    new Date().toISOString().split('T')[0], // Date
                    (Math.random() * 100).toFixed(2) // Score
                ]);
            }

            let csvContent = "data:text/csv;charset=utf-8,"
                + headers.join(",") + "\n"
                + rows.map(e => e.join(",")).join("\n");

            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "audience_export_" + new Date().toISOString().slice(0, 10) + ".csv");
            document.body.appendChild(link); // Required for FF
            link.click();
            document.body.removeChild(link);
        }

        function toggleFormulaCard() {
            const card = document.getElementById('main-formula-card');
            card.classList.toggle('is-collapsed');
        }
    </script>
    <div id="filter-picker" class="filter-picker-overlay"></div>
</body>

</html>