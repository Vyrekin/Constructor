<!DOCTYPE html>
<html lang="uk">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Конструктор вибірок | Diamond Edition</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        :root {
            /* Diamond Edition Palette */
            --primary: #4361ee;
            --primary-soft: #eef2ff;
            --secondary: #3f37c9;
            --accent: #4cc9f0;
            --surface: #ffffff;
            --bg-app: #f8f9fa;
            --text-main: #1b263b;
            --text-muted: #6c757d;
            --border: #e9ecef;

            /* Effects */
            --shadow-float: 0 10px 30px rgba(67, 97, 238, 0.15);
            --shadow-card: 0 4px 12px rgba(0, 0, 0, 0.05);
            --radius-btn: 12px;
            --radius-card: 20px;
        }

        [data-theme="dark"] {
            /* Premium Slate Dark Palette */
            --primary: #6366f1;
            --primary-soft: rgba(99, 102, 241, 0.15);
            --secondary: #818cf8;
            --surface: #1e293b;
            --bg-app: #0f172a;
            --text-main: #f8fafc;
            --text-muted: #94a3b8;
            --border: #334155;

            /* Enhanced Dark Shadows */
            --shadow-float: 0 10px 40px rgba(0, 0, 0, 0.6);
            --shadow-card: 0 4px 20px rgba(0, 0, 0, 0.4);
        }

        /* Dark Mode Specific Overrides */
        [data-theme="dark"] .app-header {
            background: rgba(15, 23, 42, 0.85);
            /* Dark glass */
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        [data-theme="dark"] .bg-light {
            background-color: #1e293b !important;
            /* Surface for standard light bg */
        }

        [data-theme="dark"] .card-diamond,
        [data-theme="dark"] .condition-block,
        [data-theme="dark"] .formula-card,
        [data-theme="dark"] .section-title-espo,
        [data-theme="dark"] .inter-op-select,
        [data-theme="dark"] .formula-item,
        [data-theme="dark"] .modal-content,
        [data-theme="dark"] .dropdown-menu {
            background-color: var(--surface);
            border-color: var(--border);
            color: var(--text-main);
        }

        [data-theme="dark"] .condition-header {
            background-color: rgba(255, 255, 255, 0.03);
            border-bottom-color: var(--border);
        }

        [data-theme="dark"] .formula-box,
        [data-theme="dark"] .drop-zone {
            background-color: rgba(0, 0, 0, 0.2);
            border-color: var(--border);
            color: var(--text-muted);
        }

        [data-theme="dark"] .drop-zone:hover {
            background-color: rgba(99, 102, 241, 0.1);
            border-color: var(--primary);
        }

        [data-theme="dark"] .form-control,
        [data-theme="dark"] .form-select,
        [data-theme="dark"] .input-group-text {
            background-color: #0f172a;
            border-color: var(--border);
            color: var(--text-main);
        }

        /* Global Design Variables Overrides */
        #filterTabs .nav-link {
            font-size: var(--tab-font-size, 0.85rem) !important;
        }

        .form-label {
            font-size: var(--label-font-size, 11px) !important;
        }

        /* High specificity to override utility classes */
        .tab-pane-card h6.fw-bold.text-primary,
        .tab-pane-card .subsection-title {
            font-size: var(--subsection-font-size, 15px) !important;
            transition: all 0.2s ease;
            display: block;
        }

        [data-theme="dark"] .form-control::placeholder {
            color: #475569;
        }

        /* Compact UI Overrides for 1920x1200 efficiency */
        html,
        body {
            font-size: 14.5px;
        }

        .tab-pane-card {
            padding: 0.75rem !important;
        }

        .form-label {
            font-size: 11px;
            margin-bottom: 0.1rem;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }

        .form-control,
        .form-select {
            padding: 0.2rem 0.5rem;
            font-size: 0.95rem;
            min-height: 30px;
            border-radius: 8px;
        }

        .input-group-text {
            padding: 0.2rem 0.4rem;
            font-size: 0.8rem;
        }

        .btn-outline-primary {
            padding: 0.2rem 0.6rem;
        }

        h6.text-primary.text-uppercase {
            font-size: 1.1rem !important;
            margin-bottom: 0.4rem !important;
            margin-top: 0.2rem !important;
            opacity: 0.8;
        }

        .row.g-3 {
            --bs-gutter-y: 0.6rem;
            --bs-gutter-x: 0.75rem;
        }

        .mb-4 {
            margin-bottom: 0.8rem !important;
        }

        .nav-pills .nav-link {
            padding: 0.35rem 0.7rem !important;
            font-size: 0.85rem !important;
            border-radius: 10px;
            white-space: nowrap;
        }

        .compact-control-card {
            padding: 0.2rem !important;
        }

        .sticky-controls-wrapper {
            margin-bottom: 0.5rem;
        }

        [data-theme="dark"] .nav-link {
            color: #cbd5e1;
        }

        [data-theme="dark"] .nav-link:hover {
            background-color: rgba(255, 255, 255, 0.05);
            color: #fff;
        }

        [data-theme="dark"] .nav-link.active {
            background-color: var(--primary);
            color: #fff;
        }

        [data-theme="dark"] .btn-light {
            background-color: var(--surface);
            border-color: var(--border);
            color: var(--text-main);
        }

        [data-theme="dark"] .btn-light:hover {
            background-color: #334155;
            color: #fff;
        }

        [data-theme="dark"] .text-muted {
            color: #94a3b8 !important;
        }

        [data-theme="dark"] .border {
            border-color: var(--border) !important;
        }

        /* Fix Espo Condition Colors in Dark Mode */
        [data-theme="dark"] .op-ta,
        [data-theme="dark"] .op-abo,
        [data-theme="dark"] .op-okrim {
            filter: brightness(0.9);
            /* Slightly dim the bright badges */
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-app);
            color: var(--text-main);
            overflow-x: hidden;
        }

        /* Sticky Glass Header */
        .app-header {
            position: sticky;
            top: 0;
            z-index: 1000;
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid var(--border);
            padding: 0.25rem 0;
            height: 60px;
            display: flex;
            align-items: center;
        }

        @media (max-width: 768px) {
            .app-header {
                height: auto;
                padding: 0.5rem 0;
            }

            .app-header .header-main-row {
                order: 3;
                width: 100%;
                margin-top: 0.5rem;
            }

            .app-header h4 {
                font-size: 1.1rem;
            }
        }

        /* Navigation Tabs */
        .nav-pills .nav-link {
            color: var(--text-muted);
            border-radius: var(--radius-btn);
            padding: 0.6rem 1.2rem;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .nav-pills .nav-link.active {
            background-color: var(--primary);
            color: white;
            box-shadow: 0 4px 15px rgba(67, 97, 238, 0.4);
        }

        /* Cards & Surfaces */
        .card-diamond {
            background: var(--surface);
            border: none;
            border-radius: var(--radius-card);
            box-shadow: var(--shadow-card);
            transition: transform 0.2s;
            margin-bottom: 1rem;
        }

        /* Accordion Customization */
        .accordion-item {
            border: 1px solid var(--border);
            border-radius: 16px !important;
            margin-bottom: 8px;
            overflow: hidden;
            background: var(--surface);
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.02);
        }

        .accordion-button {
            background-color: var(--surface);
            color: var(--text-main);
            font-weight: 600;
            border-radius: 16px !important;
            padding: 0.5rem 0.85rem;
        }

        .accordion-button:not(.collapsed) {
            background-color: var(--primary-soft);
            color: var(--primary);
            box-shadow: none;
        }

        .accordion-button:focus {
            box-shadow: none;
            border-color: var(--primary-soft);
        }

        .accordion-button::after {
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16' fill='%234361ee'%3e%3cpath fill-rule='evenodd' d='M1.646 4.646a.5.5 0 0 1 .708 0L8 10.293l5.646-5.647a.5.5 0 0 1 .708.708l-6 6a.5.5 0 0 1-.708 0l-6-6a.5.5 0 0 1 0-.708z'/%3e%3c/svg%3e");
        }

        /* Sidebar */
        .sidebar-sticky {
            position: sticky;
            top: 80px;
        }

        @media (max-width: 991px) {
            .sidebar-sticky {
                position: static;
                margin-top: 1rem;
            }
        }

        .counter-box {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            color: white;
            padding: 1rem;
            border-radius: var(--radius-card);
            text-align: center;
            box-shadow: var(--shadow-float);
            margin-bottom: 0.75rem;
        }

        .counter-number {
            font-size: 2rem;
            font-weight: 700;
            line-height: 1;
        }

        /* Additional Dark Mode Fixes */
        [data-theme="dark"] .custom-filter-tabs,
        [data-theme="dark"] .compact-control-card {
            background: var(--surface);
            border-color: var(--border) !important;
        }

        [data-theme="dark"] #filter-picker {
            background: var(--surface);
            border-color: var(--border);
        }

        [data-theme="dark"] .picker-header {
            background: rgba(0, 0, 0, 0.2);
            border-bottom-color: var(--border);
        }

        [data-theme="dark"] .picker-item:hover {
            background: var(--primary-soft);
        }

        [data-theme="dark"] .legend-badge {
            background: var(--surface);
            border-color: var(--border);
        }

        [data-theme="dark"] .counter-box {
            background: linear-gradient(135deg, #4f46e5 0%, #3730a3 100%);
            /* Less saturated in dark mode */
        }

        [data-theme="dark"] #espo-include-list:empty,
        [data-theme="dark"] #espo-exclude-list:empty {
            background: rgba(255, 255, 255, 0.02);
            border-color: rgba(255, 255, 255, 0.1);
        }

        [data-theme="dark"] .toggle-icon {
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-main);
        }

        [data-theme="dark"] .toggle-icon:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .counter-number {
            font-size: 2.5rem;
            font-weight: 700;
            line-height: 1;
        }

        /* Inputs & Form Elements */
        .form-control,
        .form-select {
            border-radius: var(--radius-btn);
            border: 1px solid var(--border);
            padding: 0.4rem 0.8rem;
            font-size: 0.95rem;
        }

        .form-control:focus,
        .form-select:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 4px var(--primary-soft);
        }

        label.form-label {
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--text-muted);
            margin-bottom: 0.4rem;
        }

        /* Tag Pills */
        .tags-container {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            min-height: 0;
            transition: all 0.3s;
        }

        .tag-pill {
            display: inline-flex;
            align-items: center;
            background-color: var(--primary-soft);
            color: var(--primary);
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
            animation: fadeIn 0.3s ease;
        }

        .tag-pill i {
            margin-left: 8px;
            cursor: pointer;
            opacity: 0.7;
            transition: opacity 0.2s;
        }

        .tag-pill i:hover {
            opacity: 1;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(5px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Buttons */
        .btn-primary {
            background-color: var(--primary);
            border: none;
            border-radius: var(--radius-btn);
            padding: 0.5rem 1.25rem;
            box-shadow: 0 4px 15px rgba(67, 97, 238, 0.3);
            font-weight: 600;
            transition: all 0.2s;
        }

        .btn-primary:hover {
            background-color: var(--secondary);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(67, 97, 238, 0.4);
        }

        /* Drag & Drop Zone */
        .drop-zone {
            border: 2px dashed var(--border);
            border-radius: var(--radius-card);
            padding: 1.5rem;
            text-align: center;
            background-color: #fafafa;
            transition: all 0.3s;
            cursor: pointer;
        }

        .drop-zone:hover {
            border-color: var(--primary);
            background-color: var(--primary-soft);
        }

        /* AI Code Block */
        .sql-preview {
            background-color: #1e1e2e;
            color: #a5b0c5;
            padding: 1.5rem;
            border-radius: 12px;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            margin-top: 1rem;
            border-left: 4px solid var(--accent);
            line-height: 1.5;
        }

        .sql-keyword {
            color: #ff79c6;
        }

        .sql-field {
            color: #8be9fd;
        }

        .sql-table {
            color: #f1fa8c;
        }

        .sql-string {
            color: #f2c67d;
        }

        /* Animation for Counter */
        .counter-animate {
            animation: pulse 0.5s ease;
        }

        @keyframes pulse {
            0% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.05);
            }

            100% {
                transform: scale(1);
            }
        }

        /* Formula View Styles */
        .formula-card {
            background: #fff;
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 1rem;
            margin-bottom: 1rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.03);
            position: relative;
        }

        /* Espo-style Condition Blocks (Compact) */
        .condition-block {
            background: #fff;
            border: 1px solid var(--border);
            border-radius: 8px;
            margin-bottom: 0;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.03);
            position: relative;
            transition: all 0.2s;
            cursor: grab;
            display: inline-flex;
            flex-direction: column;
            min-width: 151px;
            max-width: 300px;
        }

        .condition-block:active {
            cursor: grabbing;
        }

        .condition-block.dragging {
            opacity: 0.4;
            border: 2px dashed var(--primary);
        }

        /* Nested Blocks Styling */
        .sub-conditions-container {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            align-items: center;
            margin-left: 0.5rem;
            padding-left: 0.5rem;
            border-left: 2px solid #eee;
            margin-top: 0.2rem;
            position: relative;
        }

        .condition-header {
            padding: 4px 10px;
            background: #fcfcfc;
            border-bottom: 1px solid var(--border);
            border-radius: 8px 8px 0 0;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.8rem;
        }

        .condition-body {
            padding: 4px 10px;
            display: flex;
            flex-direction: column;
            min-height: 20px;
        }

        .condition-content-row {
            display: flex;
            align-items: center;
            gap: 10px;
            min-height: 24px;
        }

        .condition-item {
            padding-left: 10px;
            border-left: 2px solid var(--primary-soft);
            position: relative;
            flex-grow: 1;
            line-height: 1.2;
        }

        .op-tag {
            font-weight: 700;
            font-size: 0.65rem;
            padding: 1px 4px;
            border-radius: 4px;
            text-transform: uppercase;
        }

        .op-ta {
            background: #e7f1ff;
            color: #0d6efd;
        }

        .op-abo {
            background: #fff3cd;
            color: #856404;
        }

        .op-okrim {
            background: #f8d7da;
            color: #721c24;
        }

        .inter-block-op {
            display: inline-flex;
            justify-content: center;
            align-items: center;
            margin: 0;
            position: relative;
            z-index: 5;
        }

        .inter-op-select {
            background: white;
            border: 1px solid var(--border);
            border-radius: 4px;
            padding: 1px 5px;
            font-weight: 700;
            font-size: 0.65rem;
            cursor: pointer;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.06);
        }

        .section-title-espo {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            font-weight: 700;
            font-size: 0.85rem;
            cursor: pointer;
            padding: 6px 20px;
            border-radius: 10px;
            transition: all 0.2s;
            border: 1px solid var(--border);
            background: #fff;
            width: fit-content;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            position: relative;
            z-index: 2;
            white-space: nowrap;
        }

        .section-title-row {
            display: flex;
            align-items: center;
            width: 100%;
            position: relative;
            margin: 1.5rem 0 1rem 0;
        }

        .section-title-row::before,
        .section-title-row::after {
            content: "";
            height: 1px;
            background: #000;
            opacity: 0.15;
            z-index: 1;
        }

        .section-title-row::before {
            width: 40px;
            /* Fixed small width to keep button on the left */
            margin-right: 15px;
        }

        .section-title-row::after {
            flex-grow: 1;
            margin-left: 15px;
        }

        .section-title-espo.text-primary {
            border-color: #0d6efd22;
            background: #0d6efd08;
            color: #0d6efd !important;
        }

        .section-title-espo.text-danger {
            border-color: #dc354522;
            background: #dc354508;
            color: #dc3545 !important;
        }

        .section-title-espo:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.05);
        }

        .section-title-espo.text-primary:hover {
            border-color: #0d6efd;
            background: #0d6efd;
            color: white !important;
        }

        .section-title-espo.text-danger:hover {
            border-color: #dc3545;
            background: #dc3545;
            color: white !important;
        }

        .add-sub-btn {
            cursor: pointer;
            width: 22px;
            height: 22px;
            border-radius: 4px;
            background: var(--primary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.1rem;
            color: white;
            transition: all 0.2s;
            border: none;
            box-shadow: 0 2px 5px rgba(13, 110, 253, 0.3);
        }

        .add-sub-btn:hover {
            background: #0056b3;
            transform: scale(1.15);
            box-shadow: 0 4px 10px rgba(13, 110, 253, 0.5);
        }

        #espo-include-list,
        #espo-exclude-list {
            min-height: 20px;
            border-radius: 8px;
            transition: all 0.2s;
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            align-items: center;
            padding: 4px 0;
        }

        #espo-include-list:empty,
        #espo-exclude-list:empty {
            border: 2px dashed #eee;
            background: #fafafa;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 1rem;
        }

        #espo-include-list:empty::after {
            content: 'Оберіть фільтри для включення';
            color: #bbb;
            font-size: 0.75rem;
            font-weight: 600;
        }

        #espo-exclude-list:empty::after {
            content: 'Оберіть фільтри для виключення';
            color: #bbb;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .sub-conditions-container:empty {
            min-height: 10px;
        }

        .sub-conditions-container.drag-over {
            background: rgba(13, 110, 253, 0.05);
            border: 1px dashed var(--primary);
            min-height: 40px;
        }

        .formula-box {
            background: #f8f9fa;
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 0.75rem 1rem;
            font-size: 0.95rem;
            font-weight: 500;
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            align-items: center;
            min-height: 40px;
            margin-bottom: 0.25rem;
            line-height: 1.4;
        }

        .formula-item {
            background: white;
            border: 1px solid #dee2e6;
            padding: 2px 8px;
            border-radius: 6px;
            font-size: 0.9rem;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
            display: inline-flex;
            align-items: center;
            gap: 4px;
            transition: all 0.2s;
        }

        .formula-item.is-conflict {
            background: #fff5f5;
            border-color: #feb2b2;
            color: #c53030;
            box-shadow: 0 0 10px rgba(245, 101, 101, 0.3);
            animation: pulse-danger 2s infinite;
        }

        @keyframes pulse-danger {
            0% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.02);
            }

            100% {
                transform: scale(1);
            }
        }

        .formula-bracket {
            color: #4361ee;
            /* Changed to primary blue or another distinct color */
            font-weight: 800;
            font-size: 1.2rem;
            opacity: 0.8;
        }

        .formula-bracket.is-danger {
            color: #dc3545;
        }

        /* Sticky Formula Card & Controls Container */
        #active-filters-summary {
            position: sticky;
            top: 70px;
            z-index: 900;
            background: var(--bg-app);
            padding-top: 5px;
            margin-top: -5px;
        }

        .sticky-controls-wrapper {
            position: sticky;
            top: 132px;
            /* Adjusted to sit below the formula card */
            z-index: 890;
            background: var(--bg-app);
            padding-bottom: 10px;
            margin-bottom: 5px;
        }

        .formula-card {
            background: #fff;
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 0.5rem 0.75rem;
            margin-bottom: 0.75rem;
            box-shadow: var(--shadow-card);
            position: relative;
            transition: all 0.3s ease;
        }

        /* Tab content scrollable area for desktop to reduce main page scroll */
        @media (min-width: 992px) {
            .tab-content {
                max-height: calc(100vh - 380px);
                /* Dynamic adjustment for desktop */
                overflow-y: auto;
                padding-right: 5px;
            }
        }

        /* Responsive Improvements */
        @media (max-width: 768px) {
            .container-fluid {
                padding-left: 10px !important;
                padding-right: 10px !important;
            }

            .counter-number {
                font-size: 1.8rem;
            }

            .custom-filter-tabs {
                flex-wrap: nowrap !important;
                overflow-x: auto;
                padding-bottom: 8px !important;
                margin-bottom: 0 !important;
                -webkit-overflow-scrolling: touch;
                gap: 8px !important;
            }

            .custom-filter-tabs .nav-item {
                flex: 0 0 auto;
            }

            .custom-filter-tabs .nav-link {
                white-space: nowrap;
                padding: 0.4rem 0.8rem !important;
                font-size: 0.8rem;
                border: 1px solid var(--border) !important;
            }

            .sticky-controls-wrapper {
                position: static !important;
            }

            #active-filters-summary {
                position: static !important;
            }

            .sidebar-sticky {
                position: static !important;
            }

            .app-header {
                position: relative;
                /* Unstick header on very small devices if needed, or keep glass */
            }
        }

        /* Better scrollbar for tab content */
        .tab-content::-webkit-scrollbar {
            width: 4px;
        }

        .tab-content::-webkit-scrollbar-thumb {
            background-color: var(--border);
            border-radius: 10px;
        }

        /* Compact elements */
        .tab-pane-card {
            padding: 1rem;
            background: var(--surface);
            border-radius: 16px;
            border: 1px solid var(--border);
        }

        @media (max-width: 576px) {
            .tab-pane-card {
                padding: 0.75rem;
            }

            .row.g-3 {
                --bs-gutter-x: 0.75rem;
                --bs-gutter-y: 0.75rem;
            }

            .form-label {
                font-size: 0.75rem;
                margin-bottom: 0.25rem;
            }

            .btn {
                padding: 0.4rem 0.75rem;
                font-size: 0.85rem;
            }
        }

        .formula-card.is-collapsed {
            padding-bottom: 0.5rem;
        }

        .formula-card.is-collapsed .standard-view {
            display: none;
        }

        .formula-card .toggle-icon {
            transition: transform 0.3s ease;
            cursor: pointer;
            padding: 5px;
            border-radius: 50%;
        }

        .formula-card .toggle-icon:hover {
            background: var(--primary-soft);
        }

        .formula-card.is-collapsed .toggle-icon {
            transform: rotate(180deg);
        }

        /* Formula Truncation */
        .formula-box {
            background: #f8f9fa;
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1rem 1.25rem;
            font-size: 1.05rem;
            font-weight: 500;
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            align-items: center;
            min-height: 50px;
            margin-bottom: 0.5rem;
            line-height: 1.6;
            max-height: 54px;
            /* Approx 1 line + padding */
            overflow: hidden;
            position: relative;
            transition: max-height 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            padding-right: 50px;
            margin-bottom: 0.25rem;
            /* Space for the dots */
        }

        .formula-box.is-expanded {
            max-height: 1000px;
            padding-right: 1.25rem;
        }

        .formula-expand-btn {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            background: white;
            border: 1px solid var(--border);
            border-radius: 8px;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: var(--primary);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            transition: all 0.2s;
            z-index: 10;
        }

        .formula-box.is-expanded .formula-expand-btn {
            top: 10px;
            transform: none;
            background: var(--primary-soft);
        }

        .formula-expand-btn:hover {
            background: var(--primary);
            color: white;
        }

        .formula-operator {
            color: var(--primary);
            font-weight: 800;
            font-size: 0.85rem;
            text-transform: uppercase;
        }

        .formula-group {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 2px 6px;
            background: rgba(13, 110, 253, 0.03);
            border: 1px dashed rgba(13, 110, 253, 0.2);
            border-radius: 8px;
            margin: 0 2px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.8rem;
            margin-bottom: 2px;
        }

        .legend-badge {
            width: 20px;
            height: 20px;
            background: white;
            border: 1px solid var(--border);
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 800;
            font-size: 0.7rem;
            color: var(--primary);
        }

        /* Custom Filter Tabs */
        .custom-filter-tabs {
            background: #fff;
            padding: 8px 12px;
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            justify-content: flex-start;
            border: 1px solid var(--border) !important;
            border-radius: 18px;
            box-shadow: var(--shadow-sm);
        }

        .custom-filter-tabs .nav-item {
            flex: 0 1 auto;
        }

        .custom-filter-tabs .nav-link {
            white-space: nowrap;
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 8px 16px;
            border-radius: 12px;
            color: var(--text-muted);
            font-weight: 600;
            border: 1px solid transparent;
            transition: all 0.2s ease;
            background: transparent;
            font-size: 0.85rem;
        }

        .compact-control-card {
            background: #fff;
            border: 1px solid var(--border);
            border-radius: 18px;
            padding: 8px 12px;
            box-shadow: var(--shadow-sm);
        }

        .custom-filter-tabs::-webkit-scrollbar {
            height: 4px;
        }

        .custom-filter-tabs::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 10px;
        }

        .custom-filter-tabs .nav-link.active {
            background: var(--primary-soft) !important;
            color: var(--primary) !important;
            border-color: var(--primary-soft) !important;
            box-shadow: 0 4px 12px rgba(67, 97, 238, 0.1) !important;
            transform: translateY(-2px);
        }

        .custom-filter-tabs .nav-link:hover:not(.active) {
            background: var(--bg-app);
            color: var(--text-main);
            border-color: var(--border);
        }

        .tab-pane-card {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: var(--radius-card);
            padding: 1rem;
            animation: slideUpFade 0.4s ease-out;
            box-shadow: var(--shadow-card);
        }

        @keyframes slideUpFade {
            from {
                opacity: 0;
                transform: translateY(15px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }



        #filter-picker {
            position: absolute;
            z-index: 9999;
            background: white;
            border: 1px solid var(--border);
            border-radius: 14px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
            width: 320px;
            display: none;
            overflow: hidden;
            animation: slideIn 0.2s ease-out;
        }

        .picker-header {
            padding: 12px 15px;
            border-bottom: 1px solid var(--border);
            background: var(--bg-app);
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 700;
            font-size: 0.85rem;
        }

        .picker-step {
            padding: 0;
            max-height: 350px;
            overflow-y: auto;
        }

        .picker-item {
            padding: 10px 15px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 12px;
            transition: background 0.2s;
            border-bottom: 1px solid var(--bg-app);
            font-size: 0.85rem;
            color: var(--text-main);
        }

        .picker-item:hover {
            background: var(--primary-soft);
        }

        .picker-input-step {
            padding: 15px;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Multi-Select Dropdown Styles */
        .multi-select-btn {
            font-size: 0.85rem;
            padding: 8px 12px;
            height: auto;
        }

        .multi-select-dropdown .dropdown-item {
            font-size: 0.85rem;
            padding: 8px 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .multi-select-dropdown .dropdown-item:active {
            color: var(--text-main);
            background-color: var(--bg-app);
        }

        .multi-select-dropdown .form-check-input {
            margin: 0;
            cursor: pointer;
        }

        /* Pill Multi-Select Toggle */
        .pill-toggle-container {
            display: inline-flex;
            background: #eeeef2;
            padding: 3px;
            border-radius: 50px;
            gap: 2px;
            border: 1px solid rgba(0, 0, 0, 0.05);
        }

        .pill-toggle-item {
            cursor: pointer;
        }

        .pill-toggle-item .btn-check+label {
            border-radius: 50px;
            padding: 4px 14px;
            font-size: 0.7rem;
            font-weight: 700;
            color: #6c7a91;
            border: none;
            background: transparent;
            transition: all 0.25s ease;
            text-transform: none;
            line-height: 1.2;
        }

        .pill-toggle-item .btn-check:checked+label {
            background-color: var(--primary);
            color: white;
            box-shadow: 0 2px 8px rgba(67, 97, 238, 0.4);
        }

        .pill-toggle-item:hover .btn-check:not(:checked)+label {
            background-color: rgba(255, 255, 255, 0.5);
            color: var(--primary);
        }

        /* No scrollbar utility */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }

        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        /* Mobile Action Bar */
        @media (max-width: 991px) {
            .mobile-sticky-action {
                position: fixed;
                bottom: 0;
                left: 0;
                right: 0;
                background: var(--surface);
                padding: 0.75rem 1.25rem;
                display: flex;
                align-items: center;
                justify-content: space-between;
                box-shadow: 0 -5px 20px rgba(0, 0, 0, 0.1);
                z-index: 1050;
                border-top: 1px solid var(--border);
            }

            .mobile-sticky-action .counter-small {
                display: flex;
                flex-direction: column;
            }

            .mobile-sticky-action .counter-label {
                font-size: 0.6rem;
                text-transform: uppercase;
                color: var(--text-muted);
                font-weight: 700;
                margin-bottom: -2px;
            }

            .mobile-sticky-action .counter-val {
                font-size: 1.15rem;
                font-weight: 800;
                color: var(--primary);
            }

            body {
                padding-bottom: 75px !important;
                /* Space for sticky bar */
            }

            .sidebar-sticky .counter-box {
                display: none !important;
                /* Hide original in flow on mobile */
            }
        }

        @media (min-width: 992px) {
            .mobile-sticky-action {
                display: none !important;
            }
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <style>
        /* Design Mode Styles */
        .design-mode-active .tab-pane-card {
            border: 2px dashed #6366f1 !important;
            padding-top: 45px !important;
            position: relative;
            min-height: 150px;
        }

        .design-mode-active .tab-pane-card::before {
            content: "Зона редагування розділу";
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            background: #6366f1;
            color: white;
            font-size: 0.7rem;
            padding: 4px 12px;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .design-mode-active [data-field-id] {
            cursor: move;
            position: relative;
            outline: 1px dashed rgba(99, 102, 241, 0.4);
            border-radius: 12px;
            padding: 12px;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            background: rgba(255, 255, 255, 0.5);
        }

        .design-mode-active [data-field-id]:hover {
            outline: 2px solid #6366f1;
            background: white;
            z-index: 50;
            box-shadow: 0 10px 25px rgba(99, 102, 241, 0.15);
            transform: translateY(-2px);
        }

        /* Field Toolbar (Glassmorphism) */
        .field-edit-controls {
            display: none;
            position: absolute;
            top: -15px;
            right: 15px;
            background: rgba(15, 23, 42, 0.9);
            backdrop-filter: blur(8px);
            padding: 4px 12px;
            border-radius: 30px;
            gap: 12px;
            z-index: 100;
            align-items: center;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .design-mode-active [data-field-id]:hover .field-edit-controls {
            display: flex;
        }

        /* Improved Resize UI */
        .resize-handler-container {
            display: flex;
            align-items: center;
            gap: 6px;
            background: rgba(15, 23, 42, 0.6);
            backdrop-filter: blur(4px);
            padding: 4px 10px;
            border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.15);
            color: #94a3b8;
        }

        .resize-slider {
            -webkit-appearance: none;
            appearance: none;
            width: 80px;
            height: 4px;
            background: #334155;
            border-radius: 5px;
            outline: none;
            cursor: ew-resize;
        }

        .resize-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 14px;
            height: 14px;
            background: #6366f1;
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 0 10px rgba(99, 102, 241, 0.5);
        }

        .btn-design-action {
            background: none;
            border: none;
            color: #94a3b8;
            padding: 0;
            cursor: pointer;
            font-size: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: color 0.2s;
        }

        .btn-design-action:hover {
            color: #fff;
        }

        .btn-design-action.delete:hover {
            color: #f87171;
        }

        /* Tab Management */
        .add-tab-item {
            display: none;
            align-items: center;
            padding-left: 10px;
        }

        .design-mode-active .add-tab-item {
            display: flex;
        }

        .btn-add-tab {
            background: none;
            border: 2px dashed #6366f1;
            color: #6366f1;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            transition: all 0.2s;
        }

        .btn-add-tab:hover {
            background: rgba(99, 102, 241, 0.1);
            transform: scale(1.05);
        }

        .section-delete-btn {
            position: absolute;
            top: 10px;
            right: 15px;
            display: none;
            background: #ef4444;
            color: white;
            border: none;
            border-radius: 50%;
            width: 28px;
            height: 28px;
            font-size: 14px;
            z-index: 60;
            box-shadow: 0 4px 10px rgba(239, 68, 68, 0.3);
        }

        .design-mode-active .tab-pane-card:hover .section-delete-btn {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .design-mode-active .form-label {
            cursor: text;
        }

        .add-field-btn {
            border: 2px dashed #cbd5e1;
            border-radius: 12px;
            width: 100%;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 8px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            color: #64748b;
            background: transparent;
        }

        .add-field-btn:hover {
            border-color: #6366f1;
            color: #6366f1;
            background: rgba(99, 102, 241, 0.03);
            transform: translateY(-2px);
        }

        /* Toolbar */
        .design-toolbar {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(15, 23, 42, 0.95);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.15);
            padding: 12px 24px;
            border-radius: 60px;
            display: none;
            align-items: center;
            gap: 20px;
            z-index: 3000;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.4);
        }

        .design-mode-active .design-toolbar {
            display: flex;
        }

        .sortable-ghost {
            opacity: 0.3;
            background: #6366f1 !important;
            border-radius: 12px;
        }

        .design-mode-active .nav-item {
            cursor: grab;
        }

        .design-mode-active .nav-item:active {
            cursor: grabbing;
        }

        #map-container {
            height: 400px;
            border-radius: 12px;
            overflow: hidden;
            margin-bottom: 1rem;
        }
    </style>
</head>

<body>
    <!-- Mobile Sticky Action Bar -->
    <div class="mobile-sticky-action">
        <div class="counter-small">
            <span class="counter-label">Знайдено</span>
            <span class="counter-val" id="mobile-counter-display">24.5M</span>
        </div>
        <button class="btn btn-primary d-flex align-items-center gap-2" onclick="handleSmartExecute()">
            <i class="bi bi-play-circle-fill"></i>
            <span>Розрахувати</span>
        </button>
    </div>

    <header class="app-header">
        <div class="container-fluid px-4">
            <div class="d-flex justify-content-between align-items-center">
                <div class="d-flex align-items-center gap-3">
                    <div class="bg-primary text-white rounded-circle d-flex align-items-center justify-content-center"
                        style="width:40px; height:40px; box-shadow: 0 5px 15px rgba(67,97,238,0.3);">
                        <i class="bi bi-layers-fill"></i>
                    </div>
                    <h4 class="mb-0 fw-bold" style="color: var(--text-main);">Конструктор вибірок</h4>
                </div>

                <div class="header-main-row flex-grow-1 d-flex justify-content-center">
                    <ul class="nav nav-pills d-inline-flex border p-1 rounded-3 gap-1" id="app-views-nav"
                        style="background: var(--surface); border-color: var(--border) !important;">
                        <li class="nav-item">
                            <button class="nav-link active px-3 rounded-3 d-flex align-items-center gap-2 fw-medium"
                                id="nav-btn-constructor" onclick="switchView('constructor')">
                                <i class="bi bi-sliders"></i> Конструктор
                            </button>
                        </li>
                        <li class="nav-item">
                            <button class="nav-link px-3 rounded-3 d-flex align-items-center gap-2 fw-medium"
                                id="nav-btn-lookalike" onclick="switchView('lookalike')">
                                <i class="bi bi-people"></i> Look-a-like
                            </button>
                        </li>
                        <li class="nav-item">
                            <button class="nav-link px-3 rounded-3 d-flex align-items-center gap-2 fw-medium"
                                id="nav-btn-ai" onclick="switchView('ai')">
                                <i class="bi bi-stars"></i> AI Помічник
                            </button>
                        </li>
                    </ul>
                </div>



                <div class="d-flex align-items-center gap-3">
                    <!-- Theme Toggle -->
                    <button class="btn btn-outline-secondary border-0 p-2" onclick="toggleTheme()"
                        title="Перемикач теми">
                        <i class="bi bi-moon-stars-fill" id="theme-icon"></i>
                    </button>

                    <!-- My Segments (New Location) -->
                    <div class="dropdown">
                        <button class="btn btn-outline-primary border-0 p-2 position-relative" type="button"
                            data-bs-toggle="dropdown" data-bs-auto-close="outside" title="Мої сегменти">
                            <i class="bi bi-bookmark-star-fill fs-4"></i>
                            <span
                                class="position-absolute top-0 start-100 translate-middle p-1 bg-danger border border-light rounded-circle"
                                id="segments-badge" style="display:none">
                                <span class="visually-hidden">New alerts</span>
                            </span>
                        </button>
                        <ul class="dropdown-menu dropdown-menu-end shadow border-0 p-3"
                            style="width: 320px; max-height: 400px; overflow-y: auto;">
                            <li>
                                <h6 class="dropdown-header text-uppercase text-muted fw-bold small mb-2">Мої збережені
                                    сегменти</h6>
                            </li>
                            <div id="header-saved-segments-list" class="vstack gap-2">
                                <!-- Dynamic List -->
                                <div class="text-center text-muted small py-3">Немає збережених сегментів</div>
                            </div>
                            <li class="mt-2 text-center">
                                <button class="btn btn-sm btn-primary w-100 rounded-pill"
                                    onclick="saveCurrentSegment()">
                                    <i class="bi bi-plus-lg me-1"></i>Зберегти поточний
                                </button>
                            </li>
                            <li>
                                <hr class="dropdown-divider mt-2">
                            </li>
                            <li>
                                <h6 class="dropdown-header text-uppercase text-muted fw-bold small mb-2">Мої
                                    автоматизації</h6>
                            </li>
                            <div id="header-saved-automations-list" class="vstack gap-2">
                                <!-- Dynamic List -->
                                <div class="text-center text-muted small py-3">Немає активних автоматизацій</div>
                            </div>
                        </ul>
                    </div>

                    <!-- Profile -->
                    <div class="dropdown">
                        <button class="btn btn-outline-secondary border-0 p-2" type="button" data-bs-toggle="dropdown">
                            <i class="bi bi-person-circle fs-3 text-secondary"></i>
                        </button>
                        <ul class="dropdown-menu dropdown-menu-end shadow border-0">
                            <li><a class="dropdown-item" href="#">Профіль</a></li>
                            <li><a class="dropdown-item" href="#">Налаштування</a></li>
                            <li><a class="dropdown-item d-flex align-items-center gap-2" href="javascript:void(0)"
                                    onclick="toggleDesignMode()">
                                    <i class="bi bi-palette text-primary"></i> Режим дизайну
                                </a></li>
                            <li><a class="dropdown-item d-flex align-items-center gap-2" href="javascript:void(0)"
                                    onclick="saveDesignChanges()">
                                    <i class="bi bi-download text-success"></i> Вивантажити JSON
                                </a></li>
                            <li><a class="dropdown-item d-flex align-items-center gap-2 text-warning"
                                    href="javascript:void(0)" onclick="resetDesign()">
                                    <i class="bi bi-arrow-counterclockwise"></i> Скинути дизайн
                                </a></li>
                            <li>
                                <hr class="dropdown-divider">
                            </li>
                            <li><a class="dropdown-item text-danger" href="#">Вихід</a></li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <div class="container-fluid px-3 py-3">
        <div class="row g-3">

            <!-- Main Content Area -->
            <div class="col-lg-9">

                <!-- VIEW 1: CONSTRUCTOR -->
                <div id="view-constructor" class="view-section">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5 class="fw-bold mb-0">Фільтри сегментації</h5>
                        <button class="btn btn-sm btn-outline-danger btn-light border-0 text-danger"
                            onclick="clearFilters()">
                            <i class="bi bi-trash3 me-1"></i>Скинути все
                        </button>
                    </div>

                    <!-- Improved Active Filters Area (Legacy + Formula Support) -->
                    <div id="active-filters-summary" class="mb-3">
                        <div class="formula-card is-collapsed" id="main-formula-card">
                            <div class="d-flex align-items-center justify-content-between mb-2" style="cursor: pointer;"
                                onclick="toggleFormulaCard()">
                                <div class="d-flex align-items-center gap-2">
                                    <i class="bi bi-funnel text-primary fs-5"></i>
                                    <h6 class="fw-bold mb-0">ПОТОЧНА ФОРМУЛА:</h6>
                                </div>
                                <i class="bi bi-chevron-up toggle-icon" id="formula-toggle-icon"></i>
                            </div>

                            <div class="formula-content-wrapper">
                                <div id="formula-filters-view" class="mb-2">
                                    <div class="formula-box" id="formula-display" style="display:none;"></div>
                                </div>

                                <!-- Espo-style Hierarchical View -->
                                <div id="standard-filters-view" class="standard-view px-2">
                                    <div id="filters-blocks-container">
                                        <div class="section-title-row">
                                            <div class="section-title-espo text-primary"
                                                onclick="openFilterPicker('Include', event)">
                                                <i class="bi bi-plus-circle-fill"></i> Включити
                                            </div>
                                        </div>
                                        <div id="espo-include-list"></div>

                                        <div class="section-title-row">
                                            <div class="section-title-espo text-danger"
                                                onclick="openFilterPicker('Exclude', event)">
                                                <i class="bi bi-dash-circle-fill"></i> Виключити
                                            </div>
                                        </div>
                                        <div id="espo-exclude-list"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="sticky-controls-wrapper">
                        <div class="compact-control-card p-1">
                            <!-- Tabs Area (Now Wrapping, no scroll) -->
                            <div class="px-2 pt-1">
                                <ul class="nav nav-pills custom-filter-tabs border-0 shadow-none p-0 flex-wrap"
                                    id="filterTabs" role="tablist">
                                    <li class="nav-item">
                                        <button class="nav-link active" id="tab-c1" data-bs-toggle="pill"
                                            data-bs-target="#pane-c1" type="button" role="tab"><i
                                                class="bi bi-box-seam"></i> Параметри ЕН</button>
                                    </li>
                                    <li class="nav-item">
                                        <button class="nav-link" id="tab-c2" data-bs-toggle="pill"
                                            data-bs-target="#pane-c2" type="button" role="tab"><i
                                                class="bi bi-people-fill"></i> Відправник та Отримувач</button>
                                    </li>
                                    <li class="nav-item">
                                        <button class="nav-link" id="tab-c3" data-bs-toggle="pill"
                                            data-bs-target="#pane-c3" type="button" role="tab"><i
                                                class="bi bi-cash-stack"></i> Фінанси</button>
                                    </li>
                                    <li class="nav-item">
                                        <button class="nav-link" id="tab-c4" data-bs-toggle="pill"
                                            data-bs-target="#pane-c4" type="button" role="tab"><i
                                                class="bi bi-person-vcard"></i> Профіль та Маркетинг</button>
                                    </li>
                                    <li class="nav-item">
                                        <button class="nav-link" id="tab-c8" data-bs-toggle="pill"
                                            data-bs-target="#pane-c8" type="button" role="tab"><i
                                                class="bi bi-shield-check"></i> Верифікація</button>
                                    </li>
                                    <li class="nav-item">
                                        <button class="nav-link" id="tab-c5" data-bs-toggle="pill"
                                            data-bs-target="#pane-c5" type="button" role="tab"><i
                                                class="bi bi-activity"></i> Активність та Локації</button>
                                    </li>
                                    <li class="nav-item">
                                        <button class="nav-link" id="tab-c9" data-bs-toggle="pill"
                                            data-bs-target="#pane-c9" type="button" role="tab"><i
                                                class="bi bi-exclamation-triangle"></i> Проблеми та Додатково</button>
                                    </li>
                                    <li class="nav-item">
                                        <button class="nav-link" id="tab-c6" data-bs-toggle="pill"
                                            data-bs-target="#pane-c6" type="button" role="tab"><i
                                                class="bi bi-phone"></i> Додаток та Пристрої</button>
                                    </li>
                                    <li class="nav-item">
                                        <button class="nav-link" id="tab-c7" data-bs-toggle="pill"
                                            data-bs-target="#pane-c7" type="button" role="tab"><i
                                                class="bi bi-check-circle"></i> Згоди та Комунікація</button>
                                    </li>
                                    <li class="nav-item">
                                        <button class="nav-link" id="tab-c10" data-bs-toggle="pill"
                                            data-bs-target="#pane-c10" type="button" role="tab"><i
                                                class="bi bi-geo-alt"></i> Гео-мапа</button>
                                    </li>
                                </ul>
                            </div>

                            <!-- Separate Mode Selector Block -->
                            <div class="d-flex align-items-center px-3 py-2 border-top bg-light-subtle rounded-bottom"
                                style="gap: 15px;">
                                <div class="d-flex align-items-center gap-2">
                                    <i class="bi bi-gear-wide-connected text-primary small"></i>
                                    <span class="fw-bold text-muted text-uppercase"
                                        style="font-size: 0.65rem; letter-spacing: 0.5px;">Логіка додавання:</span>
                                </div>
                                <div class="position-relative d-inline-flex bg-white rounded-pill p-1 border shadow-sm">
                                    <input type="radio" class="btn-check" name="global-filter-mode" id="mode-include"
                                        value="Include" checked onchange="window.currentFilterMode='Include'">
                                    <label class="btn btn-sm rounded-pill px-3 fw-bold mode-label"
                                        for="mode-include">Включити</label>

                                    <input type="radio" class="btn-check" name="global-filter-mode" id="mode-exclude"
                                        value="Exclude" onchange="window.currentFilterMode='Exclude'">
                                    <label class="btn btn-sm rounded-pill px-3 fw-bold mode-label"
                                        for="mode-exclude">Виключити</label>

                                    <style>
                                        .mode-label {
                                            color: #6c7a91;
                                            font-size: 0.65rem;
                                            padding: 4px 12px !important;
                                            transition: all 0.2s ease-in-out;
                                            border: none !important;
                                            text-transform: uppercase;
                                        }

                                        #mode-include:checked+label {
                                            background-color: var(--primary);
                                            color: white;
                                            box-shadow: 0 2px 6px rgba(67, 97, 238, 0.3);
                                        }

                                        #mode-exclude:checked+label {
                                            background-color: #ef4444;
                                            color: white;
                                            box-shadow: 0 2px 6px rgba(239, 68, 68, 0.3);
                                        }
                                    </style>
                                </div>
                                <div class="ms-auto small text-muted font-monospace" style="font-size: 0.65rem;">
                                    Конструктор v2.4
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="tab-content mt-3" id="filterTabsContent">
                        <!-- 1. Параметри ЕН -->
                        <div class="tab-pane fade show active" id="pane-c1" role="tabpanel">
                            <div class="tab-pane-card">
                                <div class="row g-3">
                                    <div class="col-md-4" data-field-id="Role">
                                        <label class="form-label">Роль в ЕН</label>
                                        <select class="form-select" onchange="addTag(this, 'Role')">
                                            <option value="">...</option>
                                            <option value="Sender">Відправник</option>
                                            <option value="Recipient">Отримувач</option>
                                            <option value="ThirdPerson">Третя особа</option>
                                        </select>
                                    </div>
                                    <div class="col-md-4" data-field-id="ServiceType">
                                        <label class="form-label">Тип сервісу</label>
                                        <select class="form-select" onchange="addTag(this, 'ServiceType')">
                                            <option value="">...</option>
                                            <option value="WarehouseWarehouse">Відділення-Відділення</option>
                                            <option value="WarehouseDoors">Відділення-Адреса</option>
                                            <option value="DoorsWarehouse">Адреса-Відділення</option>
                                            <option value="DoorsDoors">Адреса-Адреса</option>
                                        </select>
                                    </div>
                                    <div class="col-md-4" data-field-id="Payer">
                                        <label class="form-label">Платник</label>
                                        <select class="form-select" onchange="addTag(this, 'Payer')">
                                            <option value="">...</option>
                                            <option value="Sender">Відправник</option>
                                            <option value="Recipient">Отримувач</option>
                                            <option value="ThirdPerson">Третя особа</option>
                                        </select>
                                    </div>
                                    <div class="col-md-6" data-field-id="Category1">
                                        <label class="form-label">Категорія 1 рівень</label>
                                        <select class="form-select" onchange="addTag(this, 'Category1')">
                                            <option value="">...</option>
                                        </select>
                                    </div>
                                    <div class="col-md-6" data-field-id="Category2">
                                        <label class="form-label">Категорія 2 рівень</label>
                                        <select class="form-select" onchange="addTag(this, 'Category2')">
                                            <option value="">...</option>
                                        </select>
                                    </div>

                                    <div class="col-md-6" data-field-id="DateCreated">
                                        <div class="d-flex justify-content-between align-items-center mb-1">
                                            <label class="form-label mb-0">Дата створення ЕН</label>
                                            <div
                                                class="form-check form-switch min-h-0 mb-0 d-flex align-items-center gap-1">
                                                <input class="form-check-input" type="checkbox" id="c1-date-start-all"
                                                    style="transform: scale(0.8);"
                                                    onchange="toggleRangeAll('c1-date-start', this.checked)">
                                                <label class="form-check-label text-muted small"
                                                    for="c1-date-start-all">&infin;</label>
                                            </div>
                                        </div>
                                        <div class="input-group">
                                            <input type="date" class="form-control px-2" id="c1-date-start-from">
                                            <span class="input-group-text bg-light px-1"
                                                style="font-size: 0.7rem;">по</span>
                                            <input type="date" class="form-control px-2" id="c1-date-start-to">
                                            <button class="btn btn-outline-primary px-2" type="button"
                                                onclick="addRangeTag('DateCreated', 'Створення ЕН', 'c1-date-start-from', 'c1-date-start-to')">
                                                <i class="bi bi-plus"></i>
                                            </button>
                                        </div>
                                    </div>
                                    <div class="col-md-6" data-field-id="DateClosed">
                                        <div class="d-flex justify-content-between align-items-center mb-1">
                                            <label class="form-label mb-0">Дата закриття ЕН</label>
                                            <div
                                                class="form-check form-switch min-h-0 mb-0 d-flex align-items-center gap-1">
                                                <input class="form-check-input" type="checkbox" id="c1-date-end-all"
                                                    style="transform: scale(0.8);"
                                                    onchange="toggleRangeAll('c1-date-end', this.checked)">
                                                <label class="form-check-label text-muted small"
                                                    for="c1-date-end-all">&infin;</label>
                                            </div>
                                        </div>
                                        <div class="input-group">
                                            <input type="date" class="form-control px-2" id="c1-date-end-from">
                                            <span class="input-group-text bg-light px-1"
                                                style="font-size: 0.7rem;">по</span>
                                            <input type="date" class="form-control px-2" id="c1-date-end-to">
                                            <button class="btn btn-outline-primary px-2" type="button"
                                                onclick="addRangeTag('DateClosed', 'Закриття ЕН', 'c1-date-end-from', 'c1-date-end-to')">
                                                <i class="bi bi-plus"></i>
                                            </button>
                                        </div>
                                    </div>
                                    <div class="col-md-4" data-field-id="CreatedPlace">
                                        <label class="form-label">Місце створення</label>
                                        <select class="form-select" onchange="addTag(this, 'CreatedPlace')">
                                            <option value="">...</option>
                                            <option value="App">Додаток</option>
                                            <option value="API">API</option>
                                            <option value="Branch">Відділення</option>
                                        </select>
                                    </div>
                                    <div class="col-md-4" data-field-id="CreatedType">
                                        <label class="form-label">Тип місця створення</label>
                                        <select class="form-select" onchange="addTag(this, 'CreatedType')">
                                            <option value="">...</option>
                                            <option value="Static">Стаціонарне</option>
                                            <option value="Mobile">Мобільне</option>
                                        </select>
                                    </div>
                                    <div class="col-md-4" data-field-id="LastServicePointType">
                                        <label class="form-label">Тип ост. точки обслуг.</label>
                                        <select class="form-select" onchange="addTag(this, 'LastServicePointType')">
                                            <option value="">...</option>
                                            <option value="Branch">Відділення</option>
                                            <option value="Postomat">Поштомат</option>
                                            <option value="Address">Адреса</option>
                                        </select>
                                    </div>
                                    <div class="col-md-4" data-field-id="Import">
                                        <label class="form-label">Імпорт</label>
                                        <select class="form-select" onchange="addTag(this, 'Import')">
                                            <option value="">...</option>
                                            <option value="Yes">Так</option>
                                            <option value="No">Ні</option>
                                        </select>
                                    </div>
                                    <div class="col-md-4" data-field-id="Export">
                                        <label class="form-label">Експорт</label>
                                        <select class="form-select" onchange="addTag(this, 'Export')">
                                            <option value="">...</option>
                                            <option value="Yes">Так</option>
                                            <option value="No">Ні</option>
                                        </select>
                                    </div>
                                    <div class="col-md-4" data-field-id="SecondaryEN">
                                        <label class="form-label">Вторинні ЕН</label>
                                        <select class="form-select" onchange="addTag(this, 'SecondaryEN')">
                                            <option value="">...</option>
                                            <option value="Yes">Так</option>
                                            <option value="No">Ні</option>
                                        </select>
                                    </div>

                                    <div class="col-md-4" data-field-id="CargoType">
                                        <label class="form-label">Тип вантажу</label>
                                        <select class="form-select" onchange="addTag(this, 'CargoType')">
                                            <option value="">...</option>
                                            <option value="Parcel">Посилки</option>
                                            <option value="Documents">Документи</option>
                                            <option value="Pallet">Палети</option>
                                            <option value="Cargo">Вантаж</option>
                                        </select>
                                    </div>
                                    <div class="col-md-8" data-field-id="CargoDesc">
                                        <div class="d-flex justify-content-between align-items-center mb-1">
                                            <label class="form-label mb-0">Опис вантажу</label>
                                            <div class="position-relative d-flex align-items-center">
                                                <select
                                                    class="form-select form-select-sm w-auto py-0 border-0 bg-transparent text-primary fw-bold shadow-none pe-4"
                                                    id="cargo-search-mode"
                                                    style="font-size: 0.65rem; height: 18px; cursor: pointer; -webkit-appearance: none; -moz-appearance: none; appearance: none; background: none !important;">
                                                    <option value="EXACT">ТОЧНЕ</option>
                                                    <option value="LIKE" selected>МІСТИТЬ</option>
                                                    <option value="STARTS_WITH">ПОЧИНАЄТЬСЯ З</option>
                                                    <option value="ENDS_WITH">ЗАКІНЧУЄТЬСЯ НА</option>
                                                </select>
                                                <i class="bi bi-chevron-down text-primary position-absolute end-0"
                                                    style="font-size: 0.6rem; pointer-events: none;"></i>
                                            </div>
                                        </div>
                                        <div class="input-group">
                                            <input type="text" class="form-control" id="cargo-desc-input"
                                                placeholder="Наприклад: взуття, запчастини, косметика"
                                                onkeydown="if(event.key==='Enter') addTextTag(this, 'CargoDesc')">
                                            <button class="btn btn-outline-primary px-2" type="button"
                                                onclick="addTextTag(document.getElementById('cargo-desc-input'), 'CargoDesc')">
                                                <i class="bi bi-plus"></i>
                                            </button>
                                        </div>
                                    </div>
                                    <div class="col-md-6" data-field-id="Weight">
                                        <div class="d-flex justify-content-between align-items-center mb-1">
                                            <label class="form-label mb-0">Вага (розрахункова)</label>
                                            <div
                                                class="form-check form-switch min-h-0 mb-0 d-flex align-items-center gap-1">
                                                <input class="form-check-input" type="checkbox" id="c1-weight-all"
                                                    style="transform: scale(0.8);"
                                                    onchange="toggleRangeAll('c1-weight', this.checked)">
                                                <label class="form-check-label text-muted small"
                                                    for="c1-weight-all">&infin;</label>
                                            </div>
                                        </div>
                                        <div class="input-group">
                                            <input type="number" class="form-control px-2" id="c1-weight-from">
                                            <span class="input-group-text bg-light px-1"
                                                style="font-size: 0.7rem;">по</span>
                                            <input type="number" class="form-control px-2" id="c1-weight-to">
                                            <button class="btn btn-outline-primary px-2" type="button"
                                                onclick="addRangeTag('Weight', 'Вага', 'c1-weight-from', 'c1-weight-to')">
                                                <i class="bi bi-plus"></i>
                                            </button>
                                        </div>
                                    </div>
                                    <div class="col-md-6" data-field-id="DeclaredValue">
                                        <div class="d-flex justify-content-between align-items-center mb-1">
                                            <label class="form-label mb-0">Оголошена вартість</label>
                                            <div
                                                class="form-check form-switch min-h-0 mb-0 d-flex align-items-center gap-1">
                                                <input class="form-check-input" type="checkbox" id="c1-val-all"
                                                    style="transform: scale(0.8);"
                                                    onchange="toggleRangeAll('c1-val', this.checked)">
                                                <label class="form-check-label text-muted small"
                                                    for="c1-val-all">&infin;</label>
                                            </div>
                                        </div>
                                        <div class="input-group">
                                            <input type="number" class="form-control px-2" id="c1-val-from">
                                            <span class="input-group-text bg-light px-1"
                                                style="font-size: 0.7rem;">по</span>
                                            <input type="number" class="form-control px-2" id="c1-val-to">
                                            <button class="btn btn-outline-primary px-2" type="button"
                                                onclick="addRangeTag('DeclaredValue', 'Огол. вартість', 'c1-val-from', 'c1-val-to')">
                                                <i class="bi bi-plus"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>


                        <!-- 2. Відправник та Отримувач -->
                        <div class="tab-pane fade" id="pane-c2" role="tabpanel">
                            <div class="tab-pane-card">
                                <h6 class="fw-bold text-primary mb-3 text-uppercase small" style="letter-spacing: 1px;">
                                    ВІДПРАВНИК</h6>
                                <div class="row g-3 mb-4">
                                    <div class="col-md-4" data-field-id="SenderType">
                                        <label class="form-label">Тип відправника</label>
                                        <select class="form-select" onchange="addTag(this, 'SenderType')">
                                            <option value="">...</option>
                                            <option value="Private">Приватна особа</option>
                                            <option value="Business">Бізнес</option>
                                        </select>
                                    </div>
                                    <div class="col-md-4" data-field-id="SenderEDRPOU">
                                        <label class="form-label">ЄРПОУ відправника</label>
                                        <input type="text" class="form-control" placeholder="Наприклад: 12345678"
                                            onchange="addTextTag(this, 'SenderEDRPOU')">
                                    </div>
                                    <div class="col-md-4" data-field-id="SenderUnitType">
                                        <label class="form-label">Тип підрозділу відправника</label>
                                        <select class="form-select" onchange="addTag(this, 'SenderUnitType')">
                                            <option value="">...</option>
                                            <option value="Branch">Відділення</option>
                                            <option value="Postomat">Поштомат</option>
                                        </select>
                                    </div>
                                    <div class="col-md-4" data-field-id="SenderArea">
                                        <label class="form-label">Область відправника</label>
                                        <input type="text" class="form-control" placeholder="Обери область..."
                                            onchange="addTextTag(this, 'SenderArea')">
                                    </div>
                                    <div class="col-md-4" data-field-id="SenderCity">
                                        <label class="form-label">Місто відправника</label>
                                        <input type="text" class="form-control" placeholder="Обери місто..."
                                            onchange="addTextTag(this, 'SenderCity')">
                                    </div>
                                    <div class="col-md-4" data-field-id="SenderUnit">
                                        <label class="form-label">Підрозділ відправника</label>
                                        <input type="text" class="form-control" placeholder="Обери підрозділ..."
                                            onchange="addTextTag(this, 'SenderUnit')">
                                    </div>
                                </div>

                                <h6 class="fw-bold text-primary mb-3 text-uppercase small" style="letter-spacing: 1px;">
                                    ОТРИМУВАЧ</h6>
                                <div class="row g-3">
                                    <div class="col-md-4" data-field-id="RecipientType">
                                        <label class="form-label">Тип отримувача</label>
                                        <select class="form-select" onchange="addTag(this, 'RecipientType')">
                                            <option value="">...</option>
                                            <option value="Private">Приватна особа</option>
                                            <option value="Business">Бізнес</option>
                                        </select>
                                    </div>
                                    <div class="col-md-4" data-field-id="RecipientEDRPOU">
                                        <label class="form-label">ЄРПОУ отримувача</label>
                                        <input type="text" class="form-control" placeholder="Наприклад: 12345678"
                                            onchange="addTextTag(this, 'RecipientEDRPOU')">
                                    </div>
                                    <div class="col-md-4" data-field-id="RecipientUnitType">
                                        <label class="form-label">Тип підрозділу отримувача</label>
                                        <select class="form-select" onchange="addTag(this, 'RecipientUnitType')">
                                            <option value="">...</option>
                                            <option value="Branch">Відділення</option>
                                            <option value="Postomat">Поштомат</option>
                                        </select>
                                    </div>
                                    <div class="col-md-4" data-field-id="RecipientArea">
                                        <label class="form-label">Область отримувача</label>
                                        <input type="text" class="form-control" placeholder="Обери область..."
                                            onchange="addTextTag(this, 'RecipientArea')">
                                    </div>
                                    <div class="col-md-4" data-field-id="RecipientCity">
                                        <label class="form-label">Місто отримувача</label>
                                        <input type="text" class="form-control" placeholder="Обери місто..."
                                            onchange="addTextTag(this, 'RecipientCity')">
                                    </div>
                                    <div class="col-md-4" data-field-id="RecipientUnit">
                                        <label class="form-label">Підрозділ отримувача</label>
                                        <input type="text" class="form-control" placeholder="Обери підрозділ..."
                                            onchange="addTextTag(this, 'RecipientUnit')">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 3. Фінанси -->
                        <div class="tab-pane fade" id="pane-c3" role="tabpanel">
                            <div class="tab-pane-card">
                                <h6 class="fw-bold text-primary mb-3 text-uppercase small" style="letter-spacing: 1px;">
                                    ФІНАНСОВІ ПАРАМЕТРИ</h6>
                                <div class="row g-3">
                                    <div class="col-md-4" data-field-id="PayType">
                                        <label class="form-label">Тип оплати</label>
                                        <select class="form-select" onchange="addTag(this, 'PayType')">
                                            <option value="">...</option>
                                            <option value="Cash">Готівка</option>
                                            <option value="NonCash">Безготівка</option>
                                            <option value="Card">Картка</option>
                                        </select>
                                    </div>
                                    <div class="col-md-4" data-field-id="DeliverySum">
                                        <div class="d-flex justify-content-between align-items-center mb-1">
                                            <label class="form-label mb-0">Сума за доставку</label>
                                            <div
                                                class="form-check form-switch min-h-0 mb-0 d-flex align-items-center gap-1">
                                                <input class="form-check-input" type="checkbox" id="c3-deliv-all"
                                                    style="transform: scale(0.8);"
                                                    onchange="toggleRangeAll('c3-deliv', this.checked)">
                                                <label class="form-check-label text-muted small"
                                                    for="c3-deliv-all">&infin;</label>
                                            </div>
                                        </div>
                                        <div class="input-group">
                                            <input type="number" class="form-control px-2" id="c3-deliv-from">
                                            <span class="input-group-text bg-light px-1"
                                                style="font-size: 0.7rem;">по</span>
                                            <input type="number" class="form-control px-2" id="c3-deliv-to">
                                            <button class="btn btn-outline-primary px-2" type="button"
                                                onclick="addRangeTag('DeliverySum', 'Сума за дост.', 'c3-deliv-from', 'c3-deliv-to')">
                                                <i class="bi bi-plus"></i>
                                            </button>
                                        </div>
                                    </div>
                                    <div class="col-md-4" data-field-id="PackingSum">
                                        <div class="d-flex justify-content-between align-items-center mb-1">
                                            <label class="form-label mb-0">Сума за пакування</label>
                                            <div
                                                class="form-check form-switch min-h-0 mb-0 d-flex align-items-center gap-1">
                                                <input class="form-check-input" type="checkbox" id="c3-pack-all"
                                                    style="transform: scale(0.8);"
                                                    onchange="toggleRangeAll('c3-pack', this.checked)">
                                                <label class="form-check-label text-muted small"
                                                    for="c3-pack-all">&infin;</label>
                                            </div>
                                        </div>
                                        <div class="input-group">
                                            <input type="number" class="form-control px-2" id="c3-pack-from">
                                            <span class="input-group-text bg-light px-1"
                                                style="font-size: 0.7rem;">по</span>
                                            <input type="number" class="form-control px-2" id="c3-pack-to">
                                            <button class="btn btn-outline-primary px-2" type="button"
                                                onclick="addRangeTag('PackingSum', 'Сума за пак.', 'c3-pack-from', 'c3-pack-to')">
                                                <i class="bi bi-plus"></i>
                                            </button>
                                        </div>
                                    </div>
                                    <div class="col-md-4" data-field-id="TransferAvailability">
                                        <label class="form-label">Наявність переказу</label>
                                        <select class="form-select" onchange="addTag(this, 'TransferAvailability')">
                                            <option value="">...</option>
                                            <option value="Yes">Так</option>
                                            <option value="No">Ні</option>
                                        </select>
                                    </div>
                                    <div class="col-md-8" data-field-id="TransferSum">
                                        <div class="d-flex justify-content-between align-items-center mb-1">
                                            <label class="form-label mb-0">Сума переказу</label>
                                            <div
                                                class="form-check form-switch min-h-0 mb-0 d-flex align-items-center gap-1">
                                                <input class="form-check-input" type="checkbox" id="c3-trans-all"
                                                    style="transform: scale(0.8);"
                                                    onchange="toggleRangeAll('c3-trans', this.checked)">
                                                <label class="form-check-label text-muted small"
                                                    for="c3-trans-all">&infin;</label>
                                            </div>
                                        </div>
                                        <div class="input-group">
                                            <input type="number" class="form-control px-2" id="c3-trans-from">
                                            <span class="input-group-text bg-light px-1"
                                                style="font-size: 0.7rem;">по</span>
                                            <input type="number" class="form-control px-2" id="c3-trans-to">
                                            <button class="btn btn-outline-primary px-2" type="button"
                                                onclick="addRangeTag('TransferSum', 'Сума переказу', 'c3-trans-from', 'c3-trans-to')">
                                                <i class="bi bi-plus"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 4. Профіль та Маркетинг -->
                        <div class="tab-pane fade" id="pane-c4" role="tabpanel">
                            <div class="tab-pane-card">
                                <h6 class="fw-bold text-primary mb-3 text-uppercase small" style="letter-spacing: 1px;">
                                    ОСНОВНІ ТА ГЕО ДАНІ</h6>
                                <div class="row g-3 mb-4">
                                    <div class="col-md-4" data-field-id="ClientNPU">
                                        <label class="form-label">Клієнт НПУ</label>
                                        <select class="form-select" onchange="addTag(this, 'ClientNPU')">
                                            <option value="">...</option>
                                            <option value="Yes">Так</option>
                                            <option value="No">Ні</option>
                                        </select>
                                    </div>
                                    <div class="col-md-4" data-field-id="ClientCountry">
                                        <label class="form-label">Країна клієнта</label>
                                        <select class="form-select" onchange="addTag(this, 'ClientCountry')">
                                            <option value="">...</option>
                                            <option value="UA">Україна</option>
                                            <option value="PL">Польща</option>
                                            <option value="MD">Молдова</option>
                                        </select>
                                    </div>
                                    <div class="col-md-4" data-field-id="Gender">
                                        <label class="form-label">Стать</label>
                                        <select class="form-select" onchange="addTag(this, 'Gender')">
                                            <option value="">...</option>
                                            <option value="M">Чоловіча</option>
                                            <option value="F">Жіноча</option>
                                        </select>
                                    </div>
                                    <div class="col-md-8" data-field-id="Birthday">
                                        <div class="d-flex justify-content-between align-items-center mb-1">
                                            <label class="form-label mb-0">День народження</label>
                                            <div
                                                class="form-check form-switch min-h-0 mb-0 d-flex align-items-center gap-1">
                                                <input class="form-check-input" type="checkbox" id="c4-bday-all"
                                                    style="transform: scale(0.8);"
                                                    onchange="toggleRangeAll('c4-bday', this.checked)">
                                                <label class="form-check-label text-muted small"
                                                    for="c4-bday-all">&infin;</label>
                                            </div>
                                        </div>
                                        <div class="input-group">
                                            <input type="date" class="form-control px-2" id="c4-bday-from">
                                            <span class="input-group-text bg-light px-1"
                                                style="font-size: 0.7rem;">по</span>
                                            <input type="date" class="form-control px-2" id="c4-bday-to">
                                            <button class="btn btn-outline-primary px-2" type="button"
                                                onclick="addRangeTag('Birthday', 'День народження', 'c4-bday-from', 'c4-bday-to')">
                                                <i class="bi bi-plus"></i>
                                            </button>
                                        </div>
                                    </div>
                                    <div class="col-md-4" data-field-id="AddPhoneAvailability">
                                        <label class="form-label">Наявність додатк. телефону</label>
                                        <select class="form-select" onchange="addTag(this, 'AddPhoneAvailability')">
                                            <option value="">...</option>
                                            <option value="Yes">Так</option>
                                            <option value="No">Ні</option>
                                        </select>
                                    </div>
                                </div>

                                <h6 class="fw-bold text-primary mb-3 text-uppercase small" style="letter-spacing: 1px;">
                                    МАРКЕТИНГОВИЙ ПРОФІЛЬ</h6>
                                <div class="row g-3">
                                    <div class="col-md-3" data-field-id="AgeGroup">
                                        <label class="form-label">Вікова група</label>
                                        <select class="form-select" onchange="addTag(this, 'AgeGroup')">
                                            <option value="">...</option>
                                            <option value="18-25">18-25</option>
                                            <option value="26-35">26-35</option>
                                            <option value="36-45">36-45</option>
                                            <option value="46-55">46-55</option>
                                            <option value="55+">55+</option>
                                        </select>
                                    </div>
                                    <div class="col-md-3" data-field-id="Lead">
                                        <label class="form-label">Лід</label>
                                        <select class="form-select" onchange="addTag(this, 'Lead')">
                                            <option value="">...</option>
                                            <option value="Yes">Так</option>
                                            <option value="No">Ні</option>
                                        </select>
                                    </div>
                                    <div class="col-md-3" data-field-id="ActivitySegment">
                                        <label class="form-label">Сегмент активності</label>
                                        <select class="form-select" onchange="addTag(this, 'ActivitySegment')">
                                            <option value="">...</option>
                                            <option value="VIP">VIP</option>
                                            <option value="Active">Активний</option>
                                            <option value="Sleep">Сплячий</option>
                                            <option value="Churn">Відтік</option>
                                        </select>
                                    </div>
                                    <div class="col-md-3" data-field-id="POB">
                                        <label class="form-label">ПОБ</label>
                                        <select class="form-select" onchange="addTag(this, 'POB')">
                                            <option value="">...</option>
                                            <option value="Yes">Так</option>
                                            <option value="No">Ні</option>
                                        </select>
                                    </div>
                                    <div class="col-md-3" data-field-id="Blacklist">
                                        <label class="form-label">Чорний список (ЧС)</label>
                                        <select class="form-select" onchange="addTag(this, 'Blacklist')">
                                            <option value="">...</option>
                                            <option value="Yes">Так</option>
                                            <option value="No">Ні</option>
                                        </select>
                                    </div>
                                    <div class="col-md-3" data-field-id="RegionalCenter">
                                        <label class="form-label">Регіональний центр</label>
                                        <select class="form-select" onchange="addTag(this, 'RegionalCenter')">
                                            <option value="">...</option>
                                            <option value="Kyiv">Київ</option>
                                            <option value="Lviv">Львів</option>
                                            <option value="Odesa">Одеса</option>
                                            <option value="Dnipro">Дніпро</option>
                                            <option value="Kharkiv">Харків</option>
                                        </select>
                                    </div>
                                    <div class="col-md-3" data-field-id="ActivitySphere">
                                        <label class="form-label">Сфера діяльності</label>
                                        <select class="form-select" onchange="addTag(this, 'ActivitySphere')">
                                            <option value="">...</option>
                                            <option value="Retail">Retail</option>
                                            <option value="IT">IT</option>
                                            <option value="FMCG">FMCG</option>
                                            <option value="Logistics">Logistics</option>
                                            <option value="Auto">Auto</option>
                                        </select>
                                    </div>
                                    <div class="col-md-3" data-field-id="SettlementType">
                                        <label class="form-label">Тип нас. пункту</label>
                                        <select class="form-select" onchange="addTag(this, 'SettlementType')">
                                            <option value="">...</option>
                                            <option value="City">Місто</option>
                                            <option value="Village">Село</option>
                                            <option value="Town">СМТ</option>
                                        </select>
                                    </div>
                                    <div class="col-md-6" data-field-id="LastENSphereDate">
                                        <div class="d-flex justify-content-between align-items-center mb-1">
                                            <label class="form-label mb-0">Дата останьої ЕН по сфері</label>
                                            <div
                                                class="form-check form-switch min-h-0 mb-0 d-flex align-items-center gap-1">
                                                <input class="form-check-input" type="checkbox" id="c4-ensphere-all"
                                                    style="transform: scale(0.8);"
                                                    onchange="toggleRangeAll('c4-ensphere', this.checked)">
                                                <label class="form-check-label text-muted small"
                                                    for="c4-ensphere-all">&infin;</label>
                                            </div>
                                        </div>
                                        <div class="input-group">
                                            <input type="date" class="form-control px-2" id="c4-ensphere-from">
                                            <span class="input-group-text bg-light px-1"
                                                style="font-size: 0.7rem;">по</span>
                                            <input type="date" class="form-control px-2" id="c4-ensphere-to">
                                            <button class="btn btn-outline-primary px-2" type="button"
                                                onclick="addRangeTag('LastENSphereDate', 'Ост. ЕН по сфері', 'c4-ensphere-from', 'c4-ensphere-to')">
                                                <i class="bi bi-plus"></i>
                                            </button>
                                        </div>
                                    </div>
                                    <div class="col-md-6" data-field-id="NextPurchaseProb">
                                        <div class="d-flex justify-content-between align-items-center mb-1">
                                            <label class="form-label mb-0">Ймовірність покупки (%)</label>
                                            <div
                                                class="form-check form-switch min-h-0 mb-0 d-flex align-items-center gap-1">
                                                <input class="form-check-input" type="checkbox" id="c4-prob-all"
                                                    style="transform: scale(0.8);"
                                                    onchange="toggleRangeAll('c4-prob', this.checked)">
                                                <label class="form-check-label text-muted small"
                                                    for="c4-prob-all">&infin;</label>
                                            </div>
                                        </div>
                                        <div class="input-group">
                                            <input type="number" class="form-control px-2" id="c4-prob-from"
                                                placeholder="0">
                                            <span class="input-group-text bg-light px-1"
                                                style="font-size: 0.7rem;">по</span>
                                            <input type="number" class="form-control px-2" id="c4-prob-to"
                                                placeholder="100">
                                            <button class="btn btn-outline-primary px-2" type="button"
                                                onclick="addRangeTag('NextPurchaseProb', 'Ймовірність покупки', 'c4-prob-from', 'c4-prob-to')">
                                                <i class="bi bi-plus"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 5. Активність та Локації -->
                        <div class="tab-pane fade" id="pane-c5" role="tabpanel">
                            <div class="tab-pane-card">
                                <h6 class="fw-bold text-primary mb-3 text-uppercase small" style="letter-spacing: 1px;">
                                    ТРАНЗАКЦІЙНА АКТИВНІСТЬ</h6>
                                <div class="row g-3 mb-4">
                                    <div class="col-md-4" data-field-id="FirstTransactionDate">
                                        <div class="d-flex justify-content-between align-items-center mb-1">
                                            <label class="form-label mb-0">Дата першої транзакції</label>
                                            <div
                                                class="form-check form-switch min-h-0 mb-0 d-flex align-items-center gap-1">
                                                <input class="form-check-input" type="checkbox" id="c5-firsttrans-all"
                                                    style="transform: scale(0.8);"
                                                    onchange="toggleRangeAll('c5-firsttrans', this.checked)">
                                                <label class="form-check-label text-muted small"
                                                    for="c5-firsttrans-all">&infin;</label>
                                            </div>
                                        </div>
                                        <div class="input-group">
                                            <input type="date" class="form-control px-2" id="c5-firsttrans-from">
                                            <span class="input-group-text bg-light px-1"
                                                style="font-size: 0.7rem;">по</span>
                                            <input type="date" class="form-control px-2" id="c5-firsttrans-to">
                                            <button class="btn btn-outline-primary px-2" type="button"
                                                onclick="addRangeTag('FirstTransactionDate', 'Перша транзація', 'c5-firsttrans-from', 'c5-firsttrans-to')">
                                                <i class="bi bi-plus"></i>
                                            </button>
                                        </div>
                                    </div>
                                    <div class="col-md-4" data-field-id="LastTransactionDate">
                                        <div class="d-flex justify-content-between align-items-center mb-1">
                                            <label class="form-label mb-0">Дата остан. транзакції</label>
                                            <div
                                                class="form-check form-switch min-h-0 mb-0 d-flex align-items-center gap-1">
                                                <input class="form-check-input" type="checkbox" id="c5-lasttrans-all"
                                                    style="transform: scale(0.8);"
                                                    onchange="toggleRangeAll('c5-lasttrans', this.checked)">
                                                <label class="form-check-label text-muted small"
                                                    for="c5-lasttrans-all">&infin;</label>
                                            </div>
                                        </div>
                                        <div class="input-group">
                                            <input type="date" class="form-control px-2" id="c5-lasttrans-from">
                                            <span class="input-group-text bg-light px-1"
                                                style="font-size: 0.7rem;">по</span>
                                            <input type="date" class="form-control px-2" id="c5-lasttrans-to">
                                            <button class="btn btn-outline-primary px-2" type="button"
                                                onclick="addRangeTag('LastTransactionDate', 'Остання транзакція', 'c5-lasttrans-from', 'c5-lasttrans-to')">
                                                <i class="bi bi-plus"></i>
                                            </button>
                                        </div>
                                    </div>
                                    <div class="col-md-4" data-field-id="LastENDate">
                                        <div class="d-flex justify-content-between align-items-center mb-1">
                                            <label class="form-label mb-0">Дата останньої ЕН</label>
                                            <div
                                                class="form-check form-switch min-h-0 mb-0 d-flex align-items-center gap-1">
                                                <input class="form-check-input" type="checkbox" id="c5-lasten-all"
                                                    style="transform: scale(0.8);"
                                                    onchange="toggleRangeAll('c5-lasten', this.checked)">
                                                <label class="form-check-label text-muted small"
                                                    for="c5-lasten-all">&infin;</label>
                                            </div>
                                        </div>
                                        <div class="input-group">
                                            <input type="date" class="form-control px-2" id="c5-lasten-from">
                                            <span class="input-group-text bg-light px-1"
                                                style="font-size: 0.7rem;">по</span>
                                            <input type="date" class="form-control px-2" id="c5-lasten-to">
                                            <button class="btn btn-outline-primary px-2" type="button"
                                                onclick="addRangeTag('LastENDate', 'Дата останньої ЕН', 'c5-lasten-from', 'c5-lasten-to')">
                                                <i class="bi bi-plus"></i>
                                            </button>
                                        </div>
                                    </div>
                                    <div class="col-md-12" data-field-id="ParcelsCount">
                                        <label class="form-label">Кількість посилок</label>
                                        <div class="d-flex gap-2 align-items-center">
                                            <select class="form-select" style="min-width: 140px; width: auto;"
                                                onchange="toggleLalParcelsMode(this)">
                                                <option value=">">Більше ніж</option>
                                                <option value="<">Менше ніж</option>
                                                <option value="range">Діапазон</option>
                                            </select>
                                            <div class="d-flex gap-1 align-items-center">
                                                <input type="number" class="form-control input-from"
                                                    style="width: 100px;" value="5">
                                                <span class="range-separator d-none small text-muted">-</span>
                                                <input type="number" class="form-control input-to d-none"
                                                    style="width: 100px;" placeholder="До">
                                            </div>
                                            <button class="btn btn-outline-primary" type="button"
                                                onclick="addParcelsTag(this)">
                                                <i class="bi bi-plus"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>

                                <h6 class="fw-bold text-primary mb-3 text-uppercase small" style="letter-spacing: 1px;">
                                    ЛОКАЦІЇ ТА ТОЧКИ ОБСЛУГОВУВАННЯ</h6>
                                <div class="row g-3 mb-4">
                                    <div class="col-md-4" data-field-id="LastServicePoint">
                                        <label class="form-label">Остан. точка обслуг.</label>
                                        <input type="text" class="form-control" placeholder="Пошук точки..."
                                            onchange="addTextTag(this, 'LastServicePoint')">
                                    </div>
                                    <div class="col-md-4" data-field-id="MainBranch">
                                        <label class="form-label">Основне відділення</label>
                                        <input type="text" class="form-control" placeholder="Пошук відділення..."
                                            onchange="addTextTag(this, 'MainBranch')">
                                    </div>
                                    <div class="col-md-4" data-field-id="MainPostomat">
                                        <label class="form-label">Основний поштомат</label>
                                        <input type="text" class="form-control" placeholder="Пошук поштомату..."
                                            onchange="addTextTag(this, 'MainPostomat')">
                                    </div>
                                    <div class="col-md-4" data-field-id="FavoritePoint">
                                        <label class="form-label">Улюблена точка обслугов.</label>
                                        <input type="text" class="form-control" placeholder="Пошук точки..."
                                            onchange="addTextTag(this, 'FavoritePoint')">
                                    </div>
                                    <div class="col-md-4" data-field-id="ReserveBranch">
                                        <label class="form-label">Резервне відділення</label>
                                        <input type="text" class="form-control" placeholder="Пошук відділення..."
                                            onchange="addTextTag(this, 'ReserveBranch')">
                                    </div>
                                    <div class="col-md-4" data-field-id="ReservePostomat">
                                        <label class="form-label">Резервний поштомат</label>
                                        <input type="text" class="form-control" placeholder="Пошук поштомату..."
                                            onchange="addTextTag(this, 'ReservePostomat')">
                                    </div>
                                </div>

                                <h6 class="fw-bold text-primary mb-3 text-uppercase small" style="letter-spacing: 1px;">
                                    ГЕОГРАФІЯ ТОЧОК ОБСЛУГОВУВАННЯ</h6>
                                <div class="row g-3">
                                    <div class="col-md-4" data-field-id="LastPointCity">
                                        <label class="form-label">Місто остан. точки обслугов.</label>
                                        <input type="text" class="form-control" placeholder="Обери..."
                                            onchange="addTextTag(this, 'LastPointCity')">
                                    </div>
                                    <div class="col-md-4" data-field-id="MainBranchCity">
                                        <label class="form-label">Місто основного відділення</label>
                                        <input type="text" class="form-control" placeholder="Обери..."
                                            onchange="addTextTag(this, 'MainBranchCity')">
                                    </div>
                                    <div class="col-md-4" data-field-id="MainPostomatCity">
                                        <label class="form-label">Місто основного поштомату</label>
                                        <input type="text" class="form-control" placeholder="Обери..."
                                            onchange="addTextTag(this, 'MainPostomatCity')">
                                    </div>
                                    <div class="col-md-6" data-field-id="ReserveBranchCity">
                                        <label class="form-label">Місто резервного відділення</label>
                                        <input type="text" class="form-control" placeholder="Обери..."
                                            onchange="addTextTag(this, 'ReserveBranchCity')">
                                    </div>
                                    <div class="col-md-6" data-field-id="ReservePostomatCity">
                                        <label class="form-label">Місто резервного поштомату</label>
                                        <input type="text" class="form-control" placeholder="Обери..."
                                            onchange="addTextTag(this, 'ReservePostomatCity')">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 6. Додаток та Пристрої -->
                        <div class="tab-pane fade" id="pane-c6" role="tabpanel">
                            <div class="tab-pane-card">
                                <h6 class="fw-bold text-primary mb-3 text-uppercase small" style="letter-spacing: 1px;">
                                    ОПЕРАЦІЙНА СИСТЕМА ТА МАГАЗИН ПЛАТФОРМИ</h6>
                                <div class="row g-3 mb-4">
                                    <div class="col-md-6" data-field-id="OSVersion">
                                        <label class="form-label">Версія ОС</label>
                                        <select class="form-select" onchange="addTag(this, 'OSVersion')">
                                            <option value="">...</option>
                                            <option value="iOS">iOS</option>
                                            <option value="Android">Android</option>
                                        </select>
                                    </div>
                                    <div class="col-md-6" data-field-id="AppStore">
                                        <label class="form-label">Магазин додатку</label>
                                        <select class="form-select" onchange="addTag(this, 'AppStore')">
                                            <option value="">...</option>
                                            <option value="AppStore">App Store</option>
                                            <option value="GooglePlay">Google Play</option>
                                            <option value="AppGallery">AppGallery</option>
                                        </select>
                                    </div>
                                </div>

                                <h6 class="fw-bold text-primary mb-3 text-uppercase small" style="letter-spacing: 1px;">
                                    ХАРАКТЕРИСТИКИ ПРИСТРОЮ</h6>
                                <div class="row g-3">
                                    <div class="col-md-4" data-field-id="DeviceStatus">
                                        <label class="form-label">Статус девайсу</label>
                                        <select class="form-select" onchange="addTag(this, 'DeviceStatus')">
                                            <option value="">...</option>
                                            <option value="Active">Активний</option>
                                            <option value="Inactive">Неактивний</option>
                                        </select>
                                    </div>
                                    <div class="col-md-4" data-field-id="DeviceManufacturer">
                                        <label class="form-label">Виробник девайсу</label>
                                        <input type="text" class="form-control" placeholder="Напр: Apple"
                                            onchange="addTextTag(this, 'DeviceManufacturer')">
                                    </div>
                                    <div class="col-md-4" data-field-id="DeviceModel">
                                        <label class="form-label">Модель девайсу</label>
                                        <input type="text" class="form-control" placeholder="Напр: iPhone 13"
                                            onchange="addTextTag(this, 'DeviceModel')">
                                    </div>
                                    <div class="col-md-12" data-field-id="DeviceProvider">
                                        <label class="form-label">Постачальник девайсу</label>
                                        <select class="form-select" onchange="addTag(this, 'DeviceProvider')">
                                            <option value="">...</option>
                                            <option value="Provider1">Постачальник 1</option>
                                            <option value="Provider2">Постачальник 2</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 7. Згоди та Комунікація -->
                        <div class="tab-pane fade" id="pane-c7" role="tabpanel">
                            <div class="tab-pane-card">
                                <h6 class="fw-bold text-primary mb-3 text-uppercase small" style="letter-spacing: 1px;">
                                    ПАРАМЕТРИ ПЕРСОНАЛЬНИХ ЗГОД</h6>
                                <div class="row g-3 mb-4">
                                    <div class="col-md-4" data-field-id="ConsentType">
                                        <label class="form-label">Вид згоди</label>
                                        <select class="form-select" onchange="addTag(this, 'ConsentType')">
                                            <option value="">...</option>
                                            <option value="Marketing">Маркетинг</option>
                                            <option value="DataProcess">Обробка даних</option>
                                        </select>
                                    </div>
                                    <div class="col-md-4" data-field-id="ConsentStatus">
                                        <label class="form-label">Статус згоди</label>
                                        <select class="form-select" onchange="addTag(this, 'ConsentStatus')">
                                            <option value="">...</option>
                                            <option value="Given">Надано</option>
                                            <option value="Revoked">Відкликано</option>
                                        </select>
                                    </div>
                                    <div class="col-md-4" data-field-id="MarketingConsent">
                                        <label class="form-label">Згода маркетингу</label>
                                        <select class="form-select" onchange="addTag(this, 'MarketingConsent')">
                                            <option value="">...</option>
                                            <option value="Yes">Так</option>
                                            <option value="No">Ні</option>
                                        </select>
                                    </div>
                                </div>

                                <h6 class="fw-bold text-primary mb-3 text-uppercase small" style="letter-spacing: 1px;">
                                    СТАТУСИ ТА КАНАЛИ КОМУНІКАЦІЇ</h6>
                                <div class="row g-3">
                                    <div class="col-md-6" data-field-id="CommsStatus">
                                        <label class="form-label">Статус комунікації</label>
                                        <select class="form-select" onchange="addTag(this, 'CommsStatus')">
                                            <option value="">...</option>
                                            <option value="Subscribed">Підписаний</option>
                                            <option value="Unsubscribed">Відписаний</option>
                                        </select>
                                    </div>
                                    <div class="col-md-6" data-field-id="NewsFeed">
                                        <label class="form-label">Стрічка новин</label>
                                        <select class="form-select" onchange="addTag(this, 'NewsFeed')">
                                            <option value="">...</option>
                                            <option value="Subscribed">Підписаний</option>
                                            <option value="Unsubscribed">Відписаний</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 8. Верифікація -->
                        <div class="tab-pane fade" id="pane-c8" role="tabpanel">
                            <div class="tab-pane-card">
                                <h6 class="fw-bold text-primary mb-3 text-uppercase small" style="letter-spacing: 1px;">
                                    ВЕРИФІКАЦІЯ ТА СТАТУСИ ПІДТВЕРДЖЕННЯ</h6>
                                <div class="row g-3">
                                    <div class="col-md-4" data-field-id="ClientVerification">
                                        <label class="form-label">Верифікація клієнта</label>
                                        <select class="form-select" onchange="addTag(this, 'ClientVerification')">
                                            <option value="">...</option>
                                            <option value="Yes">Так</option>
                                            <option value="No">Ні</option>
                                        </select>
                                    </div>
                                    <div class="col-md-4" data-field-id="PhoneVerificationStatus">
                                        <label class="form-label">Статус вер. телефону</label>
                                        <select class="form-select" onchange="addTag(this, 'PhoneVerificationStatus')">
                                            <option value="">...</option>
                                            <option value="Verified">Верифіковано</option>
                                            <option value="NotVerified">Не верифіковано</option>
                                        </select>
                                    </div>
                                    <div class="col-md-4" data-field-id="EmailVerificationStatus">
                                        <label class="form-label">Статус вер. Email</label>
                                        <select class="form-select" onchange="addTag(this, 'EmailVerificationStatus')">
                                            <option value="">...</option>
                                            <option value="Verified">Верифіковано</option>
                                            <option value="NotVerified">Не верифіковано</option>
                                        </select>
                                    </div>
                                    <div class="col-md-12" data-field-id="FirstVerificationNovaPay">
                                        <label class="form-label">Наяв. першої вериф. клієнта NovaPay</label>
                                        <select class="form-select" onchange="addTag(this, 'FirstVerificationNovaPay')">
                                            <option value="">...</option>
                                            <option value="Yes">Так</option>
                                            <option value="No">Ні</option>
                                        </select>
                                    </div>
                                    <div class="col-md-6" data-field-id="VerificationDate">
                                        <div class="d-flex justify-content-between align-items-center mb-1">
                                            <label class="form-label mb-0">Дата вериф. клієнта</label>
                                            <div
                                                class="form-check form-switch min-h-0 mb-0 d-flex align-items-center gap-1">
                                                <input class="form-check-input" type="checkbox" id="c8-verif-all"
                                                    style="transform: scale(0.8);"
                                                    onchange="toggleRangeAll('c8-verif', this.checked)">
                                                <label class="form-check-label text-muted small"
                                                    for="c8-verif-all">&infin;</label>
                                            </div>
                                        </div>
                                        <div class="input-group">
                                            <input type="date" class="form-control px-2" id="c8-verif-from">
                                            <span class="input-group-text bg-light px-1"
                                                style="font-size: 0.7rem;">по</span>
                                            <input type="date" class="form-control px-2" id="c8-verif-to">
                                            <button class="btn btn-outline-primary px-2" type="button"
                                                onclick="addRangeTag('VerificationDate', 'Дата вериф.', 'c8-verif-from', 'c8-verif-to')">
                                                <i class="bi bi-plus"></i>
                                            </button>
                                        </div>
                                    </div>
                                    <div class="col-md-6" data-field-id="LastVerificationDate">
                                        <div class="d-flex justify-content-between align-items-center mb-1">
                                            <label class="form-label mb-0">Дата останьої вериф.</label>
                                            <div
                                                class="form-check form-switch min-h-0 mb-0 d-flex align-items-center gap-1">
                                                <input class="form-check-input" type="checkbox" id="c8-lastver-all"
                                                    style="transform: scale(0.8);"
                                                    onchange="toggleRangeAll('c8-lastver', this.checked)">
                                                <label class="form-check-label text-muted small"
                                                    for="c8-lastver-all">&infin;</label>
                                            </div>
                                        </div>
                                        <div class="input-group">
                                            <input type="date" class="form-control px-2" id="c8-lastver-from">
                                            <span class="input-group-text bg-light px-1"
                                                style="font-size: 0.7rem;">по</span>
                                            <input type="date" class="form-control px-2" id="c8-lastver-to">
                                            <button class="btn btn-outline-primary px-2" type="button"
                                                onclick="addRangeTag('LastVerificationDate', 'Остання вериф.', 'c8-lastver-from', 'c8-lastver-to')">
                                                <i class="bi bi-plus"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 9. Проблеми та Додатково -->
                        <div class="tab-pane fade" id="pane-c9" role="tabpanel">
                            <div class="tab-pane-card">
                                <h6 class="fw-bold text-primary mb-3 text-uppercase small" style="letter-spacing: 1px;">
                                    ПРОБЛЕМНІ ЕКСПРЕС-НАКЛАДНІ</h6>
                                <div class="row g-3 mb-4">
                                    <div class="col-md-6" data-field-id="ReturnReason">
                                        <label class="form-label">Причина повернення ЕН</label>
                                        <select class="form-select" onchange="addTag(this, 'ReturnReason')">
                                            <option value="">...</option>
                                            <option value="Refusal">Відмова</option>
                                            <option value="Expired">Термін зберігання</option>
                                        </select>
                                    </div>
                                    <div class="col-md-6" data-field-id="ENProblemType">
                                        <label class="form-label">Вид проблеми з ЕН</label>
                                        <select class="form-select" onchange="addTag(this, 'ENProblemType')">
                                            <option value="">...</option>
                                            <option value="Damaged">Пошкоджено</option>
                                            <option value="Lost">Втрачено</option>
                                        </select>
                                    </div>
                                </div>

                                <h6 class="fw-bold text-primary mb-3 text-uppercase small" style="letter-spacing: 1px;">
                                    ДОДАТКОВІ ПАРАМЕТРИ ФІЛЬТРАЦІЇ</h6>
                                <div class="row g-3">
                                    <div class="col-md-4" data-field-id="PretenseAvailability">
                                        <label class="form-label">Наявність претензій</label>
                                        <select class="form-select" onchange="addTag(this, 'PretenseAvailability')">
                                            <option value="">...</option>
                                            <option value="Yes">Так</option>
                                            <option value="No">Ні</option>
                                        </select>
                                    </div>
                                    <div class="col-md-4" data-field-id="PromoAvailability">
                                        <label class="form-label">Наявність промокоду</label>
                                        <select class="form-select" onchange="addTag(this, 'PromoAvailability')">
                                            <option value="">...</option>
                                            <option value="Yes">Так</option>
                                            <option value="No">Ні</option>
                                        </select>
                                    </div>
                                    <div class="col-md-4" data-field-id="Marketplace">
                                        <label class="form-label">Маркетплейс</label>
                                        <select class="form-select" onchange="addTag(this, 'Marketplace')">
                                            <option value="">...</option>
                                            <option value="OLX">OLX</option>
                                            <option value="Prom">Prom</option>
                                            <option value="Rozetka">Rozetka</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 10. Гео-мапа -->
                        <div class="tab-pane fade" id="pane-c10" role="tabpanel">
                            <div class="tab-pane-card p-0"
                                style="overflow: hidden; display: flex; flex-direction: column;">
                                <!-- Formula-style Summary Bar -->
                                <div class="bg-white border-bottom p-2 d-flex align-items-center gap-3"
                                    style="min-height: 55px; background: linear-gradient(to right, #f8f9fa, #fff);">
                                    <div class="d-flex align-items-center gap-2 border-end pe-3">
                                        <div class="bg-primary text-white rounded px-2 py-1 small fw-bold shadow-sm"
                                            style="font-size: 10px; white-space: nowrap;">
                                            ГЕО-ФОРМУЛА
                                        </div>
                                        <span class="badge bg-primary rounded-pill" id="geo-points-count"
                                            style="font-size: 10px;">0</span>
                                    </div>
                                    <div id="geo-chips-container"
                                        class="d-flex flex-wrap gap-1 align-items-center overflow-auto flex-grow-1"
                                        style="max-height: 50px;">
                                        <span class="text-muted small italic">Локації не вибрані...</span>
                                    </div>
                                    <input type="file" id="geo-excel-file" hidden accept=".csv, .txt"
                                        onchange="handleExcelUpload(event)">
                                    <button class="btn btn-success btn-sm px-2 py-1"
                                        onclick="document.getElementById('geo-excel-file').click()"
                                        data-bs-toggle="popover" data-bs-trigger="hover focus" data-bs-placement="top"
                                        data-bs-html="true" data-bs-title="Інструкція імпорту"
                                        data-bs-content="<b>Формат стовпців:</b><br>1. Локація (Координати/Адреса)<br>2. Радіус (км)<br>3. Ціль (Відправлення/Отримання)<br><br><span class='text-primary'>Приклад: Київ, Хрещатик 1; 5; Отримання</span>"
                                        style="font-size: 11px;">
                                        <i class="bi bi-file-earmark-spreadsheet me-1"></i> Імпорт
                                    </button>
                                    <button class="btn btn-outline-danger btn-sm px-2 py-1"
                                        onclick="clearGeoSelection()" title="Очистити все" style="font-size: 11px;">
                                        <i class="bi bi-trash3 me-1"></i> Скинути
                                    </button>
                                </div>
                                <div class="row g-0 flex-grow-1">
                                    <div class="col-md-4 border-end p-3 bg-light bg-opacity-50"
                                        style="max-height: 500px; overflow-y: auto;">
                                        <h6 class="fw-bold text-primary mb-3 text-uppercase"
                                            style="letter-spacing: 1px; font-size: 0.85rem;">
                                            ПАРАМЕТРИ ТА ІМПОРТ</h6>

                                        <div class="mb-3">
                                            <div class="form-check form-check-inline">
                                                <input class="form-check-input" type="radio" name="geoMode"
                                                    id="geoModeCoords" value="coords" checked
                                                    onchange="toggleGeoMode()">
                                                <label class="form-check-label small" for="geoModeCoords">Точка</label>
                                            </div>
                                            <div class="form-check form-check-inline">
                                                <input class="form-check-input" type="radio" name="geoMode"
                                                    id="geoModeBranches" value="branches" onchange="toggleGeoMode()">
                                                <label class="form-check-label small"
                                                    for="geoModeBranches">Відділення</label>
                                            </div>
                                            <div class="form-check form-check-inline">
                                                <input class="form-check-input" type="radio" name="geoMode"
                                                    id="geoModeAddress" value="address" onchange="toggleGeoMode()">
                                                <label class="form-check-label small"
                                                    for="geoModeAddress">Адреса</label>
                                            </div>
                                        </div>

                                        <!-- 1. Координати -->
                                        <div class="geo-coords-inputs mb-3" id="geo-block-coords">
                                            <div class="row g-2 align-items-end">
                                                <div class="col-5">
                                                    <label class="form-label mb-1"
                                                        style="font-size: 10px;">Широта</label>
                                                    <input type="text" class="form-control form-control-sm"
                                                        id="input-geo-lat" placeholder="Lat">
                                                </div>
                                                <div class="col-5">
                                                    <label class="form-label mb-1"
                                                        style="font-size: 10px;">Довгота</label>
                                                    <input type="text" class="form-control form-control-sm"
                                                        id="input-geo-lng" placeholder="Lng">
                                                </div>
                                                <div class="col-2">
                                                    <button class="btn btn-primary btn-sm w-100"
                                                        onclick="addManualPoint()">
                                                        <i class="bi bi-plus-lg"></i>
                                                    </button>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- 2. Відділення -->
                                        <div class="geo-branch-inputs mb-3" id="geo-block-branches"
                                            style="display:none;">
                                            <label class="form-label mb-1" style="font-size: 10px;">Пошук
                                                міста/відділення</label>
                                            <input class="form-control form-control-sm mb-2" list="datalist-cities"
                                                id="GeoCity" placeholder="Місто..."
                                                onchange="handleMapSelection('city', this.value)">
                                            <div class="input-group input-group-sm">
                                                <input class="form-control" list="datalist-branches"
                                                    id="geo-branch-search" placeholder="Відділення..."
                                                    onchange="handleMapSelection('branch', this.value)">
                                            </div>
                                        </div>

                                        <!-- 3. Адреса -->
                                        <div class="geo-address-inputs mb-3" id="geo-block-address"
                                            style="display:none;">
                                            <label class="form-label mb-1" style="font-size: 10px;">Впишіть
                                                адресу</label>
                                            <div class="input-group input-group-sm">
                                                <input type="text" class="form-control" id="geo-custom-address"
                                                    placeholder="Місто, вулиця, буд...">
                                                <button class="btn btn-outline-primary" onclick="addAddressPoint()">
                                                    <i class="bi bi-geo-alt"></i>
                                                </button>
                                            </div>
                                        </div>

                                        <div class="mb-3 border-top pt-2">
                                            <label class="form-label mb-1"
                                                style="font-size: 11px; font-weight: 600;">РАДІУС (КМ)</label>
                                            <input type="number" class="form-control form-control-sm" id="GeoRadius"
                                                value="5" oninput="updateLastPointRadius()">
                                        </div>

                                        <div class="mb-3">
                                            <label class="form-label mb-1"
                                                style="font-size: 11px; font-weight: 600;">ЦІЛЬ (ОПЕРАТОР)</label>
                                            <select class="form-select form-select-sm" id="geo-target-type"
                                                onchange="updateLastPointTarget()">
                                                <option value="Sender">Відправлення</option>
                                                <option value="Recipient">Отримання</option>
                                                <option value="AppLocation_New">Локація (Новий додаток)</option>
                                                <option value="AppLocation_Old">Локація (Старий додаток)</option>
                                            </select>
                                        </div>

                                        <button class="btn btn-primary w-100 btn-sm fw-bold mt-2 py-2 shadow-sm"
                                            onclick="addGeoFilter()">
                                            <i class="bi bi-check-circle me-1"></i> ЗАСТОСУВАТИ ГЕО-ФІЛЬТР
                                        </button>
                                    </div>
                                    <div class="col-md-8 position-relative">
                                        <div id="map-container" style="height: 500px; width: 100%;"></div>
                                        <div class="position-absolute top-0 end-0 p-2" style="z-index: 1000;">
                                            <span class="badge bg-white text-dark border shadow-sm small">Клікніть на
                                                мапу, щоб додати точку</span>
                                        </div>
                                    </div>
                                </div>
                                <input type="hidden" id="geo-lat">
                                <input type="hidden" id="geo-lng">
                                <datalist id="datalist-cities"></datalist>
                                <datalist id="datalist-branches"></datalist>
                            </div>
                        </div>

                    </div>

                    <!-- UI Architect Modal -->


                    <!-- Constructor Results (Moved to Bottom) -->
                    <div id="constructor-results" class="d-none animate-fade-in mt-3">
                        <div class="card-diamond p-3">
                            <h6 class="fw-bold mb-3 small text-uppercase">Попередній перегляд (Топ 5)</h6>
                            <div class="table-responsive rounded-3 border">
                                <table class="table table-hover table-bordered small bg-white mb-0">
                                    <thead class="table-light">
                                        <tr>
                                            <th>#</th>
                                            <th>Результат</th>
                                        </tr>
                                    </thead>
                                    <tbody id="constructor-table-body"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>



                </div>



                <!-- VIEW 2: LOOK-A-LIKE -->
                <div id="view-lookalike" class="view-section d-none">
                    <div class="ai-input-card border rounded-4 bg-white overflow-hidden shadow-sm mb-4"
                        style="border-color: var(--border) !important;">

                        <!-- Top Configuration Bar (Integrated workflow) -->
                        <div class="px-4 py-2 border-bottom d-flex align-items-center justify-content-between"
                            style="background: #fafbfc;">
                            <div class="d-flex align-items-center gap-3">
                                <span class="text-muted small fw-bold text-uppercase"
                                    style="font-size: 0.65rem;">Формувати
                                    вибірку в форматі:</span>
                                <div class="pill-toggle-container">
                                    <div class="pill-toggle-item">
                                        <input type="checkbox" class="btn-check" name="lal-format-sync"
                                            id="lal-fmt-phone" value="phone" checked onchange="syncLalFormat()">
                                        <label class="btn" for="lal-fmt-phone">Телефон</label>
                                    </div>
                                    <div class="pill-toggle-item">
                                        <input type="checkbox" class="btn-check" name="lal-format-sync"
                                            id="lal-fmt-email" value="email" onchange="syncLalFormat()">
                                        <label class="btn" for="lal-fmt-email">E-mail</label>
                                    </div>
                                    <div class="pill-toggle-item">
                                        <input type="checkbox" class="btn-check" name="lal-format-sync" id="lal-fmt-cid"
                                            value="cid" onchange="syncLalFormat()">
                                        <label class="btn" for="lal-fmt-cid">CID</label>
                                    </div>
                                    <div class="pill-toggle-item">
                                        <input type="checkbox" class="btn-check" name="lal-format-sync"
                                            id="lal-fmt-audience" value="audience_id" onchange="syncLalFormat()">
                                        <label class="btn" for="lal-fmt-audience">ID Ауд.</label>
                                    </div>
                                </div>
                            </div>
                            <div class="text-muted small" style="font-size: 0.7rem;">
                                <i class="bi bi-people me-1"></i> Модель: <b class="text-primary">Look-a-like v2</b>
                            </div>
                        </div>

                        <div class="p-4">
                            <h5 class="fw-bold mb-3">Пошук схожих аудиторій</h5>

                            <div class="row g-4">
                                <!-- Drag & Drop -->
                                <div class="col-md-6">
                                    <label class="form-label fw-bold" style="font-size: 0.8rem;">Джерело даних</label>
                                    <div class="drop-zone py-3 px-3" id="dropZone"
                                        style="border: 2px dashed var(--border); border-radius: var(--radius-card); background-color: #fafafa; text-align: center; cursor: pointer;">
                                        <i class="bi bi-cloud-upload fs-1 text-primary mb-2"></i>
                                        <p class="mb-1 text-dark fw-bold">Перетягніть файл сюди</p>
                                        <p class="text-muted small mb-2">.CSV або .XLSX (до 50MB)</p>
                                        <button class="btn btn-sm btn-outline-primary px-3 rounded-pill">Обрати
                                            файл</button>
                                    </div>
                                </div>

                                <!-- Inputs -->
                                <div class="col-md-6">
                                    <div class="mb-4">
                                        <label class="form-label fw-bold" style="font-size: 0.8rem;">Website</label>
                                        <div class="input-group mb-2">
                                            <input type="text" class="form-control" id="lal-website"
                                                placeholder="shop.com.ua"
                                                onkeydown="handleLookalikeInput(event, 'website')">
                                            <button class="btn btn-outline-primary"
                                                onclick="addLalTag('website')">Додати</button>
                                        </div>
                                        <div id="tags-lal-website" class="tags-container"></div>
                                    </div>
                                    <div>
                                        <label class="form-label fw-bold" style="font-size: 0.8rem;">ЄДРПОУ</label>
                                        <div class="input-group mb-2">
                                            <input type="text" class="form-control" id="lal-edrpou" placeholder="Код..."
                                                onkeydown="handleLookalikeInput(event, 'edrpou')">
                                            <button class="btn btn-outline-primary"
                                                onclick="addLalTag('edrpou')">Додати</button>
                                        </div>
                                        <div id="tags-lal-edrpou" class="tags-container"></div>
                                    </div>
                                </div>
                            </div>

                            <hr class="my-4 opacity-10">

                            <div class="row align-items-end g-3">
                                <div class="col-md-4">
                                    <label class="form-label text-muted small d-block"
                                        style="font-size: 0.8rem;">Глибина аналізу</label>
                                    <div class="input-group">
                                        <input type="number" class="form-control" id="lal-days" value="30" min="1"
                                            max="365" placeholder="30" onchange="updateState()">
                                        <span class="input-group-text">днів</span>
                                    </div>
                                    <div class="form-text small text-muted" style="font-size: 0.75rem;">Вкажіть
                                        період до
                                        365 днів</div>
                                </div>
                                <div class="col-md-4">
                                    <div class="d-flex flex-column h-100">
                                        <label class="form-label text-muted small" style="font-size: 0.8rem;">Кількість
                                            посилок</label>
                                        <div class="d-flex gap-2 align-items-center mb-1">
                                            <select class="form-select form-select-sm"
                                                style="min-width: 125px; width: auto;"
                                                onchange="toggleLalParcelsMode(this)">
                                                <option value=">">Більше ніж</option>
                                                <option value="<">Менше ніж</option>
                                                <option value="range">Діапазон</option>
                                            </select>
                                            <div class="d-flex gap-1 align-items-center">
                                                <input type="number" class="form-control form-control-sm input-from"
                                                    style="width: 70px;" value="5">
                                                <span class="range-separator d-none small text-muted">-</span>
                                                <input type="number"
                                                    class="form-control form-control-sm input-to d-none"
                                                    style="width: 70px;" placeholder="До">
                                            </div>
                                        </div>
                                        <div class="form-text small text-muted" style="font-size: 0.75rem;">Фільтр по
                                            активності</div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="d-flex flex-column">
                                        <label class="form-label text-muted small invisible">Spacer</label>
                                        <div class="form-check form-switch d-flex align-items-center"
                                            style="height: 31px;">
                                            <input class="form-check-input ms-0 me-3" type="checkbox"
                                                id="excludeClients" style="transform: scale(1.4);" checked
                                                onchange="updateState()">
                                            <label class="form-check-label text-secondary fw-bold" for="excludeClients"
                                                style="font-size: 0.95rem; margin-top: 2px;">Виключити клієнтів
                                                замовника</label>
                                        </div>
                                        <div class="form-text small text-muted opacity-0" style="font-size: 0.75rem;">
                                            Spacer</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Bottom Action Bar -->
                        <div class="d-flex flex-wrap align-items-center justify-content-end p-3 border-top gap-3"
                            style="background: #f8faff;">
                            <button class="btn btn-primary px-4 py-2 rounded-3 fw-bold d-flex align-items-center gap-2"
                                onclick="handleGeneration('lookalike')">
                                <i class="bi bi-play-circle-fill"></i> Сформувати запит
                            </button>
                        </div>

                    </div>

                    <!-- Look-alike Results (Moved to Bottom) -->
                    <div id="lookalike-results" class="d-none animate-fade-in mt-3">
                        <div class="card-diamond p-3">
                            <h6 class="fw-bold mb-2 small">Попередній перегляд (Топ 5)</h6>
                            <div class="table-responsive rounded-3 border">
                                <table class="table table-hover table-bordered small bg-white mb-0">
                                    <thead class="table-light">
                                        <tr>
                                            <th>#</th>
                                            <th>Результат</th>
                                        </tr>
                                    </thead>
                                    <tbody id="lookalike-table-body"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                </div>

                <!-- VIEW 3: AI ASSISTANT -->
                <div id="view-ai" class="view-section d-none">
                    <div class="card-diamond p-3">


                        <div class="d-flex align-items-center mb-4">
                            <div class="bg-primary text-white rounded-circle d-flex align-items-center justify-content-center me-3"
                                style="width:64px; height:64px; box-shadow: 0 8px 25px rgba(67,97,238,0.25);">
                                <i class="bi bi-magic fs-3"></i>
                            </div>
                            <div>
                                <h4 class="fw-bold mb-1">AI Помічник (Text-to-SQL)</h4>
                                <span class="text-muted">Просто опишіть вашу цільову аудиторію природною мовою.</span>
                            </div>
                        </div>

                        <!-- Redesigned AI Input Box with integrated format selection -->
                        <div class="ai-input-card border rounded-4 bg-white overflow-hidden shadow-sm mb-4"
                            style="transition: all 0.3s ease-in-out; border-color: var(--border) !important;">

                            <!-- Top Configuration Bar (Integrated workflow) -->
                            <div class="px-4 py-2 border-bottom d-flex align-items-center justify-content-between"
                                style="background: #fafbfc;">
                                <div class="d-flex align-items-center gap-3">
                                    <span class="text-muted small fw-bold text-uppercase"
                                        style="font-size: 0.65rem;">Формувати вибірку в форматі:</span>
                                    <div class="pill-toggle-container">
                                        <div class="pill-toggle-item">
                                            <input type="checkbox" class="btn-check" name="ai-format-sync"
                                                id="ai-fmt-phone" value="phone" checked onchange="syncAiFormat()">
                                            <label class="btn" for="ai-fmt-phone">Телефон</label>
                                        </div>
                                        <div class="pill-toggle-item">
                                            <input type="checkbox" class="btn-check" name="ai-format-sync"
                                                id="ai-fmt-email" value="email" onchange="syncAiFormat()">
                                            <label class="btn" for="ai-fmt-email">E-mail</label>
                                        </div>
                                        <div class="pill-toggle-item">
                                            <input type="checkbox" class="btn-check" name="ai-format-sync"
                                                id="ai-fmt-cid" value="cid" onchange="syncAiFormat()">
                                            <label class="btn" for="ai-fmt-cid">CID</label>
                                        </div>
                                        <div class="pill-toggle-item">
                                            <input type="checkbox" class="btn-check" name="ai-format-sync"
                                                id="ai-fmt-audience" value="audience_id" onchange="syncAiFormat()">
                                            <label class="btn" for="ai-fmt-audience">ID Ауд.</label>
                                        </div>
                                    </div>
                                </div>
                                <div class="text-muted small" style="font-size: 0.7rem;">
                                    <i class="bi bi-cpu me-1"></i> Mode: <b class="text-primary">Direct-SQL-Select</b>
                                </div>
                            </div>
                            <div class="p-1">
                                <textarea id="ai-prompt" class="form-control border-0 shadow-none p-4" rows="4"
                                    placeholder="Наприклад: Знайди клієнтів з Києва, які відправляли посилки більше 3 разів за останній місяць..."
                                    style="resize: none; font-size: 1.1rem; line-height: 1.6;"></textarea>
                            </div>

                            <div class="d-flex flex-wrap align-items-center justify-content-between p-3 border-top gap-3"
                                style="background: #f8faff;">
                                <div class="d-flex gap-2 overflow-auto no-scrollbar py-1" style="max-width: 65%;">
                                    <button
                                        class="btn btn-sm btn-outline-primary border rounded-pill px-3 bg-white text-nowrap"
                                        onclick="fillAiPrompt('Телефони отримувачів з Києва з чеком > 2000')">💰 Високий
                                        чек</button>
                                    <button
                                        class="btn btn-sm btn-outline-primary border rounded-pill px-3 bg-white text-nowrap"
                                        onclick="fillAiPrompt('Жінки 25-35 років, iPhone, є email')">📱 iPhone</button>
                                    <button
                                        class="btn btn-sm btn-outline-primary border rounded-pill px-3 bg-white text-nowrap"
                                        onclick="fillAiPrompt('Відправники з Одеси, вантаж > 30кг')">🚛 Вантажні
                                        Одеса</button>
                                </div>

                                <button
                                    class="btn btn-primary px-4 py-2 rounded-3 fw-bold d-flex align-items-center gap-2"
                                    onclick="handleAiRequest()">
                                    <i class="bi bi-stars"></i> Сформувати запит
                                </button>
                            </div>
                        </div>

                        <!-- Info helper -->
                        <div class="d-flex align-items-center gap-2 mb-4 px-2">
                            <i class="bi bi-info-circle text-primary"></i>
                            <span class="text-muted small">Після генерації ви зможете завантажити результат одним кліком
                                або відправити в CDP.</span>
                        </div>



                        <div id="ai-results" class="d-none animate-fade-in">
                            <h6 class="fw-bold mt-5 mb-3"><i class="bi bi-code-square me-2 text-primary"></i>SQL
                                Preview
                            </h6>
                            <div class="sql-preview position-relative" id="sql-code">
                                <!-- Generated SQL goes here -->
                            </div>

                            <!-- Result: Table -->
                            <div id="ai-table-container" class="mt-5">
                                <h6 class="fw-bold mb-3">Попередній перегляд (Топ 5)</h6>
                                <div class="table-responsive rounded-3 border">
                                    <table class="table table-hover table-bordered small bg-white mb-0">
                                        <thead class="table-light">
                                            <tr>
                                                <th>#</th>
                                                <th>Результат</th>
                                            </tr>
                                        </thead>
                                        <tbody id="ai-table-body">
                                            <!-- Dynamic Rows -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Sidebar -->
            <div class="col-lg-3">
                <div class="sidebar-sticky" style="top: 90px;">
                    <!-- 1. Counter (Always Top) -->
                    <div class="counter-box mx-0">
                        <small class="text-white-50 text-uppercase letter-spacing-1">Знайдено записів</small>
                        <div class="counter-number my-2" id="counter-display">24.5M</div>
                        <div class="progress mb-2" style="height: 4px; background: rgba(255,255,255,0.3);">
                            <div class="progress-bar bg-white" style="width: 75%"></div>
                        </div>

                        <!-- Analytics Trigger Button (Integrated) -->
                        <button class="btn btn-sm btn-white-soft w-100 rounded-pill mt-2 text-white border-white-50"
                            style="background: rgba(255,255,255,0.1); backdrop-filter: blur(5px);"
                            data-bs-toggle="modal" data-bs-target="#analyticsModal"
                            onclick="setTimeout(updateAnalytics, 200)">
                            <i class="bi bi-graph-up me-2"></i>Відкрити аналітику
                        </button>
                    </div>

                    <!-- 2. Shortcuts / Presets (Moved under Counter) -->
                    <div class="card-diamond p-3 mb-3">
                        <h6 class="fw-bold mb-3 small text-uppercase text-muted">Швидкі шаблони</h6>
                        <div class="d-grid gap-2">
                            <button
                                class="btn btn-light text-start d-flex align-items-center p-2 border-0 shadow-sm rounded-3"
                                onclick="applyPersona('vip')">
                                <span class="badge bg-warning text-dark me-2 rounded-circle p-2"><i
                                        class="bi bi-star-fill"></i></span>
                                <div style="line-height:1.1">
                                    <span class="d-block fw-bold small">Клієнти VIP</span>
                                    <span class="text-muted" style="font-size: 0.7rem;">Чек > 5000, iPhone</span>
                                </div>
                            </button>
                            <button
                                class="btn btn-light text-start d-flex align-items-center p-2 border-0 shadow-sm rounded-3"
                                onclick="applyPersona('churn')">
                                <span class="badge bg-danger me-2 rounded-circle p-2"><i
                                        class="bi bi-exclamation-triangle-fill"></i></span>
                                <div style="line-height:1.1">
                                    <span class="d-block fw-bold small">Ризик відтоку</span>
                                    <span class="text-muted" style="font-size: 0.7rem;">60 днів без активності</span>
                                </div>
                            </button>
                        </div>
                    </div>

                    <!-- 3. Actions & Format (Unified Block) -->
                    <div class="card-diamond p-3 mb-3">
                        <h6 class="fw-bold mb-3 small text-uppercase text-muted border-bottom pb-2">Експорт результатів
                        </h6>

                        <!-- Row 1: Action Type -->
                        <div class="mb-3">
                            <label class="form-label text-muted small fw-bold text-uppercase mb-1"
                                style="font-size: 0.7rem;">Оберіть дію:</label>
                            <select id="export-action-type" class="form-select form-select-sm"
                                onchange="toggleExportFields()">
                                <option value="preview">Попередній перегляд (Тільки графіки)</option>
                                <option value="csv">Завантажити CSV файл</option>
                                <option value="cdp">Відправити в CDP</option>
                                <option value="automation">Автоматизація (Розсилка звіту)</option>
                                <option value="api">API Запит (JSON)</option>
                            </select>
                        </div>

                        <!-- Format Settings (Hidden for Preview) -->
                        <div id="export-settings-block" style="display:none;">
                            <div class="row g-2 mb-3">
                                <div class="col-6">
                                    <label class="form-label text-muted small fw-bold text-uppercase mb-1"
                                        style="font-size: 0.65rem;">Формат даних</label>
                                    <!-- Custom Multi-Select Dropdown -->
                                    <div class="dropdown" id="constructor-format-unified-dropdown">
                                        <button
                                            class="btn btn-outline-secondary w-100 text-start d-flex justify-content-between align-items-center bg-white multi-select-btn"
                                            type="button" data-bs-toggle="dropdown" data-bs-auto-close="outside"
                                            style="border-color: #dee2e6;">
                                            <span class="selected-values text-muted text-truncate">Телефон</span>
                                            <i class="bi bi-chevron-down small"></i>
                                        </button>
                                        <ul class="dropdown-menu w-100 shadow-sm border-0 multi-select-dropdown">
                                            <li>
                                                <label class="dropdown-item">
                                                    <input class="form-check-input" type="checkbox" value="phone"
                                                        checked
                                                        onchange="updateMultiSelect('constructor-format-unified')">
                                                    <span>Телефон</span>
                                                </label>
                                            </li>
                                            <li>
                                                <label class="dropdown-item">
                                                    <input class="form-check-input" type="checkbox" value="cid"
                                                        onchange="updateMultiSelect('constructor-format-unified')">
                                                    <span>CID</span>
                                                </label>
                                            </li>
                                            <li>
                                                <label class="dropdown-item">
                                                    <input class="form-check-input" type="checkbox" value="email"
                                                        onchange="updateMultiSelect('constructor-format-unified')">
                                                    <span>E-mail</span>
                                                </label>
                                            </li>
                                            <li>
                                                <label class="dropdown-item">
                                                    <input class="form-check-input" type="checkbox" value="audience_id"
                                                        onchange="updateMultiSelect('constructor-format-unified')">
                                                    <span>ID Ауд.</span>
                                                </label>
                                            </li>
                                        </ul>
                                    </div>
                                    <input type="hidden" id="constructor-format-unified" value="phone">
                                </div>
                                <div class="col-6">
                                    <div class="d-flex justify-content-between align-items-center mb-1">
                                        <label class="form-label text-muted small fw-bold text-uppercase mb-0"
                                            style="font-size: 0.65rem;">Кількість</label>
                                        <div
                                            class="form-check form-switch min-h-0 mb-0 d-flex align-items-center gap-1">
                                            <input class="form-check-input" type="checkbox" id="export-all-check"
                                                style="width: 2em; height: 1em; margin-top: 0; cursor: pointer;"
                                                onchange="toggleExportCountInput()">
                                            <label class="form-check-label text-muted" for="export-all-check"
                                                style="font-size: 0.65rem; cursor: pointer;">Всі</label>
                                        </div>
                                    </div>
                                    <input type="number" id="export-count" class="form-control form-control-sm"
                                        value="1000" min="1" placeholder="1000">
                                </div>
                            </div>
                        </div>
                        <!-- Automation Settings (Specific UI) -->
                        <div id="automation-settings-block" style="display:none;"
                            class="border-top pt-3 mt-3 animate-fade-in">
                            <div class="mb-3">
                                <label class="form-label text-muted small fw-bold text-uppercase mb-1"
                                    style="font-size: 0.65rem;">Періодичність вивантаження</label>
                                <div class="row g-2">
                                    <div class="col-12 mb-2">
                                        <select id="automation-period" class="form-select form-select-sm"
                                            onchange="toggleAutomationPeriodFields()">
                                            <option value="daily">Щодня</option>
                                            <option value="weekly">Щотижня</option>
                                            <option value="monthly">Щомісяця</option>
                                        </select>
                                    </div>
                                    <div class="col-6" id="automation-day-weekly-container" style="display:none;">
                                        <select id="automation-day-weekly" class="form-select form-select-sm">
                                            <option value="1">Понеділок</option>
                                            <option value="2">Вівторок</option>
                                            <option value="3">Середа</option>
                                            <option value="4">Четвер</option>
                                            <option value="5">П'ятниця</option>
                                            <option value="6">Субота</option>
                                            <option value="0">Неділя</option>
                                        </select>
                                    </div>
                                    <div class="col-6" id="automation-day-monthly-container" style="display:none;">
                                        <select id="automation-day-monthly" class="form-select form-select-sm">
                                            <!-- Generated 1-31 -->
                                            <option value="1">1-ше число</option>
                                            <option value="15">15-те число</option>
                                            <option value="28">28-те число</option>
                                        </select>
                                    </div>
                                    <div class="col-6" id="automation-time-container">
                                        <input type="time" id="automation-time" class="form-control form-control-sm"
                                            value="09:00">
                                    </div>
                                </div>
                            </div>

                            <div class="mb-2 d-flex justify-content-between align-items-center">
                                <label class="form-label text-muted small fw-bold text-uppercase mb-1"
                                    style="font-size: 0.65rem;">Емейли для розсилки</label>
                                <button class="btn btn-sm btn-link p-0 text-success" title="Імпорт з Excel"
                                    onclick="document.getElementById('automation-email-excel').click()">
                                    <i class="bi bi-file-earmark-spreadsheet-fill fs-5"></i>
                                </button>
                                <input type="file" id="automation-email-excel" hidden accept=".csv, .txt, .xlsx"
                                    onchange="handleAutomationEmailImport(event)">
                            </div>

                            <div class="input-group input-group-sm mb-2 shadow-sm">
                                <input type="email" id="automation-email-input" class="form-control"
                                    placeholder="example@mail.com">
                                <button class="btn btn-primary" onclick="addAutomationEmail()">
                                    <i class="bi bi-plus-lg"></i>
                                </button>
                            </div>

                            <div id="automation-emails-list" class="d-flex flex-wrap gap-1 mb-3"
                                style="max-height: 80px; overflow-y: auto;">
                                <!-- Tags for emails go here -->
                                <span class="text-muted italic small opacity-50">Список пустий...</span>
                            </div>
                        </div>

                        <!-- Single Smart Button -->
                        <button id="smart-execute-btn" class="btn btn-primary w-100 py-2 fw-bold shadow-sm"
                            onclick="handleSmartExecute()">
                            <i class="bi bi-play-circle-fill me-2"></i> <span id="smart-btn-text">Розрахувати
                                показники</span>
                        </button>
                    </div>

                    <script>
                        function toggleExportFields() {
                            const action = document.getElementById('export-action-type').value;
                            const settings = document.getElementById('export-settings-block');
                            const automationSettings = document.getElementById('automation-settings-block');
                            const btnText = document.getElementById('smart-btn-text');
                            const btn = document.getElementById('smart-execute-btn');

                            if (action === 'preview') {
                                settings.style.display = 'none';
                                automationSettings.style.display = 'none';
                                btnText.innerText = 'Розрахувати показники';
                                btn.classList.remove('btn-success', 'btn-dark', 'btn-info');
                                btn.classList.add('btn-primary');
                            } else if (action === 'automation') {
                                settings.style.display = 'block';
                                automationSettings.style.display = 'block';
                                btnText.innerText = 'Створити автоматизацію';
                                btn.classList.remove('btn-success', 'btn-primary', 'btn-dark');
                                btn.classList.add('btn-info', 'text-white');
                            } else {
                                settings.style.display = 'block';
                                automationSettings.style.display = 'none';
                                if (action === 'csv') {
                                    btnText.innerText = 'Завантажити CSV';
                                    btn.classList.remove('btn-primary', 'btn-dark', 'btn-info');
                                    btn.classList.add('btn-success');
                                } else if (action === 'cdp') {
                                    btnText.innerText = 'Відправити в CDP';
                                    btn.classList.remove('btn-success', 'btn-primary', 'btn-info');
                                    btn.classList.add('btn-dark');
                                } else {
                                    btnText.innerText = 'Виконати API запит';
                                    btn.classList.remove('btn-success', 'btn-dark', 'btn-info');
                                    btn.classList.add('btn-primary');
                                }
                            }
                        }

                        function toggleExportCountInput() {
                            const isAll = document.getElementById('export-all-check').checked;
                            const input = document.getElementById('export-count');
                            if (isAll) {
                                input.disabled = true;
                                input.dataset.oldValue = input.value;
                                input.value = '';
                                input.placeholder = 'Всі записи';
                            } else {
                                input.disabled = false;
                                input.value = input.dataset.oldValue || '1000';
                                input.placeholder = '1000';
                            }
                        }

                        function handleSmartExecute() {
                            const action = document.getElementById('export-action-type').value;
                            if (action === 'preview') {
                                syncAndGenerate(); // Calls existing generation logic
                            } else {
                                // For exports, we might need value from format select
                                const formatSide = document.getElementById('constructor-format-unified').value;
                                const hiddenFormat = document.getElementById('constructor-format');
                                if (hiddenFormat) hiddenFormat.value = formatSide;

                                if (action === 'csv' || action === 'cdp' || action === 'api') {
                                    handleExportAction(); // Calls existing export logic
                                } else if (action === 'automation') {
                                    saveCurrentAutomation();
                                }
                            }
                        }

                        // Legacy wrapper if needed
                        function syncAndGenerate() {
                            handleGeneration('constructor');
                        }
                    </script>

                </div>
            </div>

        </div>
    </div>

    <!-- Analytics Modal -->
    <div class="modal fade" id="analyticsModal" tabindex="-1">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content card-diamond border-0">
                <div class="modal-header border-0">
                    <h5 class="modal-title fw-bold"><i class="bi bi-graph-up text-primary me-2"></i>Інсайт
                        Аудиторії
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-4">
                    <div class="row g-4">
                        <div class="col-md-4">
                            <div class="p-3 border rounded bg-light h-100 text-center">
                                <h6 class="text-muted small text-uppercase mb-3">Стать</h6>
                                <div style="height: 200px; position: relative;">
                                    <canvas id="chart-gender"></canvas>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="p-3 border rounded bg-light h-100 text-center">
                                <h6 class="text-muted small text-uppercase mb-3">Пристрої</h6>
                                <div style="height: 200px; position: relative;">
                                    <canvas id="chart-device"></canvas>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="p-3 border rounded bg-light h-100 text-center">
                                <h6 class="text-muted small text-uppercase mb-3">Географія (Топ 5)</h6>
                                <div style="height: 200px; position: relative;">
                                    <canvas id="chart-cities"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div
                        class="alert alert-info d-flex align-items-center mt-4 mb-0 border-0 bg-primary-soft text-primary">
                        <i class="bi bi-info-circle-fill fs-4 me-3"></i>
                        <div>
                            <strong>AI Прогноз:</strong> Ця аудиторія має високу спорідненість (High Affinity)
                            до
                            категорії "Електроніка". Рекомендований час комунікації: 18:00 - 20:00.
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Save Segment Modal -->
    <div class="modal fade" id="saveSegmentModal" tabindex="-1" aria-labelledby="saveSegmentModalLabel"
        aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="saveSegmentModalLabel">Зберегти сегмент</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="segmentNameInput" class="form-label">Назва сегмента</label>
                        <input type="text" class="form-control" id="segmentNameInput"
                            placeholder="Наприклад: Мої VIP клієнти">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Скасувати</button>
                    <button type="button" class="btn btn-primary" onclick="confirmSaveSegment()">Зберегти</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal for Saving Automation -->
    <div class="modal fade" id="saveAutomationModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content overflow-hidden border-0 shadow-lg" style="border-radius: 20px;">
                <div class="modal-header bg-info text-white border-0 py-3">
                    <h5 class="modal-title fw-bold"><i class="bi bi-robot me-2"></i>Створити автоматизацію</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                        aria-label="Close"></button>
                </div>
                <div class="modal-body p-4">
                    <div class="mb-3">
                        <label class="form-label fw-bold small text-muted text-uppercase">Назва автоматизації</label>
                        <input type="text" id="automationNameInput" class="form-control form-control-lg shadow-sm"
                            placeholder="Напр: Щоденний звіт по новим клієнтам"
                            style="border-radius: 12px; border: 2px solid #eef2ff;">
                    </div>
                    <div class="alert alert-info border-0 bg-info bg-opacity-10 text-info small mb-0">
                        <i class="bi bi-info-circle-fill me-2"></i>
                        Цей сегмент буде автоматично вивантажуватись з обраною періодичністю на вказані емейли.
                    </div>
                </div>
                <div class="modal-footer bg-light border-0 py-3">
                    <button type="button" class="btn btn-outline-secondary rounded-pill px-4"
                        data-bs-dismiss="modal">Скасувати</button>
                    <button type="button" class="btn btn-info text-white rounded-pill px-4 fw-bold"
                        onclick="confirmSaveAutomation()">Створити</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <script>
        let map;
        let selectedPoints = []; // Array of objs: {lat, lng, marker, circle, label}
        let mapLayer;
        let branchLayerGroup;

        function initMap() {
            if (map) return;
            map = L.map('map-container', { zoomControl: false }).setView([48.3794, 31.1656], 6);
            L.control.zoom({ position: 'bottomright' }).addTo(map);

            mapLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; OSM'
            }).addTo(map);

            branchLayerGroup = L.layerGroup().addTo(map);

            map.on('click', function (e) {
                const mode = document.querySelector('input[name="geoMode"]:checked').value;

                // 1. Поміщаємо координати в поля при кліку
                document.getElementById('input-geo-lat').value = e.latlng.lat.toFixed(6);
                document.getElementById('input-geo-lng').value = e.latlng.lng.toFixed(6);

                if (mode === 'coords') {
                    addSelectionPoint(e.latlng, 'Точка');
                }
            });
            showMockBranchesDetailed();
        }

        function toggleGeoMode() {
            const mode = document.querySelector('input[name="geoMode"]:checked').value;
            document.getElementById('geo-block-coords').style.display = (mode === 'coords' ? 'block' : 'none');
            document.getElementById('geo-block-branches').style.display = (mode === 'branches' ? 'block' : 'none');
            document.getElementById('geo-block-address').style.display = (mode === 'address' ? 'block' : 'none');
        }

        function showMockBranchesDetailed() {
            // Simulated visualization of many branches
            branchLayerGroup.clearLayers();
            Object.values(cityCoords).forEach(base => {
                for (let i = 0; i < 20; i++) {
                    const lat = base[0] + (Math.random() * 0.1 - 0.05);
                    const lng = base[1] + (Math.random() * 0.1 - 0.05);
                    L.circleMarker([lat, lng], {
                        radius: 2,
                        fillColor: "#ff0000",
                        color: "#fff",
                        weight: 1,
                        opacity: 0.5,
                        fillOpacity: 0.8
                    }).addTo(branchLayerGroup);
                }
            });
        }

        function addSelectionPoint(latlng, label, customRadius = null, customTarget = null) {
            const defaultRadius = parseFloat(document.getElementById('GeoRadius').value) || 5;
            const radiusKm = customRadius !== null ? customRadius : defaultRadius;

            let targetLabel;
            if (customTarget) {
                // Ukrainian target detection from CSV
                const tl = customTarget.toLowerCase();
                if (tl.includes('відпр')) targetLabel = 'Відправлення';
                else if (tl.includes('отрим')) targetLabel = 'Отримання';
                else if (tl.includes('новий')) targetLabel = 'Локація (Новий додаток)';
                else if (tl.includes('старий')) targetLabel = 'Локація (Старий додаток)';
                else targetLabel = customTarget;
            } else {
                const select = document.getElementById('geo-target-type');
                targetLabel = select.options[select.selectedIndex].text;
            }

            // Marker
            const marker = L.marker(latlng).addTo(map).bindPopup(`[${targetLabel}] ${label} (${radiusKm}км)`);

            // Radius circle
            const circle = L.circle(latlng, {
                color: '#4361ee',
                fillColor: '#4361ee',
                fillOpacity: 0.15,
                weight: 2,
                radius: radiusKm * 1000
            }).addTo(map);

            const point = {
                lat: latlng.lat,
                lng: latlng.lng,
                radius: radiusKm,
                label: label,
                target: targetLabel,
                marker: marker,
                circle: circle,
                id: Date.now() + Math.random()
            };

            selectedPoints.push(point);
            updateGeoSelectionUI();
        }

        function toggleUnitType() {
            const type = document.querySelector('input[name="geoUnitType"]:checked').value;
            const addressBlock = document.getElementById('geo-unit-address-block');
            const branchBlock = document.querySelector('.geo-branch-inputs');

            if (type === 'address') {
                addressBlock.style.display = 'block';
                branchBlock.style.display = 'none';
            } else {
                addressBlock.style.display = 'none';
                branchBlock.style.display = 'block';
            }
        }

        function addAddressPoint() {
            const addr = document.getElementById('geo-custom-address').value;
            if (!addr) return;
            // Simulated geocoding near center or current view
            const center = map.getCenter();
            const jittered = [center.lat + (Math.random() - 0.5) * 0.01, center.lng + (Math.random() - 0.5) * 0.01];
            addSelectionPoint(L.latLng(jittered), `Адреса: ${addr}`);
            document.getElementById('geo-custom-address').value = '';
        }

        function handleExcelUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function (e) {
                const content = e.target.result;
                const lines = content.split('\n');
                let addedCount = 0;

                lines.forEach(line => {
                    const parts = line.split(/[,;\t]/);
                    if (parts.length >= 2) {
                        const target = parts[0].trim();
                        const radius = parseFloat(parts[1].trim());
                        const excelTarget = parts.length >= 3 ? parts[2].trim() : null;

                        if (target && !isNaN(radius)) {
                            // Logic: check coords (2 numbers), then branch (mock NP), then address
                            const coordsParts = target.split(/\s+/);
                            if (coordsParts.length === 2 && !isNaN(parseFloat(coordsParts[0]))) {
                                addSelectionPoint(L.latLng(parseFloat(coordsParts[0]), parseFloat(coordsParts[1])), target, radius, excelTarget);
                                addedCount++;
                            } else if (target.includes('Відділення') || cityCoords[target]) {
                                // Simple branch/city heuristic
                                if (cityCoords[target]) {
                                    addSelectionPoint(L.latLng(cityCoords[target]), target, radius, excelTarget);
                                } else {
                                    // Mock branch jitter
                                    const cityMatch = target.match(/\((.*?)\)/);
                                    const city = cityMatch ? cityMatch[1] : 'Київ';
                                    const base = cityCoords[city] || [50, 30];
                                    addSelectionPoint(L.latLng([base[0] + Math.random() * 0.01, base[1] + Math.random() * 0.01]), target, radius, excelTarget);
                                }
                                addedCount++;
                            } else {
                                // Assume it's an address
                                const center = map.getCenter();
                                addSelectionPoint(L.latLng([center.lat + (Math.random() - 0.5) * 0.02, center.lng + (Math.random() - 0.5) * 0.02]), target, radius, excelTarget);
                                addedCount++;
                            }
                        }
                    }
                });
                if (addedCount > 0) {
                    map.fitBounds(L.featureGroup(selectedPoints.map(p => p.circle)).getBounds());
                    alert(`Додано ${addedCount} точок з файлу.`);
                }
            };
            reader.readAsText(file);
        }

        function updateGeoSelectionUI() {
            const chips = document.getElementById('geo-chips-container');
            const count = document.getElementById('geo-points-count');

            chips.innerHTML = '';
            count.innerText = selectedPoints.length;

            if (selectedPoints.length === 0) {
                chips.innerHTML = '<span class="text-muted small italic" style="font-size: 11px;">Локації не вибрані... Додайте точку на мапі або завантажте Excel.</span>';
                return;
            }

            selectedPoints.forEach((p, index) => {
                // Formula Bar Chip
                const chip = document.createElement('div');
                chip.className = 'badge bg-white text-dark border d-flex align-items-center gap-2 px-2 py-1 fw-normal shadow-sm';
                chip.style.fontSize = '11px';
                chip.style.borderRadius = '6px';
                chip.style.borderLeft = '3px solid #4361ee !important';
                chip.innerHTML = `
                    <span class="text-primary fw-bold" style="font-size: 9px;">[${p.target}]</span>
                    <span>${p.label} <small class="text-primary fw-bold">(${p.radius}км)</small></span>
                    <i class="bi bi-x-lg text-danger pointer ms-1" style="font-size: 10px;" onclick="removePoint(${p.id})"></i>
                `;
                chips.appendChild(chip);
            });
        }

        function addManualPoint() {
            const lat = parseFloat(document.getElementById('input-geo-lat').value);
            const lng = parseFloat(document.getElementById('input-geo-lng').value);
            if (!isNaN(lat) && !isNaN(lng)) {
                addSelectionPoint(L.latLng(lat, lng), 'Точка (вручну)');
            } else {
                alert('Введіть коректні координати!');
            }
        }

        function removePoint(id) {
            const idx = selectedPoints.findIndex(p => p.id === id);
            if (idx !== -1) {
                const p = selectedPoints[idx];
                map.removeLayer(p.marker);
                map.removeLayer(p.circle);
                selectedPoints.splice(idx, 1);
                updateGeoSelectionUI();
            }
        }

        function clearGeoSelection() {
            selectedPoints.forEach(p => {
                map.removeLayer(p.marker);
                map.removeLayer(p.circle);
            });
            selectedPoints = [];
            updateGeoSelectionUI();
        }

        function updateMapFromInputs() {
            const lat = parseFloat(document.getElementById('input-geo-lat').value);
            const lng = parseFloat(document.getElementById('input-geo-lng').value);
            if (!isNaN(lat) && !isNaN(lng)) {
                map.setView([lat, lng], 13);
                // Highlight point preview logic could go here
            }
        }

        function updateLastPointRadius() {
            const radiusKm = parseFloat(document.getElementById('GeoRadius').value) || 0;
            if (selectedPoints.length > 0) {
                const p = selectedPoints[selectedPoints.length - 1];
                p.radius = radiusKm;
                p.circle.setRadius(radiusKm * 1000);
                p.marker.getPopup().setContent(`[${p.target}] ${p.label} (${radiusKm}км)`);
                updateGeoSelectionUI();
            }
        }

        function updateLastPointTarget() {
            const select = document.getElementById('geo-target-type');
            const targetLabel = select.options[select.selectedIndex].text;
            if (selectedPoints.length > 0) {
                const p = selectedPoints[selectedPoints.length - 1];
                p.target = targetLabel;
                p.marker.getPopup().setContent(`[${targetLabel}] ${p.label} (${p.radius}км)`);
                updateGeoSelectionUI();
            }
        }

        const cityCoords = {
            'Київ': [50.4501, 30.5234], 'Харків': [49.9935, 36.2304], 'Одеса': [46.4825, 30.7233],
            'Дніпро': [48.4647, 35.0462], 'Львів': [49.8397, 24.0297], 'Запоріжжя': [47.8388, 35.1396],
            'Миколаїв': [46.9750, 31.9946], 'Вінниця': [49.2331, 28.4682], 'Полтава': [49.5883, 34.5514],
            'Чернігів': [51.4982, 31.2893], 'Черкаси': [49.4444, 32.0597], 'Житомир': [50.2547, 28.6587],
            'Суми': [50.9077, 34.7981], 'Хмельницький': [49.4230, 26.9871], 'Рівне': [50.6199, 26.2516],
            'Чернівці': [48.2917, 25.9352], 'Івано-Франківськ': [48.9226, 24.7111], 'Тернопіль': [49.5535, 25.5948],
            'Луцьк': [50.7472, 25.3254], 'Біла Церква': [49.7989, 30.1153], 'Кременчук': [49.0707, 33.4224], 'Ужгород': [48.6208, 22.2879]
        };

        function populateGeoDatalists(selectedCity = null) {
            const cityList = document.getElementById('datalist-cities');
            const branchList = document.getElementById('datalist-branches');
            if (cityList && cityList.options.length === 0) {
                Object.keys(cityCoords).forEach(c => cityList.innerHTML += `<option value="${c}">`);
            }
            if (branchList) {
                branchList.innerHTML = '';
                const citiesToUse = selectedCity ? [selectedCity] : Object.keys(cityCoords);
                citiesToUse.forEach(city => {
                    for (let i = 1; i <= 5; i++) branchList.innerHTML += `<option value="Відділення №${i} (${city})">`;
                });
            }
        }

        function handleMapSelection(type, value) {
            if (!value) return;
            if (type === 'city') {
                const coords = cityCoords[value];
                if (coords) {
                    map.setView(coords, 12);
                    populateGeoDatalists(value);
                    // Оновлюємо поля координат, але НЕ додаємо точку автоматично
                    document.getElementById('input-geo-lat').value = coords[0].toFixed(6);
                    document.getElementById('input-geo-lng').value = coords[1].toFixed(6);
                }
            } else if (type === 'branch') {
                const cityMatch = value.match(/\((.*?)\)/);
                const city = cityMatch ? cityMatch[1] : null;
                const base = cityCoords[city] || [48, 31];
                const jittered = [base[0] + (Math.random() - 0.5) * 0.01, base[1] + (Math.random() - 0.5) * 0.01];
                const latlng = L.latLng(jittered);

                // Оновлюємо поля
                document.getElementById('input-geo-lat').value = latlng.lat.toFixed(6);
                document.getElementById('input-geo-lng').value = latlng.lng.toFixed(6);

                addSelectionPoint(latlng, value);
                map.setView(latlng, 14);
            }
        }

        document.getElementById('tab-c10').addEventListener('shown.bs.tab', function () {
            initMap();
            populateGeoDatalists();
            setTimeout(() => map.invalidateSize(), 200);
        });

        function addGeoFilter() {
            if (selectedPoints.length === 0) {
                alert('Спочатку виберіть хоча б одну точку на мапі!');
                return;
            }
            const desc = selectedPoints.map(p => `${p.label} (${p.radius}км)`).join('; ');
            const val = selectedPoints.map(p => `${p.lat.toFixed(4)},${p.lng.toFixed(4)},${p.radius}`).join('|');
            addEspoBlock('GeoLocation', 'Географія', desc, window.currentFilterMode || 'Include', null);
            clearGeoSelection();
        }


        // --- DATA & STATE ---
        let currentCount = 24500000;
        let pickerState = {
            step: 0,
            field: null,
            linkOp: 'ТА',
            fieldOp: null,
            zone: 'Include'
        };

        const filterRegistry = [
            { id: 'Status', label: 'Статус', type: 'select', options: { 'Active': 'Активний', 'Draft': 'Чернетка', 'Closed': 'Закритий' }, category: 'Основне', icon: 'bi-info-circle' },
            { id: 'Created', label: 'Дата створення', type: 'date', category: 'Часові рамки', icon: 'bi-calendar-plus' },
            { id: 'Modified', label: 'Дата зміни', type: 'date', category: 'Часові рамки', icon: 'bi-calendar-event' },
            { id: 'SubscriptionDate', label: 'Дата підписки', type: 'date', category: 'Часові рамки', icon: 'bi-calendar-check' },
            { id: 'Role', label: 'Роль', type: 'select', options: { 'Sender': 'Відправник', 'Recipient': 'Отримувач' }, category: 'Параметри ЕН', icon: 'bi-person' },
            { id: 'Service', label: 'Сервіс', type: 'select', options: { 'WarehouseWarehouse': 'W-W', 'DoorsDoors': 'D-D', 'WarehouseDoors': 'W-D', 'DoorsWarehouse': 'D-W' }, category: 'Параметри ЕН', icon: 'bi-truck' },
            { id: 'Payer', label: 'Платник', type: 'select', options: { 'Sender': 'Відправник', 'Recipient': 'Отримувач', 'ThirdPerson': 'Третя особа' }, category: 'Параметри ЕН', icon: 'bi-cash' },
            { id: 'City', label: 'Місто', type: 'select', options: { 'Kyiv': 'Київ', 'Kharkiv': 'Харків', 'Lviv': 'Львів', 'Odesa': 'Одеса', 'Dnipro': 'Дніпро' }, category: 'Географія', icon: 'bi-geo-alt' },
            { id: 'EDRPOU', label: 'ЄДРПОУ', type: 'text', category: 'Контрагент', icon: 'bi-building' },
            { id: 'Cargo', label: 'Вантаж', type: 'select', options: { 'Parcel': 'Посилка', 'Documents': 'Документи', 'Pallet': 'Палета' }, category: 'Вантаж', icon: 'bi-box' },
            { id: 'PayMethod', label: 'Метод оплати', type: 'select', options: { 'Cash': 'Готівка', 'Terminal': 'Термінал', 'App': 'Додаток' }, category: 'Фінанси', icon: 'bi-credit-card' },
            { id: 'OS', label: 'ОС', type: 'select', options: { 'iOS': 'iOS', 'Android': 'Android' }, category: 'Пристрої', icon: 'bi-phone-flip' },
            { id: 'Country', label: 'Країна', type: 'select', options: { 'UA': 'Україна', 'PL': 'Польща', 'MD': 'Молдова' }, category: 'Профіль', icon: 'bi-flag' },
            { id: 'Gender', label: 'Стать', type: 'select', options: { 'M': 'Чоловіча', 'F': 'Жіноча' }, category: 'Профіль', icon: 'bi-gender-ambiguous' },
            { id: 'AgeGroup', label: 'Вікова група', type: 'select', options: { '18-25': '18-25', '26-35': '26-35', '36-45': '36-45', '46-55': '46-55', '55+': '55+' }, category: 'Профіль', icon: 'bi-calendar3' },
            { id: 'Lead', label: 'Лід', type: 'select', options: { 'Yes': 'Так', 'No': 'Ні' }, category: 'Профіль', icon: 'bi-person-plus' },
            { id: 'ActivitySegment', label: 'Сегмент активності', type: 'select', options: { 'VIP': 'VIP', 'Active': 'Активний', 'Sleep': 'Сплячий', 'Churn': 'Відтік' }, category: 'Профіль', icon: 'bi-activity' },
            { id: 'POB', label: 'ПОБ', type: 'select', options: { 'Yes': 'Так', 'No': 'Ні' }, category: 'Профіль', icon: 'bi-patch-check' },
            { id: 'Blacklist', label: 'Чорний список (ЧС)', type: 'select', options: { 'Yes': 'Так', 'No': 'Ні' }, category: 'Профіль', icon: 'bi-slash-circle' },
            { id: 'RegionalCenter', label: 'Регіональний центр', type: 'select', options: { 'Kyiv': 'Київ', 'Lviv': 'Львів', 'Odesa': 'Одеса', 'Dnipro': 'Дніпро', 'Kharkiv': 'Харків' }, category: 'Профіль', icon: 'bi-geo' },
            { id: 'ActivitySphere', label: 'Сфера діяльності', type: 'select', options: { 'Retail': 'Retail', 'IT': 'IT', 'FMCG': 'FMCG', 'Logistics': 'Logistics', 'Auto': 'Auto' }, category: 'Профіль', icon: 'bi-briefcase' },
            { id: 'PhoneBrand', label: 'Бренд телефону', type: 'select', options: { 'Apple': 'Apple', 'Samsung': 'Samsung', 'Xiaomi': 'Xiaomi', 'Other': 'Інше' }, category: 'Пристрої', icon: 'bi-phone' },
            { id: 'SettlementType', label: 'Тип нас. пункту', type: 'select', options: { 'City': 'Місто', 'Village': 'Село', 'Town': 'СМТ' }, category: 'Географія', icon: 'bi-house-heart' },
            { id: 'LastENSphereDate', label: 'Дата останьої ЕН по сфері', type: 'date', category: 'Часові рамки', icon: 'bi-calendar-range' },
            { id: 'LastENDate', label: 'Дата останьої ЕН', type: 'date', category: 'Часові рамки', icon: 'bi-calendar-check' },
            { id: 'NextPurchaseProb', label: 'Ймовірність покупки', type: 'text', category: 'Профіль', icon: 'bi-percent' }
        ];

        function openFilterPicker(zone, event, parentId = null) {
            // Normalize parentId to null if undefined
            parentId = parentId === undefined ? null : parentId;

            pickerState = {
                step: 0,
                field: null,
                linkOp: (zone === 'Exclude' ? 'ОКРІМ' : 'ТА'),
                fieldOp: null,
                zone: zone,
                parentId: parentId
            };
            renderPicker();

            const picker = document.getElementById('filter-picker');
            if (!picker) return;

            // Use event.currentTarget if available (inline onclick), or event.target as fallback
            let target = (event && event.currentTarget) ? event.currentTarget : (event ? event.target : null);
            if (!target || (target.tagName === 'I' && target.parentElement.onclick)) {
                // If clicked on icon inside a button with onclick
                target = target.parentElement;
            }
            if (!target) return;

            const rect = target.getBoundingClientRect();
            picker.style.top = (rect.bottom + window.scrollY + 5) + 'px';
            picker.style.left = Math.min(rect.left, window.innerWidth - 340) + 'px';
            picker.style.display = 'block';

            const closer = (e) => {
                if (!picker.contains(e.target) && !target.contains(e.target)) {
                    picker.style.display = 'none';
                    document.removeEventListener('click', closer);
                }
            };
            setTimeout(() => document.addEventListener('click', closer), 10);
        }

        function renderPicker() {
            const picker = document.getElementById('filter-picker');
            picker.innerHTML = '';

            if (pickerState.step === 0) {
                // Step 0: Fields
                picker.innerHTML = '<div class="picker-header">Виберіть параметр:</div>';
                const step = document.createElement('div');
                step.className = 'picker-step';

                // Grouping by category
                const categories = [...new Set(filterRegistry.map(f => f.category))];
                categories.forEach(cat => {
                    const groupTitle = document.createElement('div');
                    groupTitle.className = 'px-3 py-2 bg-light small fw-bold text-muted text-uppercase';
                    groupTitle.innerText = cat;
                    step.appendChild(groupTitle);

                    filterRegistry.filter(f => f.category === cat).forEach(f => {
                        const item = document.createElement('div');
                        item.className = 'picker-item';
                        item.innerHTML = `<i class="bi ${f.icon} text-primary"></i><span>${f.label}</span>`;
                        item.onclick = (e) => {
                            e.stopPropagation();
                            pickerState.field = f;
                            const siblingCount = espoConditionRegistry.filter(i => i.zone === pickerState.zone && i.parentId === pickerState.parentId).length;

                            pickerState.fieldOp = null;

                            pickerState.fieldOp = null;

                            // Important fix: 
                            // 1. If it's the VERY FIRST top-level filter -> skip link selection
                            // 2. For ALL other cases (including nested and 2nd+ top-level) -> show link selection
                            const isFirstTopLevel = (siblingCount === 0 && !pickerState.parentId);

                            if (isFirstTopLevel) {
                                pickerState.linkOp = (pickerState.zone === 'Exclude' ? 'ОКРІМ' : 'ТА');
                                pickerState.step = (f.type === 'date') ? 4 : 2;
                            } else {
                                // This will now correctly trigger for 'Дата створення' if it's not the first one
                                pickerState.step = 1;
                            }
                            renderPicker();
                        };
                        step.appendChild(item);
                    });
                });
                picker.appendChild(step);
            } else if (pickerState.step === 1) {
                // Step 1: Link Operator (TA/ABO)
                picker.innerHTML = `<div class="picker-header"><i class="bi bi-chevron-left me-2" style="cursor:pointer" onclick="pickerState.step=0; renderPicker()"></i> Зв'язок:</div>`;
                const step = document.createElement('div');
                step.className = 'picker-step';

                ['ТА', 'АБО'].forEach(op => {
                    const item = document.createElement('div');
                    item.className = 'picker-item';
                    item.innerHTML = `<span class="fw-bold">${op}</span>`;
                    item.onclick = (e) => {
                        e.stopPropagation();
                        pickerState.linkOp = op;
                        pickerState.step = (pickerState.field.type === 'date') ? 4 : 2;
                        renderPicker();
                    };
                    step.appendChild(item);
                });
                picker.appendChild(step);
            } else if (pickerState.step === 4) {
                // Step 4: Field Operator (Date conditions)
                picker.innerHTML = `<div class="picker-header"><i class="bi bi-chevron-left me-2" style="cursor:pointer" onclick="pickerState.step=1; renderPicker()"></i> Умова дати:</div>`;
                const step = document.createElement('div');
                step.className = 'picker-step';

                const ops = ['сьогодні', 'вчора', 'цього тижня', 'цього місяця', 'після', 'до', 'в діапазоні'];
                ops.forEach(op => {
                    const item = document.createElement('div');
                    item.className = 'picker-item';
                    item.innerHTML = `<span class="fw-bold">${op}</span>`;
                    item.onclick = (e) => {
                        e.stopPropagation();
                        pickerState.fieldOp = op;
                        pickerState.step = 2;
                        renderPicker();
                    };
                    step.appendChild(item);
                });
                picker.appendChild(step);
            } else if (pickerState.step === 2) {
                // Step 2: Value
                const prevStep = (pickerState.field.type === 'date') ? 4 : ((['ТА', 'АБО'].includes(pickerState.linkOp) && espoConditionRegistry.some(i => i.zone === pickerState.zone && i.parentId === pickerState.parentId)) ? 1 : 0);

                picker.innerHTML = `<div class="picker-header"><i class="bi bi-chevron-left me-2" style="cursor:pointer" onclick="pickerState.step=${prevStep}; renderPicker()"></i> Значення:</div>`;
                const step = document.createElement('div');
                step.className = 'picker-input-step';

                if (pickerState.field.type === 'select') {
                    let optionsHtml = '';
                    Object.entries(pickerState.field.options).forEach(([val, label]) => {
                        optionsHtml += `<option value="${val}">${label}</option>`;
                    });
                    step.innerHTML = `
                        <select class="form-select mb-3" id="picker-val-select">${optionsHtml}</select>
                        <button class="btn btn-primary w-100" onclick="completePickerSelection()">Додати</button>
                    `;
                } else if (pickerState.field.type === 'date') {
                    if (['сьогодні', 'вчора', 'цього тижня', 'цього місяця'].includes(pickerState.fieldOp)) {
                        step.innerHTML = `
                            <div class="small mb-3 text-muted text-center">Умова: ${pickerState.field.label} ${pickerState.fieldOp}</div>
                            <button class="btn btn-primary w-100" onclick="completePickerSelection()">Додати умову</button>
                        `;
                    } else if (pickerState.fieldOp === 'в діапазоні') {
                        step.innerHTML = `
                            <input type="date" class="form-control mb-2" id="picker-val-date1">
                            <input type="date" class="form-control mb-3" id="picker-val-date2">
                            <button class="btn btn-primary w-100" onclick="completePickerSelection()">Додати</button>
                        `;
                    } else {
                        step.innerHTML = `
                            <input type="date" class="form-control mb-3" id="picker-val-date">
                            <button class="btn btn-primary w-100" onclick="completePickerSelection()">Додати</button>
                        `;
                    }
                } else {
                    step.innerHTML = `
                        <input type="text" class="form-control mb-3" id="picker-val-input" placeholder="Введіть значення...">
                        <button class="btn btn-primary w-100" onclick="completePickerSelection()">Додати</button>
                    `;
                }
                picker.appendChild(step);
            }
        }

        function completePickerSelection() {
            const field = pickerState.field;
            if (!field) return;

            let valLabel = "";
            if (field.type === 'select') {
                const el = document.getElementById('picker-val-select');
                valLabel = el ? el.options[el.selectedIndex].text : "...";
            } else if (field.type === 'date') {
                if (pickerState.fieldOp === 'в діапазоні') {
                    const d1 = document.getElementById('picker-val-date1')?.value;
                    const d2 = document.getElementById('picker-val-date2')?.value;
                    valLabel = (d1 && d2) ? `${d1} - ${d2}` : "...";
                } else if (!['сьогодні', 'вчора', 'цього тижня', 'цього місяця'].includes(pickerState.fieldOp)) {
                    valLabel = document.getElementById('picker-val-date')?.value || "...";
                } else {
                    valLabel = ""; // Operator name is enough
                }
            } else {
                const el = document.getElementById('picker-val-input');
                valLabel = el ? el.value.trim() : "...";
            }

            addEspoBlock(field.id, field.label, valLabel, pickerState.zone, pickerState.linkOp, pickerState.parentId, pickerState.fieldOp);

            const picker = document.getElementById('filter-picker');
            if (picker) picker.style.display = 'none';
        }

        // --- CONFLICT DETECTION LOGIC ---
        function getBranchSignature(itemId) {
            const item = espoConditionRegistry.find(i => i.id === itemId);
            if (!item) return "";
            let sig = `${item.label}:${item.value}`;
            const children = espoConditionRegistry.filter(c => c.parentId === itemId);
            if (children.length > 0) {
                const childSigs = children.map(c => getBranchSignature(c.id)).sort();
                sig += `[${childSigs.join('|')}]`;
            }
            return sig;
        }

        let espoConditionRegistry = [];

        function addEspoBlock(id, label, value, zone, op, parentId = null, fieldOp = null) {
            // Normalize parentId
            parentId = parentId === undefined ? null : parentId;

            // Advanced conflict check: compare branch signatures
            // We temporarily add the item to generate its signature
            const tempId = Date.now();
            const tempItem = { label, value, zone, parentId: parentId, id: tempId };
            espoConditionRegistry.push(tempItem);
            const newSig = getBranchSignature(tempId);
            espoConditionRegistry.pop(); // Remove it back

            const oppositeZone = zone === 'Include' ? 'Exclude' : 'Include';
            const contradiction = espoConditionRegistry.find(i =>
                i.zone === oppositeZone && getBranchSignature(i.id) === newSig
            );

            if (contradiction) {
                alert(`⚠️ Увага! Це умова суперечить вже існуючій в секції ${oppositeZone === 'Include' ? '"Включити"' : '"Виключити"'}.\nВи намагаєтесь одночасно і включити, і виключити один і той самий параметр.`);
            }

            const noMsg = document.getElementById('no-filters-msg');
            if (noMsg) noMsg.style.display = 'none';

            const item = {
                id: Date.now() + Math.floor(Math.random() * 1000),
                label: label,
                value: value,
                zone: zone,
                op: op || (zone === 'Exclude' ? 'ОКРІМ' : 'ТА'),
                fieldOp: fieldOp,
                interOp: 'ТА',
                bracketOpen: false,
                bracketClose: false,
                parentId: parentId
            };
            espoConditionRegistry.push(item);

            // SYNC: Update previous sibling's interOp to match this new item's op
            const siblings = espoConditionRegistry.filter(s => s.parentId === parentId && s.zone === zone);

            if (siblings.length > 1) {
                const prevSibling = siblings[siblings.length - 2];
                prevSibling.interOp = item.op;
            }

            renderEspoUI();
            updateState();
        }

        function removeEspoBlock(id) {
            const toRemove = [id];
            const collectChildren = (pid) => {
                espoConditionRegistry.forEach(item => {
                    if (item.parentId === pid) {
                        toRemove.push(item.id);
                        collectChildren(item.id);
                    }
                });
            };
            collectChildren(id);

            espoConditionRegistry = espoConditionRegistry.filter(i => !toRemove.includes(i.id));
            renderEspoUI();
            updateState();
        }

        function updateInterOp(id, newOp) {
            const item = espoConditionRegistry.find(i => i.id === id);
            if (item) {
                item.interOp = newOp;
                // Sync next sibling op
                const siblings = espoConditionRegistry.filter(s => s.parentId === item.parentId && s.zone === item.zone);
                const idx = siblings.findIndex(s => s.id === id);
                if (idx !== -1 && idx < siblings.length - 1) {
                    siblings[idx + 1].op = newOp;
                }
                renderEspoUI();
                updateState();
            }
        }

        function renderEspoUI() {
            ['Include', 'Exclude'].forEach(zone => {
                const containerId = zone === 'Include' ? 'espo-include-list' : 'espo-exclude-list';
                const container = document.getElementById(containerId);
                if (container) {
                    container.innerHTML = '';
                    setupEspoDropZone(container, zone);
                    renderConditionLevel(null, zone, container);
                }
            });

            const msg = document.getElementById('no-filters-msg');
            if (msg) {
                if (espoConditionRegistry.length > 0) msg.style.display = 'none';
                else msg.style.display = 'block';
            }

            updateFormulaView();
        }

        function renderConditionLevel(parentId, zone, container) {
            const levelItems = espoConditionRegistry.filter(i => i.parentId === parentId && i.zone === zone);

            levelItems.forEach((item, index) => {
                const isEx = item.zone === 'Exclude';
                const opClass = isEx ? 'op-okrim' : (item.op === 'ТА' ? 'op-ta' : 'op-abo');

                // Show operator if it's not the first item, OR if it's a nested filter
                const displayOp = (index === 0 && !item.parentId) ? '' : item.op;
                const block = document.createElement('div');
                block.className = 'condition-block animate-fade-in';
                block.dataset.id = item.id;
                block.draggable = true;

                block.innerHTML = `
                    <div class="condition-header">
                        ${displayOp ? `<span class="op-tag ${opClass}">${isEx ? 'ОКРІМ' : displayOp}</span>` : ''}
                        <span class="fw-bold ms-1 text-truncate" style="color: #444; font-size: 0.75rem; max-width: 120px;" title="${item.label}">${item.label}</span>
                        <div class="add-sub-btn ms-1" style="width:18px; height:18px;" title="Додати вкладену умову" onclick="openFilterPicker('${zone}', event, ${item.id})">
                            <i class="bi bi-plus"></i>
                        </div>
                        <div class="ms-auto">
                            <i class="bi bi-trash3 text-muted" style="cursor:pointer; font-size: 0.75rem;" onclick="removeEspoBlock(${item.id})"></i>
                        </div>
                    </div>
                    <div class="condition-body">
                        <div class="condition-content-row">
                            <div class="condition-item" style="border-left-color: ${isEx ? '#dc3545' : 'var(--primary-soft)'}">
                                <div class="fs-6" style="font-size: 0.8rem !important;">
                                    ${item.fieldOp ? `<span class="text-muted fw-normal me-1">${item.fieldOp}:</span>` : ''}
                                    <b>${item.value || ''}</b>
                                </div>
                            </div>
                        </div>
                        <div class="sub-conditions-container" id="sub-container-${item.id}" style="display: none;"></div>
                    </div>
                `;

                block.addEventListener('dragstart', (e) => {
                    e.dataTransfer.setData('text/plain', item.id);
                    block.classList.add('dragging');
                    e.stopPropagation();
                });
                block.addEventListener('dragend', () => {
                    block.classList.remove('dragging');
                    syncRegistryFromDOM();
                });

                container.appendChild(block);

                // Render children
                const childContainer = block.querySelector(`#sub-container-${item.id}`);
                setupEspoDropZone(childContainer, zone); // Setup as drop target

                const children = espoConditionRegistry.filter(i => i.parentId === item.id);
                if (children.length > 0) {
                    childContainer.style.display = 'block';
                    renderConditionLevel(item.id, zone, childContainer);
                }

                // Add inter-op if not last in level
                if (index < levelItems.length - 1) {
                    const midOp = document.createElement('div');
                    midOp.className = 'inter-block-op';
                    midOp.innerHTML = `
                        <select class="inter-op-select shadow-sm" onchange="updateInterOp(${item.id}, this.value)">
                            <option value="ТА" ${item.interOp === 'ТА' ? 'selected' : ''}>ТА</option>
                            <option value="АБО" ${item.interOp === 'АБО' ? 'selected' : ''}>АБО</option>
                        </select>
                    `;
                    container.appendChild(midOp);
                }
            });
        }

        function syncRegistryFromDOM() {
            const newRegistry = [];
            const scan = (container, zone, parentId) => {
                const blocks = container.querySelectorAll(':scope > .condition-block');
                blocks.forEach((block, index) => {
                    const id = parseInt(block.dataset.id);
                    const originalItem = espoConditionRegistry.find(i => i.id === id);
                    if (originalItem) {
                        originalItem.zone = zone;
                        originalItem.parentId = parentId;

                        // If it's the first child, it shouldn't have an operator that conflicts with its position
                        if (index === 0) {
                            if (parentId === null) {
                                originalItem.op = (zone === 'Exclude' ? 'ОКРІМ' : 'ТА');
                            } else {
                                // Nested first items are almost always 'ТА' in terms of logical join with parent
                                // But we'll respect the item's existing op unless it's obviously wrong
                            }
                        }

                        newRegistry.push(originalItem);
                        const subContainer = block.querySelector('.sub-conditions-container');
                        if (subContainer) scan(subContainer, zone, id);
                    }
                });
            };
            scan(document.getElementById('espo-include-list'), 'Include', null);
            scan(document.getElementById('espo-exclude-list'), 'Exclude', null);
            espoConditionRegistry = newRegistry;
            renderEspoUI();
            updateState();
        }

        function setupEspoDropZone(container, zone) {
            container.addEventListener('dragover', (e) => {
                e.preventDefault();
                e.stopPropagation();
                container.classList.add('drag-over');
                const dragging = document.querySelector('.dragging');
                if (!dragging) return;

                // Prevent dropping a parent into its own child
                if (dragging.contains(container)) return;

                const afterElement = getDragAfterElement(container, e.clientY);
                if (afterElement == null) container.appendChild(dragging);
                else container.insertBefore(dragging, afterElement);
            });

            container.addEventListener('dragleave', () => {
                container.classList.remove('drag-over');
            });

            container.addEventListener('drop', (e) => {
                e.preventDefault();
                e.stopPropagation();
                container.classList.remove('drag-over');
                syncRegistryFromDOM();
            });
        }

        function getDragAfterElement(container, y) {
            const draggables = [...container.querySelectorAll('.condition-block:not(.dragging)')];
            return draggables.reduce((closest, child) => {
                const box = child.getBoundingClientRect();
                const offset = y - box.top - box.height / 2;
                if (offset < 0 && offset > closest.offset) return { offset: offset, element: child };
                else return closest;
            }, { offset: Number.NEGATIVE_INFINITY }).element;
        }

        function toggleEspoBracket(id, type) {
            const item = espoConditionRegistry.find(i => i.id === id);
            if (item) {
                if (type === 'open') item.bracketOpen = !item.bracketOpen;
                else item.bracketClose = !item.bracketClose;
                renderEspoUI();
            }
        }

        function updateFormulaView() {
            const formulaDisplay = document.getElementById('formula-display');
            if (!formulaDisplay) return;

            if (espoConditionRegistry.length === 0) {
                formulaDisplay.style.display = 'none';
                formulaDisplay.innerHTML = '';
                return;
            }
            formulaDisplay.style.display = 'flex';

            const formatOp = (op) => {
                const lower = op.toLowerCase();
                let cls = 'text-primary';
                if (lower === 'або') cls = 'text-warning';
                if (lower === 'окрім') cls = 'text-danger';
                return `<span class="formula-operator mx-2 fw-bold ${cls}">${lower}</span>`;
            };

            const wrap = (html) => `<span class="formula-bracket">(</span> ${html} <span class="formula-bracket">)</span>`;

            let includeFormula = buildRecursiveFormula(null, 'Include');
            let excludeFormula = buildRecursiveFormula(null, 'Exclude');

            const includeCount = espoConditionRegistry.filter(i => i.parentId === null && i.zone === 'Include').length;
            const excludeCount = espoConditionRegistry.filter(i => i.parentId === null && i.zone === 'Exclude').length;

            // If there is an exclusion, we wrap inclusion in brackets for clarity
            if (excludeCount > 0 && includeFormula) {
                // Only wrap if it's not already starting/ending with brackets from buildRecursiveFormula
                const trimmed = includeFormula.trim();
                const startsWithBracket = trimmed.startsWith('<span class="formula-bracket">(</span>');
                const endsWithBracket = trimmed.endsWith('<span class="formula-bracket">)</span>');

                // If it has multiple top-level items OR doesn't have outer brackets, wrap it.
                if (includeCount > 1 || !startsWithBracket || !endsWithBracket) {
                    includeFormula = wrap(includeFormula);
                }
            }

            const wrapDanger = (html) => `<span class="formula-bracket is-danger">(</span> ${html} <span class="formula-bracket is-danger">)</span>`;

            let finalHtml = includeFormula;
            if (includeFormula && excludeFormula) {
                finalHtml += ` ${formatOp('окрім')} ${wrapDanger(excludeFormula)}`;
            } else if (excludeFormula) {
                finalHtml = `${formatOp('окрім')} ${wrapDanger(excludeFormula)}`;
            }

            formulaDisplay.innerHTML = finalHtml;

            // Handle truncation button
            let expandBtn = formulaDisplay.querySelector('.formula-expand-btn');
            if (finalHtml) {
                if (!expandBtn) {
                    expandBtn = document.createElement('div');
                    expandBtn.className = 'formula-expand-btn';
                    expandBtn.innerHTML = '<i class="bi bi-three-dots"></i>';
                    expandBtn.onclick = (e) => {
                        e.stopPropagation();
                        const isExpanded = formulaDisplay.classList.toggle('is-expanded');
                        expandBtn.innerHTML = isExpanded ? '<i class="bi bi-chevron-up"></i>' : '<i class="bi bi-three-dots"></i>';
                    };
                    formulaDisplay.appendChild(expandBtn);
                }

                // Show/hide button based on actual overflow
                // We reset expansion to check original height
                const originalExpansion = formulaDisplay.classList.contains('is-expanded');
                formulaDisplay.classList.remove('is-expanded');
                if (formulaDisplay.scrollHeight > formulaDisplay.clientHeight + 5) {
                    expandBtn.style.display = 'flex';
                } else {
                    expandBtn.style.display = 'none';
                    formulaDisplay.classList.remove('is-expanded');
                }
                if (originalExpansion) {
                    formulaDisplay.classList.add('is-expanded');
                    expandBtn.innerHTML = '<i class="bi bi-chevron-up"></i>';
                }
            } else {
                if (expandBtn) expandBtn.remove();
                formulaDisplay.classList.remove('is-expanded');
            }
        }

        function buildRecursiveFormula(parentId, zone) {
            const items = espoConditionRegistry.filter(i => i.parentId === parentId && i.zone === zone);
            if (items.length === 0) return "";

            const formatOp = (op) => {
                const lower = op.toLowerCase();
                let cls = 'text-primary';
                if (lower === 'або') cls = 'text-warning';
                if (lower === 'окрім') cls = 'text-danger';
                return `<span class="formula-operator mx-1 fw-bold ${cls}">${lower}</span>`;
            };

            const wrapGroup = (html) => {
                const bCls = zone === 'Exclude' ? 'formula-bracket is-danger' : 'formula-bracket';
                return `<span class="formula-group"><span class="${bCls}">(</span> ${html} <span class="${bCls}">)</span></span>`;
            };

            // Group items by operator precedence: AND (TA) binds tighter than OR (ABO)
            // We split items into groups separated by 'ABO'
            const groups = [];
            let currentGroup = [];

            items.forEach((item, index) => {
                const oppositeZone = zone === 'Include' ? 'Exclude' : 'Include';
                const hasConflict = espoConditionRegistry.some(i =>
                    i.zone === oppositeZone &&
                    i.label === item.label &&
                    i.value === item.value &&
                    i.fieldOp === item.fieldOp
                );

                const displayValue = item.fieldOp ? `${item.fieldOp} ${item.value || ''}` : (item.value || item.op);
                let bit = `<span class="formula-item ${hasConflict ? 'is-conflict' : ''}" ${hasConflict ? 'title="Конфлікт: це значення присутнє в обох зонах"' : ''}><b>${item.label}:</b> ${displayValue}</span>`;
                const childrenFormula = buildRecursiveFormula(item.id, zone);
                if (childrenFormula) {
                    // Use the operator of the first child to join parent with its sub-group.
                    // This matches the visual tag shown in the UI.
                    const children = espoConditionRegistry.filter(i => i.parentId === item.id && i.zone === zone);
                    const nestOp = children.length > 0 ? children[0].op : 'ТА';
                    const bCls = zone === 'Exclude' ? 'formula-bracket is-danger' : 'formula-bracket';
                    bit = `<span class="${bCls}">(</span> ${bit} ${formatOp(nestOp)} ${childrenFormula} <span class="${bCls}">)</span>`;
                }

                currentGroup.push(bit);

                // If this is not the last item, check the operator to the next item
                if (index < items.length - 1) {
                    if (item.interOp === 'АБО') {
                        groups.push({ html: currentGroup.join(` ${formatOp('ТА')} `), isAndGroup: currentGroup.length > 1 });
                        currentGroup = [];
                    }
                } else {
                    groups.push({ html: currentGroup.join(` ${formatOp('ТА')} `), isAndGroup: currentGroup.length > 1 });
                }
            });

            // If we have mixed operators (multiple groups or an and-group in a single list), 
            // wrap the AND-chains in brackets for clarity
            const formattedGroups = groups.map(g => (g.isAndGroup && groups.length > 1) ? wrapGroup(g.html) : g.html);

            return formattedGroups.join(` ${formatOp('АБО')} `);
        }

        function updateFiltersCount() {
            updateFormulaView();
        }


        // --- 1. TABS SYSTEM ---


        // --- 1. TABS SYSTEM ---
        function switchTab(tabId) {
            // Hide all sections
            document.querySelectorAll('.view-section').forEach(el => el.classList.add('d-none'));
            // Show target
            document.getElementById(`view-${tabId}`).classList.remove('d-none');

            // Update Nav
            document.querySelectorAll('.nav-link').forEach(el => el.classList.remove('active'));
            document.getElementById(`tab-${tabId}`).classList.add('active');

            updateState();
        }

        // Helper to create tag
        window.currentFilterMode = 'Include';
        function createTag(type, value, operator) {
            const categoryMap = {
                // c1
                'Role': 'Роль в ЕН', 'ServiceType': 'Тип сервісу', 'Payer': 'Платник',
                'DateCreated': 'Дата створення ЕН', 'DateClosed': 'Дата закриття ЕН',
                'CreatedPlace': 'Місце створення', 'CreatedType': 'Тип місця створ.',
                'LastServicePointType': 'Тип ост. точки', 'Import': 'Імпорт', 'Export': 'Експорт',
                'SecondaryEN': 'Вторинні ЕН', 'ReturnReason': 'Причина повернення', 'ENProblemType': 'Вид проблеми',
                // c2
                'SenderType': 'Тип відпр.', 'SenderEDRPOU': 'ЄДРПОУ відпр.', 'SenderUnitType': 'Тип підр. відпр.',
                'SenderArea': 'Область відпр.', 'SenderCity': 'Місто відпр.', 'SenderUnit': 'Підрозділ відпр.',
                'RecipientType': 'Тип отрим.', 'RecipientEDRPOU': 'ЄДРПОУ отрим.', 'RecipientUnitType': 'Тип підр. отрим.',
                'RecipientArea': 'Область отрим.', 'RecipientCity': 'Місто отрим.', 'RecipientUnit': 'Підрозділ отрим.',
                // c3
                'CargoType': 'Тип вантажу', 'CargoDesc': 'Опис вантажу', 'Weight': 'Вага',
                'DeclaredValue': 'Огол. вартість', 'DeliverySum': 'Сума за дост.', 'PackingSum': 'Сума за пак.',
                'PayType': 'Тип оплати', 'TransferAvailability': 'Наявність переказу', 'TransferSum': 'Сума переказу',
                'PretenseAvailability': 'Претензії', 'PromoAvailability': 'Промокод', 'Marketplace': 'Маркетплейс',
                // c4
                'ClientNPU': 'Клієнт НПУ', 'ClientCountry': 'Країна клієнта', 'Gender': 'Стать', 'AddPhoneAvailability': 'Дод. тел.',
                'Birthday': 'День народження', 'ClientVerification': 'Верифікація клієнта',
                'PhoneVerificationStatus': 'Вер. телефону', 'EmailVerificationStatus': 'Вер. Email',
                'FirstVerificationNovaPay': 'Вер. NovaPay', 'VerificationDate': 'Дата вериф.', 'LastVerificationDate': 'Остання вер.',
                // c5
                'FirstTransactionDate': 'Дата перш. транз.', 'LastTransactionDate': 'Дата ост. транз.',
                'FavoritePoint': 'Улюб. точка', 'LastPointCity': 'Місто ост. точки',
                'MainBranchCity': 'Місто осн. відд.', 'ReserveBranchCity': 'Місто рез. відд.',
                'MainPostomatCity': 'Місто осн. пошт.', 'ReservePostomatCity': 'Місто рез. пошт.',
                'LastServicePoint': 'Ост. точка', 'MainBranch': 'Осн. відділення', 'ReserveBranch': 'Рез. відділення',
                'MainPostomat': 'Осн. поштомат', 'ReservePostomat': 'Рез. поштомат',
                // c6
                'AppUser': 'Користувач моб. додатка',
                'OldAppDevice': 'Девайс (стар. дод.)', 'OldAppOS': 'ОС (стар. дод.)', 'OldAppLoginDate': 'Вхід (стар. дод.)',
                'NewAppDevice': 'Девайс (нов. дод.)', 'NewAppOS': 'ОС (нов. дод.)', 'NewAppLoginDate': 'Вхід (нов. дод.)',
                // c7
                'ConsentBranchOpening': 'Згода (відкр. відд.)', 'ConsentPolls': 'Згода на опитування',
                'ConsentPromo': 'Згода на проморозсилки', 'ConsentOffers': 'Згода на пропозиції',
                // New Fields
                'AgeGroup': 'Вікова група', 'Lead': 'Лід', 'ActivitySegment': 'Сегмент активності',
                'POB': 'ПОБ', 'Blacklist': 'Чорний список (ЧС)', 'RegionalCenter': 'Регіональний центр',
                'ActivitySphere': 'Сфера діяльності',
                'SettlementType': 'Тип нас. пункту', 'LastENSphereDate': 'Дата останьої ЕН по сфері',
                'LastENDate': 'Дата останьої ЕН',
                'NextPurchaseProb': 'Ймовірність покупки'
            };

            // Priority: Local override (Include/Exclude/NOT) > Global Toggle
            let zone = window.currentFilterMode || 'Include';
            let fieldOp = null;

            if (operator === 'NOT' || operator === 'Exclude') {
                zone = 'Exclude';
                operator = null;
            } else if (operator === 'Include') {
                zone = 'Include';
                operator = null;
            }

            if (operator === 'LIKE') {
                fieldOp = 'містить';
            } else if (operator === 'EXACT') {
                fieldOp = 'точне';
            } else if (operator === 'STARTS_WITH') {
                fieldOp = 'починається з';
            } else if (operator === 'ENDS_WITH') {
                fieldOp = 'закінчується на';
            } else if (operator) {
                fieldOp = operator;
            }

            addEspoBlock(type, categoryMap[type] || type, value, zone, 'ТА', null, fieldOp);
        }

        function addTextTag(inputElement, type) {
            const value = inputElement.value.trim();
            if (!value) return;

            let operator = "LIKE";

            // Check for search mode selector (like in CargoDesc)
            const fieldContainer = inputElement.closest('[data-field-id]');
            const modeSelect = fieldContainer ? fieldContainer.querySelector('#cargo-search-mode') : null;

            if (modeSelect) {
                operator = modeSelect.value;
            } else if (inputElement.previousElementSibling && inputElement.previousElementSibling.tagName === 'SELECT') {
                operator = inputElement.previousElementSibling.value;
            }

            createTag(type, value, operator);
            inputElement.value = '';
            updateState();
        }

        function addTag(selectElement, type) {
            if (!selectElement.value) return;

            const value = selectElement.options[selectElement.selectedIndex].text;
            let operator = null; // Let global toggle decide if no local select
            if (selectElement.previousElementSibling && selectElement.previousElementSibling.tagName === 'SELECT') {
                operator = selectElement.previousElementSibling.value;
            }
            createTag(type, value, operator);
            setTimeout(() => selectElement.value = "", 100);
        }

        function toggleRangeAll(baseId, isAll) {
            const toInput = document.getElementById(baseId + '-to');
            if (toInput) {
                toInput.disabled = isAll;
                if (isAll) toInput.value = '';
            }
        }

        function addRangeTag(type, label, fromId, toId) {
            const from = document.getElementById(fromId).value;
            const to = document.getElementById(toId).value;
            if (!from && !to) return;

            let val = "";
            if (from && to) val = `${from} - ${to}`;
            else if (from) val = `з ${from}`;
            else if (to) val = `до ${to}`;

            addEspoBlock(type, label, val, window.currentFilterMode || 'Include', 'ТА');
            document.getElementById(fromId).value = "";
            document.getElementById(toId).value = "";
            updateState();
        }

        function removeTag(iconEl) {
            const pill = iconEl.parentElement;
            pill.remove();

            // Check if empty to hide container (for legacy tags)
            const container = document.getElementById('global-tags-container');
            if (container && container.children.length === 0) {
                const summary = document.getElementById('active-filters-summary');
                if (summary) summary.classList.add('d-none');
            }
            updateState();
            updateFiltersCount();
        }


        function clearFilters() {
            espoConditionRegistry = [];
            renderEspoUI();

            document.querySelectorAll('input').forEach(el => {
                if (el.type !== 'radio' && el.type !== 'checkbox' && el.id !== 'ai-format') el.value = '';
                if (el.type === 'checkbox' && !el.id.includes('toggle')) el.checked = false;
            });
            document.querySelectorAll('select').forEach(el => {
                if (el.id !== 'ai-format' && el.id !== 'constructor-format') el.value = "";
            });
            updateState();
            updateFiltersCount();
        }

        // --- 3. COUNTER ANIMATION ---
        function updateState() {
            const display = document.getElementById('counter-display');
            const mobileDisplay = document.getElementById('mobile-counter-display');

            if (display) {
                display.style.opacity = '0.5';
                display.classList.remove('counter-animate');
            }
            if (mobileDisplay) mobileDisplay.style.opacity = '0.5';

            setTimeout(() => {
                // Random count between 10k and 24M for simulation
                const randomCount = Math.floor(Math.random() * (24000000 - 10000) + 10000);
                const formatted = new Intl.NumberFormat('en-US', { notation: "compact", compactDisplay: "short" }).format(randomCount);

                if (display) {
                    display.innerText = formatted;
                    display.style.opacity = '1';
                    display.classList.add('counter-animate');
                }
                if (mobileDisplay) {
                    mobileDisplay.innerText = formatted;
                    mobileDisplay.style.opacity = '1';
                }

                // Trigger Analytics Update
                updateAnalytics();
            }, 300);
        }

        // --- 4. LOOK-A-LIKE LOGIC ---
        function handleLookalikeInput(event, type) {
            if (event.key === 'Enter') {
                event.preventDefault();
                addLalTag(type);
            }
        }

        function addLalTag(type) {
            const input = document.getElementById(`lal-${type}`);
            const val = input.value.trim();
            if (!val) return;

            const container = document.getElementById(`tags-lal-${type}`);
            const pill = document.createElement('div');
            pill.className = 'tag-pill';
            pill.innerHTML = `${val} <i class="bi bi-x" onclick="this.parentElement.remove(); updateState()"></i>`;
            container.appendChild(pill);

            input.value = '';
            updateState();
        }

        // --- 5. AI ASSISTANT LOGIC ---
        // --- 5. GENERATION Logic (Unified) ---
        function fillAiPrompt(text) {
            document.getElementById('ai-prompt').value = text;
        }

        // Wrapper for AI specific (backward compatibility or specific logic)
        function handleAiRequest() {
            handleGeneration('ai');
        }

        // --- NEW VIEW SWITCHING ---
        function switchView(viewId) {
            // Updated Nav Pias
            document.querySelectorAll('#app-views-nav .nav-link').forEach(btn => btn.classList.remove('active'));
            const navBtn = document.getElementById('nav-btn-' + viewId);
            if (navBtn) navBtn.classList.add('active');

            // Hide all views
            document.querySelectorAll('.view-section').forEach(view => view.classList.add('d-none'));

            // Show selected view
            const target = document.getElementById('view-' + viewId);
            if (target) {
                target.classList.remove('d-none');
                target.classList.add('animate-fade-in');
            }

            // Mock Counter Updates
            const counter = document.getElementById('counter-display');
            const mobileCounter = document.getElementById('mobile-counter-display');
            let val = '10.5M';
            if (viewId === 'lookalike') val = '4.1M';
            else if (viewId === 'ai') val = '16M';

            if (counter) counter.innerText = val;
            if (mobileCounter) mobileCounter.innerText = val;
        }

        function handleAiRequest() {
            handleGeneration('ai');
        }

        // Simple mock for input handling in lookalike
        function handleLookalikeInput(event, type) {
            if (event.key === 'Enter') {
                event.preventDefault();
                const val = event.target.value.trim();
                if (val) {
                    addLalTag(type, val);
                    event.target.value = '';
                }
            }
        }

        function addLalTag(type, value = null) {
            // If called from button, get val from input
            if (!value) {
                const input = document.getElementById('lal-' + type);
                if (input) {
                    value = input.value.trim();
                    input.value = '';
                }
            }
            if (!value) return;

            const container = document.getElementById('tags-lal-' + type);
            const pill = document.createElement('div');
            pill.className = 'tag-pill';
            pill.innerHTML = `${value} <i class="bi bi-x" onclick="this.parentElement.remove()"></i>`;
            container.appendChild(pill);
        }

        function fillAiPrompt(text) {
            const area = document.getElementById('ai-prompt');
            if (area) {
                area.value = text;
                area.focus();
            }
        }

        // Multi-select Logic
        function updateMultiSelect(baseId) {
            const dropdown = document.getElementById(baseId + '-dropdown');
            if (!dropdown) return;

            const checkboxes = dropdown.querySelectorAll('.form-check-input:checked');
            const values = Array.from(checkboxes).map(cb => cb.value);
            const hiddenInput = document.getElementById(baseId);
            const buttonText = dropdown.querySelector('.selected-values');

            // Map values to labels for display
            const labelsMap = {
                'phone': 'Телефон',
                'cid': 'CID',
                'email': 'E-mail',
                'audience_id': 'ID Аудиторії'
            };

            if (values.length === 0) {
                buttonText.innerText = 'Оберіть формат...';
                buttonText.classList.add('text-muted');
                buttonText.classList.remove('text-dark');
                hiddenInput.value = '';
            } else {
                const labels = values.map(v => labelsMap[v] || v);
                buttonText.innerText = labels.join(', ');
                buttonText.classList.remove('text-muted');
                buttonText.classList.add('text-dark');
                hiddenInput.value = values.join(','); // Store as CSV
            }

            // Sync AI Assistants buttons if needed
            if (baseId === 'constructor-format-unified') {
                const aiCheckboxes = document.querySelectorAll('input[name="ai-format-sync"]');
                aiCheckboxes.forEach(cb => {
                    cb.checked = values.includes(cb.value);
                });
            }
        }

        function syncAiFormat() {
            // Collect all checked formats in AI tab
            const aiCheckedValues = Array.from(document.querySelectorAll('input[name="ai-format-sync"]:checked')).map(cb => cb.value);

            // Update sidebar unified multi-select
            const sidebarCheckboxes = document.querySelectorAll('#constructor-format-unified-dropdown .form-check-input');
            sidebarCheckboxes.forEach(cb => {
                cb.checked = aiCheckedValues.includes(cb.value);
            });

            // Trigger UI update for the unified selector
            updateMultiSelect('constructor-format-unified');
        }

        function syncLalFormat() {
            // Collect all checked formats in Look-alike tab
            const lalCheckedValues = Array.from(document.querySelectorAll('input[name="lal-format-sync"]:checked')).map(cb => cb.value);

            // Update sidebar unified multi-select
            const sidebarCheckboxes = document.querySelectorAll('#constructor-format-unified-dropdown .form-check-input');
            sidebarCheckboxes.forEach(cb => {
                cb.checked = lalCheckedValues.includes(cb.value);
            });

            // Trigger UI update for the unified selector
            updateMultiSelect('constructor-format-unified');
        }

        function toggleLalParcelsMode(select) {
            const container = select.closest('.d-flex');
            const inputFrom = container.querySelector('.input-from');
            const inputTo = container.querySelector('.input-to');
            const separator = container.querySelector('.range-separator');

            if (select.value === 'range') {
                inputTo.classList.remove('d-none');
                if (separator) separator.classList.remove('d-none');
                inputFrom.placeholder = 'Від';
            } else {
                inputTo.classList.add('d-none');
                if (separator) separator.classList.add('d-none');
                inputFrom.placeholder = 'Кількість';
            }
            updateState();
        }

        function addParcelsTag(btn) {
            const container = btn.closest('.d-flex');
            const select = container.querySelector('select');
            const inputFrom = container.querySelector('.input-from');
            const inputTo = container.querySelector('.input-to');

            const mode = select.value;
            const valFrom = inputFrom.value;
            const valTo = inputTo.value;

            let displayVal = "";
            let fieldOp = null;

            if (mode === 'range') {
                displayVal = `${valFrom} - ${valTo}`;
                fieldOp = "в діапазоні";
            } else if (mode === '>') {
                displayVal = valFrom;
                fieldOp = "більше ніж";
            } else if (mode === '<') {
                displayVal = valFrom;
                fieldOp = "менше ніж";
            }

            addEspoBlock('ParcelsCount', 'Кількість посилок', displayVal, window.currentFilterMode, 'ТА', null, fieldOp);
        }

        function handleGeneration(source) {
            // source: 'constructor', 'lookalike', 'ai'

            let formatId = source + '-format';
            let resultsId = source + '-results';
            let tableBodyId = source + '-table-body';

            // IF AI OR Look-alike, we use the UNIFIED format from sidebar
            if (source === 'ai' || source === 'lookalike') formatId = 'constructor-format-unified';

            // Only AI has SQL preview, others just table

            const formatEl = document.getElementById(formatId);
            if (!formatEl) return; // Error

            const format = formatEl.value;

            // Prompt check specific to AI
            if (source === 'ai') {
                const prompt = document.getElementById('ai-prompt').value;
                if (!prompt) {
                    alert('Будь ласка, введіть запит!');
                    return;
                }
            }

            if (!format) {
                alert('Будь ласка, оберіть формат вибірки!');
                formatEl.focus();
                return;
            }

            // Button Loading State
            // Find the button inside the active view or close to the select
            const btn = formatEl.closest('.row').querySelector('button');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Обробка...';
            btn.disabled = true;

            setTimeout(() => {
                // If AI, show SQL
                if (source === 'ai') {
                    // Build SQL Mock
                    let sql = "";
                    let tableMapping = "Clients"; // Generic
                    if (format === "phone") tableMapping = "Clients JOIN Parcels ON Clients.id = Parcels.sender_id";

                    sql = `<span class="sql-keyword">SELECT DISTINCT</span> <span class="sql-field">${format === 'audience_id' ? 'COUNT(*)' : getSqlField(format)}</span> <br>`;
                    sql += `<span class="sql-keyword">FROM</span> <span class="sql-table">${tableMapping}</span> <br>`;
                    sql += `<span class="sql-keyword">WHERE</span> <span class="sql-field">Country</span> = <span class="sql-string">'UA'</span> <br>`;
                    sql += `<span class="sql-keyword">AND</span> <span class="sql-field">Date</span> > <span class="sql-keyword">DATE_SUB</span>(NOW(), <span class="sql-keyword">INTERVAL</span> 30 <span class="sql-keyword">DAY</span>);`;

                    document.getElementById('sql-code').innerHTML = sql;
                }

                // Show Results Container
                document.getElementById(resultsId).classList.remove('d-none');

                // Render Table
                renderResultTable(format, tableBodyId);

                // For Audience ID, we might show Alert instead of table (optional, keeping table for consistency unless requested otherwise)
                // The user asked for "Preview" on all tabs.
                // In previous AI logic, audience_id showed an alert. Let's keep table for simplicity or handle special case.

                // Reset Button
                btn.innerHTML = originalText;
                btn.disabled = false;

                // Scroll to results
                document.getElementById(resultsId).scrollIntoView({ behavior: 'smooth', block: 'nearest' });

            }, 1000);
        }

        function getSqlField(format) {
            switch (format) {
                case 'phone': return 'Phone';
                case 'email': return 'Email';
                case 'cid': return 'CID';
                default: return '*';
            }
        }

        function renderResultTable(format, tbodyId) {
            const tbody = document.getElementById(tbodyId);
            if (!tbody) return;

            tbody.innerHTML = '';

            // Generate clean mock data based on format
            let mockData = [];

            if (format === 'phone') {
                mockData = ['380950001122', '380670003344', '380630005566', '380500007788', '380930009900'];
            } else if (format === 'email') {
                mockData = ['user1@gmail.com', 'alex@ukr.net', 'maria@work.ua', 'info@shop.com', 'client@bk.com'];
            } else if (format === 'cid') {
                mockData = ['10029394', '29384858', '33029485', '49583020', '50693021'];
            } else {
                mockData = ['AUD-2023-A', 'AUD-2023-B', 'AUD-2023-C', 'AUD-2023-D', 'AUD-2023-E']; // Audience IDs
            }

            mockData.forEach((val, i) => {
                const tr = `<tr>
                    <td style="width: 50px;">${i + 1}</td>
                    <td class="font-monospace text-primary fw-bold">${val}</td>
                </tr>`;
                tbody.innerHTML += tr;
            });

            // Find the table header to update column name
            // tbody -> table -> thead -> tr -> th:nth-child(2)
            const table = tbody.closest('table');
            const th = table.querySelector('thead tr th:nth-child(2)');
            if (th) {
                switch (format) {
                    case 'phone': th.innerText = 'Телефон (MP)'; break;
                    case 'email': th.innerText = 'E-mail'; break;
                    case 'cid': th.innerText = 'CID'; break;
                    default: th.innerText = 'ID Аудиторії'; break;
                }
            }
        }

        // --- 6. PRESETS LOGIC ---
        function applyPersona(type) {
            // Need to switch to Constructor tab if not active
            switchView('constructor');

            // Clear first
            clearFilters();

            // Wait for visual reset then apply
            setTimeout(() => {
                if (type === 'vip') {
                    // High check, iPhone
                    addMockTag('c3', 'Оголошена вартість', '> 5000');
                    addMockTag('c6', 'Девайс', 'iPhone');
                    addMockTag('c2', 'Місто', 'Kyiv');
                } else if (type === 'churn') {
                    // Inactive
                    addMockTag('c5', 'Остання активність', '> 60 днів');
                }
                updateState();
            }, 200);
        }

        function addMockTag(fakeContainerId, type, value) {
            // Updated to use global container (ignoring fakeContainerId arg)
            const container = document.getElementById('global-tags-container');
            const summaryBlock = document.getElementById('active-filters-summary');

            if (summaryBlock.classList.contains('d-none')) {
                summaryBlock.classList.remove('d-none');
            }

            const pill = document.createElement('div');
            pill.className = 'tag-pill';
            pill.innerHTML = `<span class="fw-light text-secondary me-1">${type}:</span> ${value} <i class="bi bi-x" onclick="removeTag(this)"></i>`;
            container.appendChild(pill);
        }

        // --- 7. NEW FEATURES (PREMIUM) ---

        // 7.1 DARK MODE
        function toggleTheme() {
            const body = document.body;
            const icon = document.getElementById('theme-icon');

            if (body.hasAttribute('data-theme')) {
                body.removeAttribute('data-theme');
                icon.className = 'bi bi-moon-stars-fill';
                localStorage.setItem('theme', 'light');
            } else {
                body.setAttribute('data-theme', 'dark');
                icon.className = 'bi bi-sun-fill';
                localStorage.setItem('theme', 'dark');
            }
            updateChartColors();
        }

        // Init Theme
        if (localStorage.getItem('theme') === 'dark') {
            document.body.setAttribute('data-theme', 'dark');
            const icon = document.getElementById('theme-icon');
            if (icon) icon.className = 'bi bi-sun-fill';
        }

        // 7.2 INSTANT ANALYTICS
        let chartInstances = {};

        function initCharts() {
            // Only init if panel is visible or allows to be loaded
            // We'll create them once
            const ctxGender = document.getElementById('chart-gender').getContext('2d');
            const ctxDevice = document.getElementById('chart-device').getContext('2d');
            const ctxCities = document.getElementById('chart-cities').getContext('2d');

            const commonOptions = {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { position: 'right', labels: { boxWidth: 10, font: { size: 10 } } } }
            };

            chartInstances.gender = new Chart(ctxGender, {
                type: 'doughnut',
                data: { labels: ['Ч', 'Ж'], datasets: [{ data: [45, 55], backgroundColor: ['#4361ee', '#f72585'] }] },
                options: commonOptions
            });

            chartInstances.device = new Chart(ctxDevice, {
                type: 'doughnut',
                data: { labels: ['iOS', 'Android', 'Other'], datasets: [{ data: [60, 35, 5], backgroundColor: ['#000000', '#3ddc84', '#6c757d'] }] },
                options: commonOptions
            });

            chartInstances.cities = new Chart(ctxCities, {
                type: 'bar',
                data: { labels: ['Kyiv', 'Lviv', 'Odessa', 'Dnipro', 'Kharkiv'], datasets: [{ label: 'Users', data: [50, 20, 15, 10, 5], backgroundColor: '#4cc9f0' }] },
                options: { ...commonOptions, plugins: { legend: { display: false } }, indexAxis: 'y' }
            });

            updateChartColors();
        }

        function updateAnalytics() {
            // Check if modal is actually trying to be shown or just background update
            // With Modal logic, we only render if charts exist (which means modal was opened at least once or we force it)
            // But Chart.js needs a visible canvas usually. 
            // We'll rely on the user clicking the button to "view" analytics, or auto-update if chart instances exist.

            if (!chartInstances.gender) {
                // Charts not initialized yet.
                // If Modal is open, init. If not, wait.
                const modal = document.getElementById('analyticsModal');
                if (modal.classList.contains('show')) {
                    setTimeout(initCharts, 200);
                }
                return;
            }

            // Normal update logic
            const r = () => Math.floor(Math.random() * 100);

            // Gender
            chartInstances.gender.data.datasets[0].data = [r(), r()];
            chartInstances.gender.update();

            // Device
            chartInstances.device.data.datasets[0].data = [r(), r(), 10];
            chartInstances.device.update();

            // Cities
            chartInstances.cities.data.datasets[0].data = [r(), r(), r(), r(), r()].sort((a, b) => b - a);
            chartInstances.cities.update();
        }

        // Listener for modal open to init charts for first time
        document.addEventListener('DOMContentLoaded', () => {
            const modal = document.getElementById('analyticsModal');
            modal.addEventListener('shown.bs.modal', function () {
                if (!chartInstances.gender) {
                    initCharts();
                } else {
                    updateAnalytics();
                }
            });
        });

        function updateChartColors() {
            if (!chartInstances.gender) return;

            const isDark = document.body.hasAttribute('data-theme');
            const textColor = isDark ? '#a0aec0' : '#6c757d';
            const gridColor = isDark ? '#2d3748' : '#e9ecef';

            [chartInstances.gender, chartInstances.device, chartInstances.cities].forEach(chart => {
                // Update Legend
                if (chart.options.plugins && chart.options.plugins.legend) {
                    chart.options.plugins.legend.labels.color = textColor;
                }
                // Update Scales (for Bar chart)
                if (chart.options.scales) {
                    Object.values(chart.options.scales).forEach(scale => {
                        if (scale.ticks) scale.ticks.color = textColor;
                        if (scale.grid) scale.grid.color = gridColor;
                    });
                }
                chart.update();
            });
        }


        // 7.3 SAVED SEGMENTS (LocalStorage)
        function saveCurrentSegment() {
            // Open Modal
            const modalEl = document.getElementById('saveSegmentModal');
            const modal = new bootstrap.Modal(modalEl);
            // Default name
            document.getElementById('segmentNameInput').value = "Мій сегмент " + new Date().toLocaleDateString();
            modal.show();
        }

        function confirmSaveSegment() {
            const nameInput = document.getElementById('segmentNameInput');
            const name = nameInput.value.trim() || 'Без назви';

            // Collect active tags
            const tags = [];
            document.querySelectorAll('.tag-pill').forEach(pill => {
                tags.push(pill.innerText.replace('x', '').trim());
            });

            const segment = {
                id: Date.now(),
                name: name,
                tags: tags,
                count: document.getElementById('counter-display').innerText
            };

            const saved = JSON.parse(localStorage.getItem('mySegments') || '[]');
            saved.push(segment);
            localStorage.setItem('mySegments', JSON.stringify(saved));

            // Close modal
            const modalEl = document.getElementById('saveSegmentModal');
            const modal = bootstrap.Modal.getInstance(modalEl);
            modal.hide();

            renderSavedSegments();
        }

        function renderSavedSegments() {
            const list = document.getElementById('header-saved-segments-list');
            const saved = JSON.parse(localStorage.getItem('mySegments') || '[]');
            const badge = document.getElementById('segments-badge');

            if (saved.length > 0) {
                if (badge) badge.style.display = 'block';
            } else {
                if (badge) badge.style.display = 'none';
            }

            if (saved.length === 0) {
                list.innerHTML = '<div class="text-center text-muted small py-3">Немає збережених сегментів</div>';
                return;
            }

            list.innerHTML = saved.map(s => `
                <div class="d-flex justify-content-between align-items-center bg-light p-2 rounded border dropdown-item-text">
                    <div style="cursor:pointer" onclick="restoreSegment(${s.id})" class="text-truncate" style="max-width: 200px;">
                        <div class="fw-bold small text-primary">${s.name}</div>
                        <div class="text-muted" style="font-size:0.7rem">${s.count} users</div>
                    </div>
                    <i class="bi bi-trash text-danger ms-2" style="cursor:pointer" onclick="deleteSegment(${s.id})"></i>
                </div>
            `).join('');
        }

        function deleteSegment(id) {
            let saved = JSON.parse(localStorage.getItem('mySegments') || '[]');
            saved = saved.filter(s => s.id !== id);
            localStorage.setItem('mySegments', JSON.stringify(saved));
            renderSavedSegments();
        }

        function restoreSegment(id) {
            const saved = JSON.parse(localStorage.getItem('mySegments') || '[]');
            const segment = saved.find(s => s.id === id);
            if (!segment) return;

            // Restore visual state
            clearFilters();
            switchView('constructor'); // Ensure we are on constructor

            setTimeout(() => {
                // Check tags text and restore (mocking)
                segment.tags.forEach(tagText => {
                    // Parse type and value from "Type: Value" string
                    const parts = tagText.split(':');
                    if (parts.length > 1) {
                        const type = parts[0].trim();
                        const val = parts[1].trim();
                        addMockTag('c4', type, val);
                    }
                });
                updateState();
            }, 100);
        }

        // 7.4 AUTOMATIONS
        let automationEmails = [];
        let editingAutomationId = null;

        function toggleAutomationPeriodFields() {
            const period = document.getElementById('automation-period').value;
            const weeklyContainer = document.getElementById('automation-day-weekly-container');
            const monthlyContainer = document.getElementById('automation-day-monthly-container');
            if (weeklyContainer) weeklyContainer.style.display = (period === 'weekly') ? 'block' : 'none';
            if (monthlyContainer) monthlyContainer.style.display = (period === 'monthly') ? 'block' : 'none';
        }

        function populateMonthlyDays() {
            const select = document.getElementById('automation-day-monthly');
            if (!select) return;
            select.innerHTML = '';
            for (let i = 1; i <= 31; i++) {
                const opt = document.createElement('option');
                opt.value = i;
                opt.innerText = i + '-те число';
                select.appendChild(opt);
            }
        }

        function addAutomationEmail() {
            const input = document.getElementById('automation-email-input');
            const email = input.value.trim();
            if (email && email.includes('@')) {
                if (!automationEmails.includes(email)) {
                    automationEmails.push(email);
                    renderAutomationEmails();
                    input.value = '';
                }
            } else {
                alert('Введіть коректний емейл');
            }
        }

        function removeAutomationEmail(email) {
            automationEmails = automationEmails.filter(e => e !== email);
            renderAutomationEmails();
        }

        function renderAutomationEmails() {
            const list = document.getElementById('automation-emails-list');
            if (automationEmails.length === 0) {
                list.innerHTML = '<span class="text-muted italic small opacity-50">Список пустий...</span>';
                return;
            }
            list.innerHTML = automationEmails.map(url => `
                <span class="badge bg-soft-primary text-primary border border-primary border-opacity-25 d-flex align-items-center gap-1" style="font-size: 10px; padding: 4px 8px; border-radius: 8px;">
                    ${url} <i class="bi bi-x-circle-fill text-danger opacity-50" style="cursor:pointer" onclick="removeAutomationEmail('${url}')"></i>
                </span>
            `).join('');
        }

        function handleAutomationEmailImport(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                const text = e.target.result;
                const found = text.match(/[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}/g);
                if (found) {
                    found.forEach(email => {
                        if (!automationEmails.includes(email)) automationEmails.push(email);
                    });
                    renderAutomationEmails();
                    alert(`Імпортовано ${found.length} емейлів`);
                }
            };
            reader.readAsText(file);
        }

        function saveCurrentAutomation() {
            if (automationEmails.length === 0) {
                alert('Будь ласка, додайте хоча б один емейл для розсилки.');
                return;
            }
            const modalEl = document.getElementById('saveAutomationModal');
            const modal = new bootstrap.Modal(modalEl);
            document.getElementById('automationNameInput').value = "Звіт " + new Date().toLocaleDateString();
            modal.show();
        }

        function confirmSaveAutomation() {
            const nameInput = document.getElementById('automationNameInput');
            const name = nameInput.value.trim() || 'Без назви';

            const period = document.getElementById('automation-period').value;
            const time = document.getElementById('automation-time').value;

            let frequencyLabel = '';
            let freqData = { period, time };

            if (period === 'daily') {
                frequencyLabel = `Щодня о ${time}`;
            } else if (period === 'weekly') {
                const daySelect = document.getElementById('automation-day-weekly');
                const dayName = daySelect.options[daySelect.selectedIndex].text;
                frequencyLabel = `Що${dayName.toLowerCase()} о ${time}`;
                freqData.day = daySelect.value;
            } else if (period === 'monthly') {
                const daySelect = document.getElementById('automation-day-monthly');
                frequencyLabel = `${daySelect.value}-го числа о ${time}`;
                freqData.day = daySelect.value;
            }

            // Collect active tags/filters
            const tags = [];
            document.querySelectorAll('.tag-pill').forEach(pill => {
                tags.push(pill.innerText.replace('x', '').trim());
            });

            const automation = {
                id: Date.now(),
                name: name,
                frequency: frequencyLabel,
                freqData: freqData,
                emails: [...automationEmails],
                tags: tags,
                resultsCount: document.getElementById('counter-display').innerText,
                exportCount: document.getElementById('export-count').value,
                exportAll: document.getElementById('export-all-check').checked,
                format: document.getElementById('constructor-format-unified').value,
                espoConditions: JSON.parse(JSON.stringify(espoConditionRegistry))
            };

            const saved = JSON.parse(localStorage.getItem('myAutomations') || '[]');
            if (editingAutomationId) {
                const idx = saved.findIndex(x => x.id === editingAutomationId);
                if (idx !== -1) {
                    automation.id = editingAutomationId;
                    saved[idx] = automation;
                } else {
                    saved.push(automation);
                }
            } else {
                saved.push(automation);
            }
            localStorage.setItem('myAutomations', JSON.stringify(saved));

            const modalEl = document.getElementById('saveAutomationModal');
            const modal = bootstrap.Modal.getInstance(modalEl);
            modal.hide();

            editingAutomationId = null;
            automationEmails = [];
            renderAutomationEmails();
            renderSavedAutomations();
        }

        function renderSavedAutomations() {
            const list = document.getElementById('header-saved-automations-list');
            if (!list) return;
            const saved = JSON.parse(localStorage.getItem('myAutomations') || '[]');

            if (saved.length === 0) {
                list.innerHTML = '<div class="text-center text-muted small py-3">Немає активних автоматизацій</div>';
                return;
            }

            list.innerHTML = saved.map(a => `
                <div class="bg-light p-2 rounded border dropdown-item-text shadow-sm mb-1" style="transition: all 0.2s;">
                    <div class="d-flex justify-content-between align-items-center">
                        <div style="cursor:pointer" onclick="restoreAutomation(${a.id})" class="flex-grow-1 overflow-hidden">
                            <div class="d-flex align-items-center gap-2 flex-wrap mb-1">
                                <span class="fw-bold small text-info text-truncate" style="max-width: 140px;" title="${a.name}">${a.name}</span>
                                <span class="badge bg-info bg-opacity-10 text-info fw-bold border border-info border-opacity-25" style="font-size: 0.75rem; white-space: nowrap;">
                                    <i class="bi bi-calendar-event me-1"></i>${a.frequency}
                                </span>
                            </div>
                            <div class="d-flex align-items-center gap-2 text-muted" style="font-size: 0.7rem;">
                                <span class="opacity-75"><i class="bi bi-envelope-fill me-1"></i>${a.emails.length} отримувачів</span>
                                <span class="opacity-75"><i class="bi bi-funnel-fill me-1"></i>${(a.espoConditions ? a.espoConditions.length : 0) + a.tags.length} фільтрів</span>
                            </div>
                        </div>
                        <div class="ms-2">
                            <i class="bi bi-trash text-danger" style="cursor:pointer; font-size: 14px;" onclick="deleteAutomation(${a.id})"></i>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function deleteAutomation(id) {
            let saved = JSON.parse(localStorage.getItem('myAutomations') || '[]');
            saved = saved.filter(a => a.id !== id);
            localStorage.setItem('myAutomations', JSON.stringify(saved));
            renderSavedAutomations();
        }

        function restoreAutomation(id) {
            const saved = JSON.parse(localStorage.getItem('myAutomations') || '[]');
            const a = saved.find(x => x.id == id);
            if (!a) return;

            // Restore filters
            clearFilters();
            switchView('constructor');

            // Close the dropdown menu
            const dropdownEl = document.querySelector('[data-bs-toggle="dropdown"][title="Мої сегменти"]');
            if (dropdownEl) {
                const dropdown = bootstrap.Dropdown.getOrCreateInstance(dropdownEl);
                if (dropdown) dropdown.hide();
            }

            // Set automation UI state
            document.getElementById('export-action-type').value = 'automation';
            toggleExportFields();

            // Scroll to the settings area
            setTimeout(() => {
                const settingsBlock = document.getElementById('automation-settings-block');
                if (settingsBlock) {
                    settingsBlock.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    // Visual feedback: highlight the block
                    settingsBlock.style.transition = 'background-color 0.5s';
                    settingsBlock.style.backgroundColor = 'rgba(67, 97, 238, 0.1)';
                    setTimeout(() => settingsBlock.style.backgroundColor = 'transparent', 1500);
                }
            }, 300);

            // Restore emails
            automationEmails = [...a.emails];
            renderAutomationEmails();

            // Restore frequency UI
            if (a.freqData) {
                document.getElementById('automation-period').value = a.freqData.period;
                toggleAutomationPeriodFields();
                document.getElementById('automation-time').value = a.freqData.time;
                if (a.freqData.period === 'weekly') document.getElementById('automation-day-weekly').value = a.freqData.day;
                if (a.freqData.period === 'monthly') document.getElementById('automation-day-monthly').value = a.freqData.day;
            }

            // Restore Export Settings
            if (a.format) {
                document.getElementById('constructor-format-unified').value = a.format;
                updateMultiSelect('constructor-format-unified');
            }
            if (a.exportCount !== undefined) {
                document.getElementById('export-count').value = a.exportCount;
            }
            if (a.exportAll !== undefined) {
                document.getElementById('export-all-check').checked = a.exportAll;
                toggleExportCountInput();
            }

            // Restore Espo Filters
            if (a.espoConditions) {
                espoConditionRegistry = JSON.parse(JSON.stringify(a.espoConditions));
                renderEspoUI();
                updateFiltersCount();

                // Ensure the filters summary is visible
                const summaryBlock = document.getElementById('active-filters-summary');
                if (summaryBlock) summaryBlock.classList.remove('d-none');

                // Expand the formula card to show the restored filters
                const formulaCard = document.getElementById('main-formula-card');
                if (formulaCard) formulaCard.classList.remove('is-collapsed');
            }

            setTimeout(() => {
                // Restore any legacy tags (pills)
                if (a.tags && a.tags.length > 0) {
                    const summaryBlock = document.getElementById('active-filters-summary');
                    if (summaryBlock) summaryBlock.classList.remove('d-none');

                    a.tags.forEach(tagText => {
                        const parts = tagText.split(':');
                        if (parts.length > 1) {
                            addMockTag('c4', parts[0].trim(), parts[1].trim());
                        }
                    });
                }
                updateState();
            }, 100);

            // Highlight name in modal if they decide to re-save
            document.getElementById('automationNameInput').value = a.name;
            editingAutomationId = a.id;

            // Optional: Close the dropdown menu again just in case (double check)
            const dropdownToggle = document.querySelector('[data-bs-toggle="dropdown"][title="Мої сегменти"]');
            if (dropdownToggle) {
                const instance = bootstrap.Dropdown.getInstance(dropdownToggle);
                if (instance) instance.hide();
            }

            // Visual feedback - simple toast-like message
            const toast = document.createElement('div');
            toast.className = 'position-fixed bottom-0 start-50 translate-middle-x mb-4 bg-dark text-white p-3 rounded shadow-lg animate-fade-in';
            toast.style.zIndex = '9999';
            toast.innerHTML = `<i class="bi bi-check-circle-fill text-success me-2"></i> Параметри автоматизації <b>"${a.name}"</b> завантажено в конструктор`;
            document.body.appendChild(toast);
            setTimeout(() => {
                toast.classList.add('animate-fade-out');
                setTimeout(() => toast.remove(), 500);
            }, 3000);
        }

        // Init Saved Lists
        renderSavedSegments();
        populateMonthlyDays();
        renderSavedAutomations();

        // 7.4 EXPORT MOCK CSV
        function handleExportAction() {
            const select = document.querySelector('.sidebar-sticky select');
            const action = select ? select.value : 'csv';

            if (action === 'csv') {
                generateAndDownloadCSV();
            } else {
                alert('Ця функція (' + action + ') доступна в Enterprise версії.');
            }
        }

        function generateAndDownloadCSV() {
            // Marshaling some fake data
            const headers = ["Phone", "Email", "Name", "City", "LastActive", "SegmentScore"];
            let rows = [];

            for (let i = 0; i < 50; i++) {
                rows.push([
                    `380${Math.floor(Math.random() * 900000000 + 100000000)}`, // Phone
                    `user${i}@mail.com`, // Email
                    `Client ${i}`,       // Name
                    ['Kyiv', 'Lviv', 'Odessa', 'Dnipro'][Math.floor(Math.random() * 4)], // City
                    new Date().toISOString().split('T')[0], // Date
                    (Math.random() * 100).toFixed(2) // Score
                ]);
            }

            let csvContent = "data:text/csv;charset=utf-8,"
                + headers.join(",") + "\n"
                + rows.map(e => e.join(",")).join("\n");

            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "audience_export_" + new Date().toISOString().slice(0, 10) + ".csv");
            document.body.appendChild(link); // Required for FF
            link.click();
            document.body.removeChild(link);
        }

        function toggleFormulaCard() {
            const card = document.getElementById('main-formula-card');
            card.classList.toggle('is-collapsed');
        }

        // --- UNIVERSAL DESIGN MODE PRO (Consolidated) ---
    </script>
    <div id="filter-picker" class="filter-picker-overlay"></div>

    <!-- Design Mode Toolbar -->
    <div class="design-toolbar">
        <div class="d-flex align-items-center gap-2 px-2 border-end border-secondary me-2">
            <i class="bi bi-palette-fill text-primary"></i>
            <span class="text-white small fw-bold">DESIGN MODE PRO</span>
        </div>
        <div class="d-flex gap-2">
            <button class="btn btn-sm btn-outline-warning rounded-pill px-3" onclick="resetDesign()"
                title="Скинути всі зміни">
                <i class="bi bi-arrow-counterclockwise me-1"></i>Скинути
            </button>
            <button class="btn btn-sm btn-outline-light rounded-pill px-3" onclick="toggleDesignMode()"
                title="Перегляд без інструментів">
                <i class="bi bi-eye me-1"></i>Вихід
            </button>
            <button class="btn btn-sm btn-primary rounded-pill px-4" onclick="saveDesignChanges()"
                title="Отримати JSON">
                <i class="bi bi-check2-all me-1"></i>Готово
            </button>
        </div>
    </div>
</body>

<script>
    // --- CONSOLIDATED DESIGN MODE PRO LOGIC ---
    let designModeActive = false;
    let sortables = [];

    // Global Styles Config
    let designConfig = {
        tabFontSize: 13,
        labelFontSize: 11,
        subsectionFontSize: 15,
        fieldSizeDefault: 4
    };

    function toggleDesignMode() {
        designModeActive = !designModeActive;
        document.body.classList.toggle('design-mode-active', designModeActive);
        if (designModeActive) {
            initDesignMode();
            showDesignControls(); // New Global Controls Panel
            showDesignToast('Режим дизайну PRO. Спробуйте нову панель керування!');
        } else {
            destroyDesignMode();
            const panel = document.getElementById('design-global-controls');
            if (panel) panel.remove();
            showDesignToast('Режим дизайну ВИМКНЕНО.');
        }
    }

    function initDesignMode() {
        // 1. Tabs Reordering (Fix)
        const tabsList = document.getElementById('filterTabs');
        if (tabsList) {
            tabsList.querySelectorAll('.nav-item:not(.add-tab-item)').forEach(li => {
                li.style.position = 'relative';
                const link = li.querySelector('.nav-link');
                if (link) {
                    link.style.paddingLeft = '28px';
                    link.style.position = 'relative';
                    if (!li.querySelector('.tab-sort-handle')) {
                        const handle = document.createElement('span');
                        handle.className = 'tab-sort-handle';
                        handle.innerHTML = '<i class="bi bi-grip-vertical"></i>';
                        handle.style = 'cursor:grab; color:#64748b; font-size:16px; position:absolute; left:8px; top:50%; transform:translateY(-50%); z-index:10; padding: 4px; display: flex; align-items: center; justify-content: center;';
                        li.appendChild(handle);
                    }
                }
            });

            sortables.push(new Sortable(tabsList, {
                animation: 150,
                ghostClass: 'sortable-ghost',
                draggable: '.nav-item:not(.add-tab-item)',
                handle: '.tab-sort-handle',
                forceFallback: true, // Better for complex nested UIs
                onStart: () => document.body.classList.add('is-dragging-tab'),
                onEnd: () => {
                    document.body.classList.remove('is-dragging-tab');
                    saveToLocalSilent();
                }
            }));
        }

        // 2. Add Tab Button
        if (!document.querySelector('.add-tab-item')) {
            const li = document.createElement('li'); li.className = 'nav-item add-tab-item';
            li.innerHTML = `<button class="btn btn-sm text-primary py-2 px-3" onclick="addDesignerSection()"><i class="bi bi-plus-circle-fill me-1"></i>Таб</button>`;
            tabsList?.appendChild(li);
        }

        // 3. Tab Panes & Sub-sections
        document.querySelectorAll('.tab-pane-card').forEach(card => {
            // Add Sub-section Button to Card if not exists
            if (!card.querySelector('.add-subsection-btn')) {
                const addSubBtn = document.createElement('button');
                addSubBtn.className = 'btn btn-xs btn-outline-primary mb-3 add-subsection-btn';
                addSubBtn.innerHTML = '<i class="bi bi-plus-square me-1"></i>Додати підрозділ';
                addSubBtn.style.fontSize = '11px';
                addSubBtn.onclick = () => addDesignerSubSection(card);
                card.prepend(addSubBtn);
            }

            // Sub-sections sorting
            sortables.push(new Sortable(card, {
                animation: 150,
                draggable: '.designer-subsection-wrapper',
                handle: '.subsection-handle',
                ghostClass: 'sortable-ghost',
                onEnd: () => saveToLocalSilent()
            }));

            // Wrap existing content into Sub-section blocks if not wrapped
            const children = Array.from(card.children).filter(el => !el.classList.contains('add-subsection-btn') && !el.classList.contains('section-delete-btn'));
            let currentHeader = null;
            let currentGroup = [];

            children.forEach((child, idx) => {
                if (child.tagName === 'H6') {
                    if (currentGroup.length > 0 || currentHeader) flushGroup();
                    currentHeader = child;
                } else if (child.classList.contains('row')) {
                    currentGroup.push(child);
                } else if (child.classList.contains('designer-subsection-wrapper')) {
                    // already wrapped
                }
                if (idx === children.length - 1) flushGroup();
            });

            function flushGroup() {
                const wrapper = document.createElement('div');
                wrapper.className = 'designer-subsection-wrapper mb-4 p-2 rounded border border-dashed border-secondary position-relative';
                if (currentHeader) {
                    currentHeader.contentEditable = 'true';
                    currentHeader.classList.add('subsection-title');
                    currentHeader.style.cursor = 'text';

                    const handle = document.createElement('div');
                    handle.className = 'subsection-handle position-absolute';
                    handle.innerHTML = '<i class="bi bi-grip-vertical"></i>';
                    handle.style = 'left:-10px; top:10px; cursor:grab; color:#4361ee;';

                    const delSub = document.createElement('button');
                    delSub.className = 'btn-design-action delete position-absolute';
                    delSub.style = 'right:0; top:0; z-index:10;';
                    delSub.innerHTML = '<i class="bi bi-x-lg"></i>';
                    delSub.title = 'Видалити розділення (поля залишаться)';
                    delSub.onclick = (e) => {
                        e.preventDefault();
                        if (confirm('Видалити тільки заголовок підрозділу? Поля залишаться.')) {
                            // Unwrap: move title and rows back to card
                            const rows = Array.from(wrapper.querySelectorAll('.row.g-3'));
                            rows.forEach(r => wrapper.parentElement.insertBefore(r, wrapper));
                            wrapper.remove();
                            saveToLocalSilent();
                            destroyDesignMode();
                            initDesignMode();
                        }
                    };

                    wrapper.appendChild(handle);
                    wrapper.appendChild(delSub);
                    wrapper.appendChild(currentHeader);
                }
                currentGroup.forEach(g => wrapper.appendChild(g));
                card.appendChild(wrapper);
                currentHeader = null;
                currentGroup = [];
            }

            // Initialize Sortable for Fields in each row
            card.querySelectorAll('.row.g-3').forEach(container => {
                sortables.push(new Sortable(container, {
                    group: {
                        name: 'shared-designer-fields',
                        pull: true,
                        put: true
                    },
                    animation: 350,
                    easing: "cubic-bezier(0.34, 1.56, 0.64, 1)",
                    ghostClass: 'sortable-ghost-pro',
                    chosenClass: 'sortable-chosen-pro',
                    dragClass: 'sortable-drag-pro',
                    fallbackOnBody: true,
                    forceFallback: true,
                    handle: '.field-sort-handle',
                    onStart: (evt) => {
                        document.body.classList.add('is-dragging-field');
                        evt.item.classList.add('is-being-dragged');
                        document.querySelectorAll('#filterTabs .nav-link').forEach(link => {
                            link.addEventListener('mouseenter', handleDesignerTabSwitch);
                        });
                    },
                    onEnd: (evt) => {
                        document.body.classList.remove('is-dragging-field');
                        evt.item.classList.remove('is-being-dragged');
                        document.querySelectorAll('#filterTabs .nav-link').forEach(link => {
                            link.removeEventListener('mouseenter', handleDesignerTabSwitch);
                        });
                        saveToLocalSilent();
                    }
                }));

                if (!container.querySelector('.add-field-btn')) {
                    const div = document.createElement('div'); div.className = 'col-md-4 add-field-placeholder-col';
                    div.innerHTML = `<div class="add-field-btn border border-dashed p-3 text-center rounded text-muted small" onclick="addDesignerField(this)" style="cursor:pointer; background:rgba(255,255,255,0.03)">
                    <i class="bi bi-plus-circle mb-1 d-block fs-5 text-primary"></i>Додати поле
                </div>`;
                    container.appendChild(div);
                }
            });

            // Delete Tab Button
            if (!card.querySelector('.section-delete-btn')) {
                const delBtn = document.createElement('button');
                delBtn.className = 'section-delete-btn';
                delBtn.innerHTML = '<i class="bi bi-trash3"></i>';
                delBtn.title = 'Видалити весь розділ';
                delBtn.onclick = (e) => { e.stopPropagation(); removeDesignerSection(card.closest('.tab-pane').id); };
                card.appendChild(delBtn);
            }
        });

        // 4. Fields Controls
        document.querySelectorAll('[data-field-id]').forEach(field => {
            const label = field.querySelector('.form-label');
            if (label) { label.contentEditable = 'true'; label.onblur = () => saveToLocalSilent(); }

            // Add field handle (Top Left Position)
            if (!field.querySelector('.field-sort-handle')) {
                const h = document.createElement('div');
                h.className = 'field-sort-handle';
                h.innerHTML = '<i class="bi bi-grip-vertical"></i>';
                h.style = 'position:absolute; left:0; top:-12px; cursor:grab; color:#4361ee; background:#fff; border-radius:4px; padding:0 6px; font-size:14px; z-index:1100; opacity:0.6; transition:all 0.2s cubic-bezier(0.4, 0, 0.2, 1); border: 1px solid rgba(67, 97, 238, 0.3);';
                h.onmouseenter = () => h.style.opacity = '1';
                h.onmouseleave = () => h.style.opacity = '0.6';
                field.style.position = 'relative';
                field.appendChild(h);
            }

            if (!field.querySelector('.field-edit-controls')) {
                const colClass = Array.from(field.classList).find(c => c.startsWith('col-md-')) || 'col-md-4';
                const size = parseInt(colClass.split('-')[2]) || 4;
                const controls = document.createElement('div');
                controls.className = 'field-edit-controls';
                controls.style = 'position: absolute; right: 0; top: -18px; z-index: 1000; display: flex; align-items: center;';
                controls.innerHTML = `
                <div class="resize-handler-container d-flex align-items-center" style="background: rgba(15,23,42,0.9); padding: 4px 10px; border-radius: 30px; border: 1px solid rgba(255,255,255,0.1);">
                    <button class="btn btn-link text-white p-0 me-2" title="Редагувати поле" style="text-decoration:none;" onclick="editDesignerField('${field.dataset.fieldId}')"><i class="bi bi-pencil-square text-info"></i></button>
                    <button class="btn btn-link text-white p-0 me-2" style="text-decoration:none;" onclick="stepFieldSize('${field.dataset.fieldId}', -1)"><i class="bi bi-dash-circle"></i></button>
                    <span class="size-label fw-bold text-info small" style="min-width:14px;">${size}</span>
                    <button class="btn btn-link text-white p-0 ms-2" style="text-decoration:none;" onclick="stepFieldSize('${field.dataset.fieldId}', 1)"><i class="bi bi-plus-circle"></i></button>
                </div>
                <button class="btn btn-danger btn-sm rounded-circle ms-2" style="width:28px; height:28px; padding:0; line-height:1;" onclick="removeDesignerField('${field.dataset.fieldId}')"><i class="bi bi-x-lg" style="font-size:12px;"></i></button>
            `;
                field.appendChild(controls);
            }
        });

        // 5. Global Tab Link Handling
        document.querySelectorAll('#filterTabs .nav-link').forEach(tab => {
            tab.contentEditable = 'true';
            tab.onblur = () => saveToLocalSilent();
            tab.onkeydown = (e) => { if (e.key === 'Enter') { e.preventDefault(); tab.blur(); } };
        });
    }

    function handleDesignerTabSwitch(e) {
        if (document.body.classList.contains('is-dragging-field')) {
            const tabBtn = e.currentTarget;
            if (!tabBtn.classList.contains('active')) {
                const t = bootstrap.Tab.getOrCreateInstance(tabBtn);
                t.show();
                // Force Sortable to recognize the new container
                setTimeout(() => {
                    window.dispatchEvent(new Event('resize'));
                }, 50);
            }
        }
    }

    function addDesignerSubSection(card) {
        const titleText = prompt('Назва підрозділу:', 'НОВИЙ ПІДРОЗДІЛ');
        if (!titleText) return;
        const h6 = document.createElement('h6');
        h6.className = 'fw-bold text-primary mb-3 text-uppercase small';
        h6.style.letterSpacing = '1px';
        h6.innerText = titleText;
        const row = document.createElement('div');
        row.className = 'row g-3 mb-4';
        card.appendChild(h6);
        card.appendChild(row);
        destroyDesignMode();
        initDesignMode();
        saveToLocalSilent();
    }

    function destroyDesignMode() {
        sortables.forEach(s => s.destroy()); sortables = [];
        document.querySelectorAll('[contenteditable]').forEach(el => el.contentEditable = 'false');
        document.querySelectorAll('.field-edit-controls, .add-field-placeholder-col, .section-delete-btn, .add-tab-item, .add-subsection-btn, .subsection-handle, .tab-sort-handle, .field-sort-handle').forEach(el => el.remove());
        document.querySelectorAll('.designer-subsection-wrapper').forEach(w => {
            const title = w.querySelector('.subsection-title');
            const rows = Array.from(w.querySelectorAll('.row'));
            if (title) w.parentElement.insertBefore(title, w);
            rows.forEach(r => w.parentElement.insertBefore(r, w));
            w.remove();
        });
        document.querySelectorAll('.subsection-title').forEach(el => el.classList.remove('subsection-title'));
    }

    function updateFieldSizeSlide(id, size) {
        const f = document.querySelector(`[data-field-id="${id}"]`); if (!f) return;
        const classes = f.className.split(' ').filter(c => !c.startsWith('col-md-') && !c.startsWith('col-'));
        f.className = classes.join(' ') + ` col-md-${size}`;
        const sl = f.querySelector('.resize-slider'); if (sl) sl.value = size;
        const l = f.querySelector('.size-label'); if (l) l.innerText = size;
        saveToLocalSilent();
    }

    function stepFieldSize(id, step) {
        const f = document.querySelector(`[data-field-id="${id}"]`); if (!f) return;
        const colClass = Array.from(f.classList).find(c => c.startsWith('col-md-')) || 'col-md-4';
        let cur = parseInt(colClass.split('-')[2]) || 4;
        updateFieldSizeSlide(id, Math.max(1, Math.min(12, cur + step)));
    }

    function addDesignerSection() {
        const name = prompt('Назва:', 'Новий розділ'); if (!name) return;
        const id = 'pane-custom-' + Date.now();
        const tabsList = document.getElementById('filterTabs');
        const addBtnItem = document.querySelector('.add-tab-item');
        const newTab = document.createElement('li'); newTab.className = 'nav-item';
        newTab.innerHTML = `<button class="nav-link w-100 text-start" data-bs-toggle="tab" data-bs-target="#${id}" type="button"><i class="bi bi-collection me-1"></i> ${name}</button>`;
        tabsList.insertBefore(newTab, addBtnItem);
        const newPane = document.createElement('div'); newPane.className = 'tab-pane fade'; newPane.id = id;
        newPane.innerHTML = `<div class="tab-pane-card"><div class="row g-3"></div></div>`;
        document.querySelector('.tab-content').appendChild(newPane);
        destroyDesignMode(); new bootstrap.Tab(newTab.querySelector('button')).show();
        setTimeout(initDesignMode, 100); saveToLocalSilent();
    }

    function removeDesignerSection(id) {
        if (!confirm('Видалити?')) return;
        document.querySelector(`[data-bs-target="#${id}"], [href="#${id}"]`)?.closest('.nav-item').remove();
        document.getElementById(id)?.remove();
        destroyDesignMode(); initDesignMode(); saveToLocalSilent();
    }

    function getFieldHTML(type, name) {
        let input = '';
        if (type === 'date' || type === 'time') {
            const inputType = type;
            const randId = Math.floor(Math.random() * 10000);
            input = `
                <div class="d-flex justify-content-between align-items-center mb-1">
                    <label class="form-label mb-0">${name}</label>
                    <div class="form-check form-switch min-h-0 mb-0 d-flex align-items-center gap-1">
                        <input class="form-check-input" type="checkbox" id="dsgn-${randId}-all" style="transform: scale(0.8);">
                        <label class="form-check-label text-muted small" for="dsgn-${randId}-all">&infin;</label>
                    </div>
                </div>
                <div class="input-group">
                    <input type="${inputType}" class="form-control px-2">
                    <span class="input-group-text bg-light px-1" style="font-size: 0.7rem;">по</span>
                    <input type="${inputType}" class="form-control px-2">
                    <button class="btn btn-outline-primary px-2" type="button">
                        <i class="bi bi-plus"></i>
                    </button>
                </div>`;
            return input;
        } else if (type === 'select') {
            input = `<select class="form-select">
                        <option selected disabled>Оберіть варіант...</option>
                        <option>Варіант 1</option>
                        <option>Варіант 2</option>
                        <option>Варіант 3</option>
                    </select>`;
        } else if (type === 'number') {
            input = `<input type="number" class="form-control" placeholder="0">`;
        } else if (type === 'textarea') {
            input = `<textarea class="form-control" rows="2" placeholder="..."></textarea>`;
        } else {
            input = `<input type="text" class="form-control" placeholder="...">`;
        }
        return `<label class="form-label">${name}</label>${input}`;
    }

    function addDesignerField(btn) {
        const name = prompt('Назва поля:', 'Нове поле'); if (!name) return;

        // Show selection modal instead of prompt
        const modalId = 'fieldTypeModal';
        let modalEl = document.getElementById(modalId);
        if (modalEl) modalEl.remove();

        const types = [
            { id: 'text', label: 'Текстове поле', icon: 'bi-fonts' },
            { id: 'date', label: 'Дата', icon: 'bi-calendar-event' },
            { id: 'time', label: 'Час', icon: 'bi-clock' },
            { id: 'select', label: 'Випадаючий список', icon: 'bi-list-check' },
            { id: 'number', label: 'Число', icon: 'bi-hash' },
            { id: 'textarea', label: 'Великий текст', icon: 'bi-textarea-t' }
        ];

        const div = document.createElement('div');
        div.innerHTML = `
        <div class="modal fade" id="${modalId}" tabindex="-1" style="z-index: 11000;">
            <div class="modal-dialog modal-dialog-centered modal-sm">
                <div class="modal-content bg-dark border-secondary shadow-lg" style="border-radius: 20px;">
                    <div class="modal-header border-0 pb-0">
                        <h6 class="modal-title text-white small opacity-75">Оберіть тип поля для "${name}"</h6>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body p-3">
                        <div class="list-group list-group-flush bg-transparent">
                            ${types.map(t => `
                                <button type="button" class="list-group-item list-group-item-action bg-transparent text-white border-secondary border-opacity-25 d-flex align-items-center py-2 px-1" 
                                    onclick="confirmAddField('${t.id}', '${name}', '${btn.closest('.row.g-3').parentElement.id || ''}', this)">
                                    <i class="bi ${t.icon} text-primary me-2 fs-5"></i>
                                    <span class="small">${t.label}</span>
                                </button>
                            `).join('')}
                        </div>
                    </div>
                </div>
            </div>
        </div>`;
        document.body.appendChild(div);

        // Save button reference context for later
        window._currentAddFieldBtn = btn;

        const modal = new bootstrap.Modal(document.getElementById(modalId));
        modal.show();
    }

    function confirmAddField(type, name, parentId, itemBtn) {
        const btn = window._currentAddFieldBtn;
        if (!btn) return;

        const c = btn.closest('.row.g-3');
        const fid = 'field-' + Date.now();
        const div = document.createElement('div');
        div.className = 'col-md-4';
        div.dataset.fieldId = fid;
        div.dataset.fieldType = type;
        div.innerHTML = getFieldHTML(type, name);

        c.insertBefore(div, btn.closest('.col-md-4'));

        const modal = bootstrap.Modal.getInstance(document.getElementById('fieldTypeModal'));
        modal.hide();

        destroyDesignMode();
        initDesignMode();
        saveToLocalSilent();

        delete window._currentAddFieldBtn;
    }

    function editDesignerField(id) {
        const fieldEl = document.querySelector(`[data-field-id="${id}"]`);
        if (!fieldEl) return;

        const currentName = fieldEl.querySelector('.form-label')?.innerText || '';
        const currentType = fieldEl.dataset.fieldType || 'text';

        const newName = prompt('Нова назва поля:', currentName);
        if (newName === null) return;

        const modalId = 'editFieldTypeModal';
        let modalEl = document.getElementById(modalId);
        if (modalEl) modalEl.remove();

        const types = [
            { id: 'text', label: 'Текстове поле', icon: 'bi-fonts' },
            { id: 'date', label: 'Дата', icon: 'bi-calendar-event' },
            { id: 'time', label: 'Час', icon: 'bi-clock' },
            { id: 'select', label: 'Випадаючий список', icon: 'bi-list-check' },
            { id: 'number', label: 'Число', icon: 'bi-hash' },
            { id: 'textarea', label: 'Великий текст', icon: 'bi-textarea-t' }
        ];

        const div = document.createElement('div');
        div.innerHTML = `
        <div class="modal fade" id="${modalId}" tabindex="-1" style="z-index: 11000;">
            <div class="modal-dialog modal-dialog-centered modal-sm">
                <div class="modal-content bg-dark border-secondary shadow-lg" style="border-radius: 20px;">
                    <div class="modal-header border-0 pb-0">
                        <h6 class="modal-title text-white small opacity-75">Змінити тип для "${newName}"</h6>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body p-3">
                        <div class="list-group list-group-flush bg-transparent">
                            ${types.map(t => `
                                <button type="button" class="list-group-item list-group-item-action ${t.id === currentType ? 'border-primary border-opacity-50' : ''} bg-transparent text-white border-secondary border-opacity-25 d-flex align-items-center py-2 px-1" 
                                    onclick="confirmEditField('${id}', '${t.id}', '${newName}')">
                                    <i class="bi ${t.icon} ${t.id === currentType ? 'text-info' : 'text-primary'} me-2 fs-5"></i>
                                    <span class="small ${t.id === currentType ? 'fw-bold text-info' : ''}">${t.label}</span>
                                </button>
                            `).join('')}
                        </div>
                    </div>
                </div>
            </div>
        </div>`;
        document.body.appendChild(div);
        new bootstrap.Modal(document.getElementById(modalId)).show();
    }

    function confirmEditField(id, type, name) {
        const fieldEl = document.querySelector(`[data-field-id="${id}"]`);
        if (!fieldEl) return;

        fieldEl.dataset.fieldType = type;
        fieldEl.innerHTML = getFieldHTML(type, name);

        const modal = bootstrap.Modal.getInstance(document.getElementById('editFieldTypeModal'));
        if (modal) modal.hide();

        destroyDesignMode();
        initDesignMode();
        saveToLocalSilent();
    }

    function removeDesignerField(id) {
        if (confirm('Видалити?')) { document.querySelector(`[data-field-id="${id}"]`)?.remove(); saveToLocalSilent(); }
    }

    function showDesignControls() {
        const existing = document.getElementById('design-global-controls');
        if (existing) existing.remove();

        const panel = document.createElement('div');
        panel.id = 'design-global-controls';
        panel.className = 'design-controls-panel';
        panel.innerHTML = `
        <div class="d-flex align-items-center justify-content-between mb-3 border-bottom border-secondary pb-2">
            <h6 class="mb-0 text-white fw-bold"><i class="bi bi-gear-fill me-2 text-primary"></i> Глобальні налаштування</h6>
            <button class="btn-close btn-close-white btn-sm" onclick="this.parentElement.parentElement.remove()"></button>
        </div>
        
        <div class="design-control-item">
            <label class="small text-white-50 d-block mb-1">Розмір тексту вкладок (px)</label>
            <div class="d-flex align-items-center gap-2">
                <input type="range" class="form-range flex-grow-1" min="10" max="24" value="${designConfig.tabFontSize}" 
                    oninput="updateGlobalFontSize('tab', this.value)">
                <span id="label-tab-size" class="badge bg-primary">${designConfig.tabFontSize}px</span>
            </div>
        </div>

        <div class="design-control-item mt-3">
            <label class="small text-white-50 d-block mb-1">Розмір тексту назв полів (px)</label>
            <div class="d-flex align-items-center gap-2">
                <input type="range" class="form-range flex-grow-1" min="10" max="24" value="${designConfig.labelFontSize}" 
                    oninput="updateGlobalFontSize('label', this.value)">
                <span id="label-field-size" class="badge bg-primary">${designConfig.labelFontSize}px</span>
            </div>
        </div>

        <div class="design-control-item mt-3">
            <label class="small text-white-50 d-block mb-1">Розмір заголовків підрозділів (px)</label>
            <div class="d-flex align-items-center gap-2">
                <input type="range" class="form-range flex-grow-1" min="8" max="24" value="${designConfig.subsectionFontSize || 11}" 
                    oninput="updateGlobalFontSize('subsection', this.value)">
                <span id="label-subsection-size" class="badge bg-primary">${designConfig.subsectionFontSize || 11}px</span>
            </div>
        </div>

        <div class="design-control-item mt-4 border-top border-secondary pt-3 d-flex gap-2">
            <button class="btn btn-sm btn-outline-info flex-grow-1" onclick="saveDesignChanges()">
                <i class="bi bi-code-slash me-1"></i>Експорт
            </button>
            <button class="btn btn-sm btn-outline-warning flex-grow-1" onclick="resetDesign()">
                <i class="bi bi-arrow-counterclockwise me-1"></i>Скинути
            </button>
        </div>
    `;
        document.body.appendChild(panel);

        // Add Styles
        if (!document.getElementById('design-panel-styles')) {
            const style = document.createElement('style');
            style.id = 'design-panel-styles';
            style.textContent = `
            .design-controls-panel {
                position: fixed;
                bottom: 80px;
                right: 20px;
                width: 280px;
                background: rgba(15, 23, 42, 0.95);
                backdrop-filter: blur(10px);
                border: 1px solid rgba(255,255,255,0.1);
                border-radius: 16px;
                padding: 16px;
                z-index: 9999;
                box-shadow: 0 10px 30px rgba(0,0,0,0.5);
                animation: slideUp 0.3s ease-out;
            }
            @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
            #filterTabs .nav-link { font-size: var(--tab-font-size, 0.85rem) !important; transition: font-size 0.2s; position: relative; z-index: 5; }
            .form-label { font-size: var(--label-font-size, 12px) !important; transition: font-size 0.2s; }
            /* Extra specific design-mode overrides */
            .design-mode-active .tab-pane-card h6, .design-mode-active .subsection-title { 
                border-bottom: 1px dashed var(--primary-soft);
                padding-bottom: 5px;
            }
            .sortable-ghost { opacity: 0.1 !important; pointer-events: none !important; }
            .sortable-fallback { pointer-events: none !important; opacity: 0.9 !important; z-index: 10005 !important; transform: rotate(0deg) !important; filter: brightness(1.1); }
            .sortable-drag { pointer-events: none !important; transform: rotate(0deg) !important; }
            
            /* Disable animations in design mode for instant response */
            .design-mode-active .tab-pane.fade { transition: none !important; opacity: 1 !important; display: none; }
            .design-mode-active .tab-pane.active { display: block !important; }
            .design-mode-active .nav-link { transition: none !important; }

            .tab-sort-handle:hover, .field-sort-handle:hover { color: #4361ee !important; opacity: 1 !important; transform: scale(1.2); }
            .is-dragging-field .row.g-3 { min-height: 80px; border: 1px dashed rgba(67, 97, 238, 0.15); border-radius: 12px; position: relative; transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1); background: rgba(67, 97, 238, 0.01); }
            .field-edit-controls { opacity: 0; transition: all 0.3s ease; transform: translateY(5px); }
            [data-field-id]:hover .field-edit-controls { opacity: 1; transform: translateY(0); }

            /* Premium Glass Ghost Effect */
            .sortable-ghost-pro { opacity: 0.4 !important; background: var(--primary-soft) !important; border: 2px solid var(--primary) !important; border-radius: 12px !important; filter: blur(2px); }
            .sortable-chosen-pro { transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1); }
            .sortable-drag-pro { opacity: 1 !important; transform: rotate(1deg) scale(1.02) !important; box-shadow: 0 20px 40px rgba(0,0,0,0.3) !important; z-index: 10000 !important; cursor: grabbing !important; }

            /* Smooth movement for items */
            [data-field-id], .nav-item, .designer-subsection-wrapper { transition: transform 0.4s cubic-bezier(0.34, 1.56, 0.64, 1), opacity 0.3s ease; }
            .is-being-dragged { opacity: 0.5; transform: scale(0.95); }

            /* Prevent text selection during drag */
            .is-dragging-field, .is-dragging-tab { 
                user-select: none !important; 
                -webkit-user-select: none !important; 
            }
            
            /* New Line Magnetic Zones */
            .designer-subsection-wrapper::after {
                content: 'Сюди для нового рядка';
                display: block;
                height: 0;
                overflow: hidden;
                text-align: center;
                font-size: 10px;
                color: var(--primary);
                border-radius: 8px;
                transition: all 0.3s ease;
                opacity: 0;
            }
            .is-dragging-field .designer-subsection-wrapper::after {
                height: 20px;
                margin-top: 10px;
                border: 1px dashed rgba(67, 97, 238, 0.3);
                opacity: 0.5;
                padding-top: 2px;
            }
        `;
            document.head.appendChild(style);
        }

        // Set custom properties only if they differ from defaults
        document.documentElement.style.setProperty('--tab-font-size', designConfig.tabFontSize + 'px');
        document.documentElement.style.setProperty('--label-font-size', designConfig.labelFontSize + 'px');
        document.documentElement.style.setProperty('--subsection-font-size', designConfig.subsectionFontSize + 'px');
    }

    function updateGlobalFontSize(type, value) {
        if (type === 'tab') {
            designConfig.tabFontSize = value;
            document.documentElement.style.setProperty('--tab-font-size', value + 'px');
            document.getElementById('label-tab-size').innerText = value + 'px';
        } else if (type === 'label') {
            designConfig.labelFontSize = value;
            document.documentElement.style.setProperty('--label-font-size', value + 'px');
            document.getElementById('label-field-size').innerText = value + 'px';
        } else if (type === 'subsection') {
            designConfig.subsectionFontSize = value;
            document.documentElement.style.setProperty('--subsection-font-size', value + 'px');
            document.getElementById('label-subsection-size').innerText = value + 'px';
        }
        saveToLocalSilent();
    }

    function showDesignToast(msg) {
        const t = document.createElement('div');
        t.className = 'position-fixed top-0 start-50 translate-middle-x p-4 mt-5';
        t.style.zIndex = '12000';
        t.innerHTML = `
            <div class="toast show bg-dark text-white border-0 shadow-lg animate-fade-in" style="border-radius:12px; border-left: 4px solid #4361ee !important;">
                <div class="toast-body d-flex align-items-center">
                    <i class="bi bi-info-circle-fill text-primary me-2"></i>${msg}
                </div>
            </div>`;
        document.body.appendChild(t);
        setTimeout(() => {
            t.classList.add('animate-fade-out'); // Add fade out if exists
            setTimeout(() => t.remove(), 500);
        }, 3000);
    }

    function collectCurrentDesign() {
        const s = []; const tabs = document.getElementById('filterTabs'); if (!tabs) return s;
        tabs.querySelectorAll('.nav-item:not(.add-tab-item)').forEach(item => {
            const btn = item.querySelector('.nav-link');
            const tid = btn.getAttribute('data-bs-target')?.replace('#', '') || btn.getAttribute('href')?.replace('#', '');
            if (!tid) return;
            const pane = document.getElementById(tid); const info = { id: tid, title: btn.innerText.trim(), subSections: [] };

            // Find sub-sections
            const card = pane?.querySelector('.tab-pane-card');
            if (card) {
                const wrappers = card.querySelectorAll('.designer-subsection-wrapper');
                if (wrappers.length > 0) {
                    wrappers.forEach(w => {
                        const subTitle = w.querySelector('.subsection-title')?.innerText.trim() || '';
                        const fields = [];
                        w.querySelectorAll('[data-field-id]').forEach(f => {
                            const l = f.querySelector('.form-label');
                            fields.push({
                                id: f.dataset.fieldId,
                                label: l.innerText.trim(),
                                type: f.dataset.fieldType || 'text',
                                col: Array.from(f.classList).filter(c => c.startsWith('col-')).join(' '),
                                fontFamily: l.style.fontFamily || 'inherit'
                            });
                        });
                        info.subSections.push({ title: subTitle, fields });
                    });
                } else {
                    // Fallback for simple tabs without wrappers yet
                    const fields = [];
                    card.querySelectorAll('[data-field-id]').forEach(f => {
                        const l = f.querySelector('.form-label');
                        fields.push({
                            id: f.dataset.fieldId,
                            label: l.innerText.trim(),
                            type: f.dataset.fieldType || 'text',
                            col: Array.from(f.classList).filter(c => c.startsWith('col-')).join(' '),
                            fontFamily: l.style.fontFamily || 'inherit'
                        });
                    });
                    info.subSections.push({ title: '', fields });
                }
            }
            s.push(info);
        });
        return { layout: s, config: designConfig };
    }

    function saveToLocalSilent() {
        localStorage.setItem('ui_design_config', JSON.stringify(collectCurrentDesign()));
    }

    function saveDesignChanges() {
        const data = collectCurrentDesign();
        const jsonStr = JSON.stringify(data, null, 2);

        if (typeof bootstrap === 'undefined' || !bootstrap.Modal) {
            console.error("Bootstrap Modal is not available!");
            alert("Помилка: Bootstrap JS не знайдено.");
            console.log(jsonStr);
            return;
        }

        const modalId = 'saveDesignModal';
        let modalEl = document.getElementById(modalId);
        if (modalEl) modalEl.remove();

        const div = document.createElement('div');
        div.innerHTML = `
        <div class="modal fade" id="${modalId}" tabindex="-1" style="z-index: 10005;">
            <div class="modal-dialog modal-lg modal-dialog-centered">
                <div class="modal-content bg-dark border-secondary shadow-lg" style="border-radius: 20px; overflow: hidden;">
                    <div class="modal-header border-bottom border-white border-opacity-10 bg-black bg-opacity-20 px-4 py-3">
                        <h5 class="modal-title d-flex align-items-center text-white">
                            <i class="bi bi-cloud-download-fill text-info me-2"></i>
                            Експорт конфігурації дизайну
                        </h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body p-4">
                        <div class="alert alert-info border-0 bg-info bg-opacity-10 text-info small mb-3">
                            <i class="bi bi-info-circle-fill me-2"></i>Цей JSON містить вашу структуру вкладок, розміри полів та глобальні налаштування. 
                            Відправте його <strong>Творцю</strong>, щоб він вніс зміни до коду.
                        </div>
                        <div class="position-relative">
                            <textarea class="form-control bg-black text-info font-monospace border-secondary shadow-none" 
                                style="font-size: 11px; color: #0dcaf0 !important; border-radius: 12px; border: 1px solid rgba(13, 202, 240, 0.2);" rows="14" readonly>${jsonStr}</textarea>
                        </div>
                    </div>
                    <div class="modal-footer border-top border-white border-opacity-10 bg-black bg-opacity-20 p-3">
                        <button class="btn btn-outline-light rounded-pill px-4" onclick="downloadDesignFile()">
                            <i class="bi bi-file-earmark-code me-2"></i>Файл
                        </button>
                        <button class="btn btn-primary rounded-pill px-4 ms-auto" onclick="copyDesignToClipboard(this)">
                            <i class="bi bi-clipboard-check me-2"></i>Скопіювати
                        </button>
                    </div>
                </div>
            </div>
        </div>`;

        document.body.appendChild(div.firstElementChild);
        const m = new bootstrap.Modal(document.getElementById(modalId));
        m.show();
    }

    function downloadDesignFile() {
        const b = new Blob([JSON.stringify(collectCurrentDesign(), null, 2)], { type: 'application/json' });
        const a = document.createElement('a'); a.href = URL.createObjectURL(b); a.download = `ui_layout.json`; a.click();
    }

    function copyDesignToClipboard(btn) {
        const t = document.getElementById('saveDesignModal').querySelector('textarea'); t.select(); document.execCommand('copy');
        btn.innerText = 'Скопійовано!'; btn.classList.replace('btn-primary', 'btn-success');
    }

    function resetDesign() {
        if (confirm('Скинути всі налаштування?')) {
            localStorage.removeItem('ui_design_config');
            location.reload();
        }
    }

    function applySavedDesign() {
        const saved = localStorage.getItem('ui_design_config'); if (!saved) return;
        try {
            const data = JSON.parse(saved);
            const structure = data.layout || data;
            if (data.config) {
                designConfig = data.config;
                document.documentElement.style.setProperty('--tab-font-size', designConfig.tabFontSize + 'px');
                document.documentElement.style.setProperty('--label-font-size', designConfig.labelFontSize + 'px');
                document.documentElement.style.setProperty('--subsection-font-size', (designConfig.subsectionFontSize || 11) + 'px');
            }

            structure.forEach(tabInfo => {
                let tabBtn = document.querySelector(`[data-bs-target="#${tabInfo.id}"], [href="#${tabInfo.id}"]`);
                let pane = document.getElementById(tabInfo.id);
                if (!tabBtn || !pane) return;
                tabBtn.innerHTML = `<i class="bi bi-collection me-1"></i> ${tabInfo.title}`;
                const card = pane.querySelector('.tab-pane-card');
                if (card) {
                    const subData = tabInfo.subSections || (tabInfo.fields ? [{ title: '', fields: tabInfo.fields }] : []);
                    card.querySelectorAll('h6, .row.g-3').forEach(el => el.remove());

                    subData.forEach(sub => {
                        if (sub.title) {
                            const h6 = document.createElement('h6');
                            h6.className = 'fw-bold text-primary mb-3 text-uppercase small';
                            h6.style.letterSpacing = '1px';
                            h6.innerText = sub.title;
                            card.appendChild(h6);
                        }
                        const row = document.createElement('div');
                        row.className = 'row g-3 mb-4';
                        sub.fields.forEach(f => {
                            // Important fix: find field by ID in the entire document first
                            let fieldEl = document.querySelector(`[data-field-id="${f.id}"]`);

                            if (!fieldEl) {
                                // Only create new if it really doesn't exist
                                fieldEl = document.createElement('div');
                                fieldEl.dataset.fieldId = f.id;
                                fieldEl.innerHTML = getFieldHTML(f.type || 'text', f.label);
                            } else {
                                // If it exists, check if we need to update its type/HTML
                                // But don't overwrite if it's a standard complex select
                                const currentTagType = fieldEl.dataset.fieldType;
                                if (currentTagType && currentTagType !== f.type) {
                                    fieldEl.innerHTML = getFieldHTML(f.type || 'text', f.label);
                                }
                            }

                            fieldEl.dataset.fieldType = f.type || 'text';
                            const label = fieldEl.querySelector('.form-label');
                            if (label) {
                                label.innerText = f.label;
                                if (f.fontFamily) label.style.fontFamily = f.fontFamily;
                            }

                            // Re-apply col class from JSON
                            if (f.col) {
                                const classes = Array.from(fieldEl.classList).filter(c => !c.startsWith('col-'));
                                fieldEl.className = classes.join(' ') + ' ' + f.col;
                            }

                            row.appendChild(fieldEl);
                        });
                        card.appendChild(row);
                    });
                }
            });
        } catch (e) { console.error("Apply Design Error:", e); }
    }

    document.addEventListener('DOMContentLoaded', () => {
        applySavedDesign();
        if (sessionStorage.getItem('reenter_design_mode') === 'true') {
            sessionStorage.removeItem('reenter_design_mode');
            setTimeout(() => { if (!designModeActive) toggleDesignMode(); }, 500);
        }

        // Initialize Bootstrap Popovers
        var popoverTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="popover"]'))
        var popoverList = popoverTriggerList.map(function (popoverTriggerEl) {
            return new bootstrap.Popover(popoverTriggerEl)
        });
    });
</script>

</html>